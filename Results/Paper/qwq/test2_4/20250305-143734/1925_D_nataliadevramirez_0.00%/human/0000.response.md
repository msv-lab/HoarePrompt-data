Alright, I have this problem to solve. Let's see what it's asking for. There are n children in a class, and m pairs among them are friends with a friendship value f_i. The teacher goes on k excursions, and for each excursion, she chooses a pair of children randomly and equiprobably. If the chosen pair are friends, their friendship value increases by 1 for all subsequent excursions. Pairs who are not friends have a friendship value of 0 that doesn't change.

I need to find the expected value of the sum of friendship values of all k pairs chosen for the excursions, considering that the friendship values can increase over time based on the selections.

First, I need to understand the setup. There are n children, and some of them are friends with a certain friendship value. The teacher chooses k pairs randomly, and if a chosen pair are friends, their friendship value increases by 1 for all future excursions.

Let me think about how to approach this. Since the friendship values can change over time based on the selections, this seems like a dynamic process where the choices in earlier excursions can affect the friendship values in later excursions.

But calculating the exact expected sum directly might be complicated due to the dependencies between the excursions. Maybe there's a smarter way to model this.

Let me consider the total number of possible pairs. Since the pairs are chosen equiprobably, I need to consider the probability of selecting each pair in each excursion.

The total number of possible pairs is C(n, 2) = n*(n-1)/2.

Given that m pairs are friends with initial friendship values f_i, and the rest are not friends with friendship value 0.

Now, for each excursion, a pair is chosen randomly. If the pair is a friend pair, their friendship value increases by 1 for all subsequent excursions.

I need to find the expected sum of the friendship values at the time of being chosen for all k excursions.

Let me think about the contribution of each friend pair to the total expected sum.

Consider a single friend pair (a, b) with initial friendship value f.

In each excursion, the probability of selecting this pair is 2 / (n*(n-1)), since there are C(n, 2) = n(n-1)/2 pairs, and each pair is equiprobable.

Wait, actually, C(n, 2) = n*(n-1)/2, so the probability of selecting any specific pair is 1 / C(n, 2) = 2 / (n*(n-1)).

But actually, no. The probability of selecting any specific pair is 1 / C(n, 2) = 2 / (n*(n-1)).

Wait, no. C(n, 2) = n*(n-1)/2, so 1 / C(n, 2) = 2 / (n*(n-1)).

But I need to be careful here. Let's denote total_pairs = C(n, 2) = n*(n-1)/2.

So, probability of selecting any specific pair in one excursion is p = 1 / total_pairs.

Now, for a friend pair (a, b) with initial friendship value f, their contribution to the expected sum is:

- In the excursion when they are selected, their friendship value at that time is f plus the number of times they have been selected in previous excursions.

But this seems tricky because the number of times they have been selected in previous excursions is a random variable.

Maybe I need to think in terms of linearity of expectation.

Let me consider each excursion independently and calculate the expected contribution of each friend pair to the sum in that excursion.

Then, by linearity of expectation, the total expected sum is the sum over all excursions of the expected contribution in that excursion.

Wait, but the friendship values can increase over time, so the expected contribution in later excursions depends on previous selections.

Is there a way to decouple this dependency?

Wait, perhaps I can think of the process as follows:

- For each friend pair, track how many times they are selected in the k excursions.

- Each time they are selected, their friendship value increases by 1 for all subsequent excursions.

- So, if a friend pair is selected t times, their friendship value increases by t for all excursions after those t selections.

- But this seems complicated to model directly.

Let me try to think differently.

Let me consider the expected friendship value of a specific friend pair (a, b) in a specific excursion.

Suppose I fix a friend pair (a, b) and an excursion i (from 1 to k).

I want to find the expected friendship value of (a, b) at the time of excursion i.

Then, the total expected sum is the sum over all excursions of these expected friendship values.

But this still seems messy because the friendship value depends on how many times (a, b) have been selected in previous excursions.

Wait, perhaps I can think in terms of the number of times the pair has been selected up to a certain excursion.

Let me try to model this more carefully.

Let's denote X_i as the friendship value of a specific friend pair (a, b) at the time of the i-th excursion.

I need to find E[X_1 + X_2 + ... + X_k].

By linearity of expectation, this is equal to sum_{i=1 to k} E[X_i].

Now, X_i depends on how many times the pair (a, b) has been selected in the previous excursions.

Specifically, X_i = f + number of times (a, b) has been selected in the first i-1 excursions.

Because each time (a, b) is selected, f increases by 1 for all subsequent excursions.

Wait, more precisely:

- Initially, f = f_i.

- Each time (a, b) is selected in an excursion, f increases by 1 for all subsequent excursions.

So, if (a, b) is selected t times in the first i-1 excursions, then X_i = f_i + t.

Therefore, E[X_i] = f_i + E[t], where t is the number of times (a, b) is selected in the first i-1 excursions.

But computing E[t] depends on the probability of selecting (a, b) in each excursion.

Given that selections are independent and equiprobable, the probability of selecting (a, b) in any single excursion is p = 1 / total_pairs.

Therefore, the expected number of times (a, b) is selected in the first i-1 excursions is (i-1)*p.

Therefore, E[X_i] = f_i + (i-1)*p.

Therefore, the total expected sum for a specific friend pair (a, b) is sum_{i=1 to k} E[X_i] = sum_{i=1 to k} (f_i + (i-1)*p) = k*f_i + p*sum_{i=1 to k} (i-1) = k*f_i + p*(k*(k-1)/2).

But wait, sum_{i=1 to k} (i-1) = sum_{j=0 to k-1} j = (k-1)*k/2.

Yes.

So, total expected sum for one friend pair is k*f_i + p*(k*(k-1)/2).

But this seems off because p is the probability of selecting that pair in one excursion, which is 1 / total_pairs.

So, total expected sum for one friend pair is k*f_i + (k*(k-1)/2) / total_pairs.

But I need to verify this.

Wait, no.

E[t] = sum_{j=1 to i-1} p, for each i from 1 to k.

So, sum_{i=1 to k} E[t] for a specific friend pair is sum_{i=1 to k} (i-1)*p = (k*(k-1)/2)*p.

And sum_{i=1 to k} f_i is k*f_i.

Therefore, total expected sum for one friend pair is k*f_i + (k*(k-1)/2)*p.

But p = 1 / total_pairs.

Total_pairs = C(n, 2) = n*(n-1)/2.

Therefore, p = 2 / (n*(n-1)).

Therefore, total expected sum for one friend pair is k*f_i + (k*(k-1)/2)*(2/(n*(n-1))) = k*f_i + (k*(k-1))/(n*(n-1)).

Wait, but this seems too simplistic. Let me check with the sample input.

Take the second test case:

n=2, m=1, k=10

friendship: (1,2), f=1

total_pairs = C(2,2) = 1

p = 1 / 1 = 1

So, total expected sum = 10*1 + (10*9/2)*1 = 10 + 45 = 55, which matches the sample output.

Okay, this seems correct.

So, generalizing, for each friend pair (a,b) with f_i, the expected sum is k*f_i + (k*(k-1)/2) / total_pairs.

Wait, in the above calculation, p = 1 / total_pairs, so (k*(k-1)/2)*p = (k*(k-1)/2)/total_pairs.

But in the second test case, total_pairs = 1, so it's k*f_i + (k*(k-1)/2)/1 = k*f_i + k*(k-1)/2, which is 10*1 + 10*9/2 = 10 + 45 = 55.

Yes.

Similarly, in the first test case, n=100, m=0, k=24

Since m=0, there are no friend pairs, so sum is 0, which matches the sample output.

In the third test case, n=3, m=1, k=2

friendship: (2,1), f=1

total_pairs = C(3,2) = 3

p = 1/3

expected sum per friend pair = 2*1 + (2*1/2)*(1/3) = 2 + (1)*(1/3) = 2 + 1/3 = 7/3

But the sample output is 777777784, which is 7/3 modulo 1e9+7.

Yes, that seems correct.

Similarly, for the fourth test case, n=5, m=2, k=4

friendships: (1,2), f=25 and (3,2), f=24

total_pairs = C(5,2) = 10

p = 1/10 for each friend pair.

Total expected sum = sum over friend pairs of [k*f_i + (k*(k-1)/2)*p]

For (1,2): 4*25 + (4*3/2)*(1/10) = 100 + (6)*(1/10) = 100 + 0.6 = 100.6

For (3,2): 4*24 + (4*3/2)*(1/10) = 96 + 0.6 = 96.6

Total: 100.6 + 96.6 = 197.2

But the sample output is 40000020, which is likely 197.2 modulo 1e9+7, but that doesn't make sense because 197.2 isn't an integer.

Wait, perhaps I need to consider that f_i is increased by 1 for all subsequent excursions after being selected.

But in my earlier calculation, I assumed that the increase is added to f_i for all subsequent selections, but perhaps I need to account for the fact that f_i increases only after being selected.

Wait, maybe my earlier approach is incorrect.

Let me think again.

Let me consider that for each friend pair, their contribution to the total sum is equal to their f_i multiplied by the expected number of times they are chosen, plus the expected number of times they are chosen in previous excursions for each subsequent excursion.

This seems too convoluted.

Perhaps a better way is to consider that for each friend pair, their contribution to the total sum is equal to their f_i multiplied by the expected number of times they are chosen, plus the expected number of times they are chosen before each time they are chosen again.

Wait, maybe I need to model this as a geometric series.

Alternatively, perhaps I can think of the problem as follows:

- For each friend pair, their friendship value starts at f_i and increases by 1 each time they are chosen.

- So, if they are chosen t times, their friendship value at the time of the last selection is f_i + t.

- But I need to sum their friendship values at the time of each selection.

- So, if they are chosen at excursions j1, j2, ..., jt, then their total contribution to the sum is f_i + (f_i +1) + (f_i +2) + ... + (f_i + (t-1)) = t*f_i + (t*(t-1)/2).

- But since t is random, I need to take expectation over t.

But this seems complicated.

Wait, perhaps I need to think differently.

Let me consider that for each excursion, the expected contribution to the sum is equal to the sum over all friend pairs of their probability of being chosen multiplied by their expected friendship value at the time of being chosen.

Wait, but this still seems involved.

Alternatively, perhaps I can consider that the expected sum is equal to the sum over all excursions of the expected friendship value of the chosen pair.

And since the choices are independent, I can compute this as k times the expected friendship value of a single randomly chosen pair.

But this seems too simplistic because the friendship values can increase over time.

Wait, but actually, because the friendship values can increase over time based on previous selections, this approach doesn't account for the dynamic nature of the friendship values.

I need a better way.

Let me consider the following approach:

- Model the process as a Markov chain, where the state is the current friendship values of all friend pairs.

- However, with n up to 1e5 and m up to 1e5, this is computationally infeasible.

So, that's not a viable approach.

Let me try to find a closed-form formula.

From the earlier test case analysis, it seems that for each friend pair, their expected contribution is k*f_i + (k*(k-1)/2)/total_pairs.

But in the fourth test case, with n=5, m=2, k=4, total_pairs=10, f1=25, f2=24.

Expected sum = 4*25 + 4*24 + (4*3/2)/10 * 2 = 100 + 96 + (6/10)*2 = 196 + 1.2 = 197.2

But the sample output is 40000020, which is likely (197 * 200000004) mod (1e9+7), but that doesn't make sense.

Wait, perhaps I need to consider that the friendship values increase by 1 for all subsequent excursions, not just for future selections.

Wait, let's think carefully.

Suppose a friend pair is selected in excursion j. Then, their friendship value increases by 1 for all excursions j+1 to k.

So, in excursion j, their friendship value is f_i plus the number of times they have been selected in excursions 1 to j-1.

Wait, more precisely:

- Let t_j be an indicator variable that is 1 if the pair is selected in excursion j, else 0.

- Then, the friendship value at the time of excursion j is f_i plus sum_{l=1 to j-1} t_l.

- Therefore, the total sum is sum_{j=1 to k} (f_i + sum_{l=1 to j-1} t_l).

- This can be rewritten as sum_{j=1 to k} f_i + sum_{j=1 to k} sum_{l=1 to j-1} t_l.

- Which is k*f_i + sum_{l=1 to k-1} (k - l)*t_l.

But this still seems complicated.

Alternatively, perhaps I can think in terms of the number of times the pair is selected.

Let me denote T as the number of times the pair is selected in k excursions.

Then, T follows a binomial distribution with parameters k and p = 1 / total_pairs.

Given T = t, the sum of their friendship values over all k excursions is sum_{j=1 to k} (f_i + number of times selected in excursions 1 to j-1).

Which is k*f_i + sum_{j=1 to k} (number of times selected in excursions 1 to j-1).

Which is k*f_i + sum_{j=1 to k} sum_{l=1 to j-1} t_l.

Which is k*f_i + sum_{l=1 to k-1} (k - l)*t_l.

Now, taking expectation over T, since T is binomial(k, p), perhaps I can compute this expectation.

But this seems too involved.

Let me consider a different approach.

Let me consider that for each friend pair, their expected contribution to the total sum is:

- Their f_i multiplied by the expected number of times they are chosen.

- Plus, the expected sum of the number of times they are chosen before each time they are chosen, which contributes to the increase in their friendship value.

Wait, perhaps it's better to think in terms of the linearity of expectation for the total sum.

Let me consider that the total sum S is the sum over all k excursions of the friendship value of the pair chosen in that excursion.

S = sum_{j=1 to k} f_j(chosen_pair)

Where f_j(chosen_pair) is the friendship value at the time of excursion j.

Now, I can think of E[S] = sum_{j=1 to k} E[f_j(chosen_pair)]

Now, E[f_j(chosen_pair)] can be computed as the expectation over the choice of the pair in excursion j, considering the increases in friendship values based on previous selections.

This still seems complicated.

Wait, perhaps I can consider that for each friend pair, their contribution to E[S] is equal to their probability of being chosen in each excursion multiplied by their expected friendship value at the time of being chosen.

But again, this seems too involved.

Let me try to think about the sample input again.

In the second test case, n=2, m=1, k=10, friendship pair (1,2) with f=1.

Total pairs = 1.

So, in each excursion, the same pair is always chosen.

Therefore, their friendship value increases by 1 each time they are chosen.

So, in excursion 1: f=1

excursion 2: f=2

...

excursion 10: f=10

Sum = 1+2+...+10 = 55

Which matches the sample output.

Similarly, in the third test case, n=3, m=1, k=2, friendship pair (2,1) with f=1.

Total pairs = 3.

Probability of selecting the friend pair in each excursion is 1/3.

Expected sum = sum over excursions of E[f_j]

For excursion 1: E[f_j] = (1/3)*1 + (2/3)*0 = 1/3

For excursion 2: E[f_j] = (1/3)*(1 + number of times selected in excursion 1) + (2/3)*0

Wait, more carefully:

In excursion 1:

- Probability 1/3: select the friend pair, f=1

- Probability 2/3: select non-friend pair, f=0

In excursion 2:

- If selected in excursion 1: f=1 + 1 = 2

- If not selected in excursion 1: f=1

So, E[f2] = (1/3)*(2) + (2/3)*(1) = 2/3 + 2/3 = 4/3

Total expected sum = E[f1] + E[f2] = 1/3 + 4/3 = 5/3 â‰ˆ 1.666...

But the sample output is 777777784, which is 7/3 modulo 1e9+7.

Wait, perhaps I miscounted.

Wait, in the third test case, n=3, m=1, k=2, friendship pair (2,1), f=1.

Total pairs = 3.

For excursion 1:

- Probability 1/3: select the friend pair, f=1

- Probability 2/3: select non-friend pair, f=0

For excursion 2:

- If selected in excursion 1 (probability 1/3), then f=1 +1=2

- If not selected in excursion 1 (probability 2/3), then f=1

So, E[f2] = (1/3)*2 + (2/3)*1 = 2/3 + 2/3 = 4/3

Total expected sum E[S] = E[f1] + E[f2] = (1/3) + (4/3) = 5/3

But the sample output is 777777784, which is 7/3 modulo 1e9+7.

This suggests that my calculation is incorrect.

Wait, perhaps I missed something.

Wait, in the third test case, n=3, m=1, k=2, friendship pair (2,1), f=1.

But according to the sample output, it's 777777784, which is 7/3 modulo 1e9+7.

But according to my calculation, it should be 5/3.

Wait, maybe I need to consider that in excursion 2, the friendship value is f + number of times selected in previous excursions.

Wait, in excursion 1:

- Select friend pair with probability 1/3, f=1

- Select non-friend pair with probability 2/3, f=0

In excursion 2:

- If selected in excursion 1, f=1 +1=2

- If not selected in excursion 1, f=1

So, E[f2] = (1/3)*2 + (2/3)*1 = 4/3

Total E[S] = E[f1] + E[f2] = (1/3) + (4/3) = 5/3

But sample output is 7/3.

This suggests that my approach is missing something.

Wait, perhaps I need to consider that in excursion 1, the friendship value is f=1, and if selected, it increases to f=2 for excursion 2.

But in my earlier calculation, I had E[f2] = (1/3)*2 + (2/3)*1 = 4/3, and E[f1]=1/3, total 5/3.

But sample output is 7/3.

Hmm.

Wait, perhaps I need to consider that the friendship value at the time of selection includes the increases from previous selections.

Wait, maybe I need to model it differently.

Let me consider that for each friend pair, their friendship value at the time of selection is f_i plus the number of times they have been selected in previous excursions.

So, if a friend pair is selected t times in the first i-1 excursions, their friendship value at excursion i is f_i + t.

Therefore, the total sum S = sum_{i=1 to k} (f_i + t_i), where t_i is the number of times the pair has been selected in the first i-1 excursions.

But this seems too vague.

Alternatively, perhaps I can think in terms of the number of times each friend pair is selected overall.

Let me denote T as the number of times a specific friend pair is selected in k excursions.

T follows a binomial distribution with parameters k and p = 1 / total_pairs.

Then, the sum of their friendship values over all k excursions is sum_{j=1 to k} (f_i + number of times selected in excursions 1 to j-1).

Which is k*f_i + sum_{j=1 to k} sum_{l=1 to j-1} t_l.

Which is k*f_i + sum_{l=1 to k-1} (k - l)*t_l.

Now, taking expectation over T, since T is binomial(k, p), we have E[T] = k*p and Var[T] = k*p*(1-p).

But this still seems complicated to compute directly.

Wait, perhaps I can find a closed-form formula for the expected sum for one friend pair and then multiply by m.

But I need to make sure that the friend pairs are independent, which they are not because the selections are mutually exclusive (selecting one pair prevents selecting another in the same excursion).

Wait, no, actually, selections are independent because the teacher chooses pairs independently in each excursion.

Wait, but in each excursion, only one pair is chosen.

So, the selections are not mutually exclusive; rather, they are independent events with replacement.

Wait, no, actually, the problem says "the teacher chooses a pair of children randomly, equiprobably and independently."

So, the selections are independent, and the same pair can be chosen multiple times.

Therefore, the number of times a specific friend pair is selected follows a binomial distribution with parameters k and p = 1 / total_pairs.

Given that, perhaps I can find a formula for the expected sum for one friend pair and then sum over all friend pairs.

Let me try to derive that.

For a specific friend pair with initial f_i:

Let T be the number of times they are selected in k excursions.

Then, T ~ Binomial(k, p = 1 / total_pairs)

Then, the sum of their friendship values over k excursions is sum_{j=1 to k} (f_i + number of times selected in excursions 1 to j-1)

Which is k*f_i + sum_{j=1 to k} sum_{l=1 to j-1} t_l

Which is k*f_i + sum_{l=1 to k-1} (k - l)*t_l

Now, taking expectation:

E[sum] = k*f_i + sum_{l=1 to k-1} (k - l)*E[t_l]

But since T is binomial, E[t_l] = p for each l.

Wait, no, T is the total number of times selected, but t_l is an indicator variable for being selected in excursion l.

Wait, perhaps I need to think differently.

Let me denote t_j as an indicator variable that is 1 if the pair is selected in excursion j, else 0.

Then, sum_{j=1 to k} f_j = sum_{j=1 to k} (f_i + sum_{l=1 to j-1} t_l) = k*f_i + sum_{j=1 to k} sum_{l=1 to j-1} t_l

Which is k*f_i + sum_{l=1 to k-1} (k - l)*t_l

Now, taking expectation:

E[sum] = k*f_i + sum_{l=1 to k-1} (k - l)*E[t_l]

Since E[t_l] = p for each l, where p = 1 / total_pairs

Therefore, E[sum] = k*f_i + p * sum_{l=1 to k-1} (k - l)

Now, sum_{l=1 to k-1} (k - l) = sum_{m=1 to k-1} m = k*(k-1)/2

Therefore, E[sum] = k*f_i + (k*(k-1)/2) * p

Now, p = 1 / total_pairs = 2 / (n*(n-1))

Therefore, E[sum] = k*f_i + (k*(k-1)/2) * (2 / (n*(n-1))) = k*f_i + (k*(k-1)) / (n*(n-1))

Now, for all m friend pairs, the total expected sum is sum over all friend pairs of E[sum]

Which is sum_{i=1 to m} [k*f_i + (k*(k-1)) / (n*(n-1))] = m*(k*(k-1))/(n*(n-1)) + k*sum_{i=1 to m} f_i

Wait, no, the term (k*(k-1))/(n*(n-1)) is independent of the friend pair, but it should be multiplied by m.

Wait, no, each friend pair contributes (k*(k-1))/(n*(n-1)) to the expected sum.

Therefore, the total expected sum is sum_{i=1 to m} [k*f_i + (k*(k-1))/(n*(n-1))]

Which is m*(k*(k-1))/(n*(n-1)) + k*sum_{i=1 to m} f_i

But in the second test case, n=2, m=1, k=10, f=1

Total expected sum = 1*(10*9/2)/(2*1) + 10*1 = (45)/2 + 10 = 22.5 + 10 = 32.5

But the sample output is 55.

Wait, this contradicts my earlier calculation.

Wait, perhaps I messed up the formula.

Wait, in the second test case, total_pairs = C(2,2)=1

So, p = 1 / 1 = 1

Therefore, E[sum] = 10*1 + (10*9/2)*1 = 10 + 45 = 55, which matches the sample.

But according to my general formula, E[sum] = k*f_i + (k*(k-1))/(n*(n-1))

Which in this case is 10*1 + (10*9)/(2*1) = 10 + 45 = 55.

Wait, but earlier I thought that the total expected sum for all friend pairs is sum over friend pairs of [k*f_i + (k*(k-1))/(n*(n-1))]

In the second test case, m=1, so it's 10*1 + 45 = 55, which matches.

In the third test case, m=1, n=3, k=2, f=1

total_pairs = C(3,2)=3

E[sum] = 2*1 + (2*1)/(3*2) = 2 + 2/6 = 2 + 1/3 = 7/3, which matches the sample output of 777777784 (since 7/3 mod 1e9+7 is 7*333333336 mod 1e9+7 = 2333333352 mod 1e9+7 = 777777784).

Wait, earlier I thought it was 5/3, but actually, according to the formula, it's 2*1 + (2*1)/(3*2) = 2 + 1/3 = 7/3.

So, the general formula seems correct.

Therefore, the total expected sum is sum over all friend pairs of [k*f_i + (k*(k-1))/(n*(n-1))]

Which is m*(k*(k-1))/(n*(n-1)) + k*sum_{i=1 to m} f_i

But in the fourth test case, n=5, m=2, k=4, f1=25, f2=24

total_pairs = C(5,2)=10

E[sum] = 2*(4*3)/(5*4) + 4*(25 + 24) = 2*(12)/20 + 4*49 = 12/10 + 196 = 1.2 + 196 = 197.2

But the sample output is 40000020, which is likely 197 modulo 1e9+7, but 197.2 is not an integer.

Wait, perhaps I need to consider that the formula should be m*(k*(k-1))/(n*(n-1)) + k*sum_{i=1 to m} f_i

But in the fourth test case, m=2, k=4, sum f_i=25+24=49

So, E[sum] = 2*(4*3)/(5*4) + 4*49 = 2*(12)/20 + 196 = 2*(0.6) + 196 = 1.2 + 196 = 197.2

But the sample output is 40000020, which is likely 197.2 modulo 1e9+7, but 197.2 isn't an integer.

Wait, perhaps I need to represent it as a fraction.

Let me calculate m*(k*(k-1))/(n*(n-1)) + k*sum_{i=1 to m} f_i

= 2*(4*3)/(5*4) + 4*(25 + 24) = 2*(12)/20 + 4*49 = 24/20 + 196 = 