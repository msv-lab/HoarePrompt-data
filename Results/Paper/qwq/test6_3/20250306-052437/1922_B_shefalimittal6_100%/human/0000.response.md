Alright, I have this problem to solve. Let's see what it's asking for. So, I have n sticks, each with a length of 2 raised to the power of a_i, where a_i is given for each stick. I need to choose exactly 3 sticks and form a non-degenerate triangle with them. A non-degenerate triangle means that the area is greater than 0, which implies that the sum of any two sides must be greater than the third side. Essentially, I need to count the number of triplets (a, b, c) such that a + b > c, a + c > b, and b + c > a, where a, b, and c are the lengths of the sticks.

First, I need to understand the properties of the lengths. Since the lengths are of the form 2^{a_i}, and exponents a_i can range from 0 to n, I should consider the properties of powers of 2. Powers of 2 are distinct and double each time, so 2^0 = 1, 2^1 = 2, 2^2 = 4, and so on.

Given that, I need to find triplets where the sum of any two is greater than the third. Given the properties of powers of 2, it's interesting to see how these lengths interact.

Let me think about the triangle inequality. For three lengths to form a triangle, the sum of the two smaller lengths must be greater than the largest length.

Given that the lengths are powers of 2, which are strictly increasing, if I have three lengths 2^a, 2^b, and 2^c, where a < b < c, then 2^a + 2^b > 2^c must hold for them to form a triangle.

But wait, 2^a + 2^b is equal to 2^a (1 + 2^{b-a})). In comparison to 2^c, for 2^a + 2^b > 2^c to hold, given that a < b < c, it's unlikely because 2^c is significantly larger than 2^b, which is already larger than 2^a.

Wait, actually, 2^a + 2^b = 2^a (1 + 2^{b-a}). If b = a + 1, then it's 2^a (1 + 2) = 3 * 2^a, which is still less than 2^{a+2}, for example. So, in general, the sum of two smaller powers of 2 is less than the next higher power of 2.

Wait, is that always true? Let me check with some examples.

Take a = 1, b = 2, c = 3.

So, 2^1 + 2^2 = 2 + 4 = 6, which is greater than 2^3 = 8? No, 6 < 8. So, this doesn't satisfy the triangle inequality.

Another example: a = 2, b = 3, c = 4.

2^2 + 2^3 = 4 + 8 = 12, which is greater than 2^4 = 16? 12 < 16. Still not satisfying.

Wait, when would 2^a + 2^b > 2^c when a < b < c?

Maybe if a and b are close enough to c.

Wait, perhaps if a and b are both quite close to c.

Let me try a = 3, b = 3, c = 4.

Wait, but in the problem, a_i can be repeated, but the sticks are numbered uniquely.

Wait, the sticks have lengths 2^{a_i}, and a_i can be repeated.

So, multiple sticks can have the same length if a_i is the same for them.

So, in terms of choosing sticks, if multiple sticks have the same a_i, they have the same length.

So, in counting the number of ways, I need to consider the multiplicity of sticks with the same length.

But, in the earlier examples, it seems like it's hard to satisfy the triangle inequality with powers of 2, because the sum of two smaller ones is usually less than the next higher one.

But perhaps there are cases where it does work.

Wait, maybe if I have multiple sticks of the same length, that could allow for some combinations.

Let me think about the example where n=7 and a_i=1 for all i.

So, all sticks have length 2^1 = 2.

So, any three sticks will have lengths 2, 2, 2, and 2 + 2 > 2, so they can form a triangle.

Similarly, 2 + 2 > 2, and so on.

So, in this case, the number of ways is C(7,3) = 35.

Okay, that's straightforward.

Another example: n=4, a=[3,2,1,3].

So, lengths are 2^3=8, 2^2=4, 2^1=2, and 2^3=8.

So, lengths are [8,4,2,8].

Possible triplets:

- 8,4,2: 4 + 2 = 6 < 8 → cannot form a triangle.

- 8,8,4: 8 + 4 = 12 > 8, 8 + 8 = 16 > 4 → can form a triangle.

- 8,8,2: 8 + 2 = 10 > 8, 8 + 8 = 16 > 2 → can form a triangle.

So, there are two valid triplets in this case.

Wait, but according to the sample output, it's only 2, but in my analysis, I see two valid triplets.

Wait, but perhaps I'm missing something.

Wait, 8,8,4 is one, and 8,8,2 is another.

So, yes, two triplets.

Another example: n=3, a=[1,2,3], lengths [2,4,8].

As before, only one triplet possible: 2,4,8, which doesn't satisfy the triangle inequality.

Hence, 0.

And n=1, a=[1], only one stick, can't form any triangle, hence 0.

So, the problem is to count the number of triplets (i,j,k), where i < j < k, and the lengths 2^{a_i}, 2^{a_j}, 2^{a_k} satisfy the triangle inequalities.

Given that, I need an efficient way to compute this, considering that n can be up to 3*10^5, and t up to 10^4, with the sum of n over all test cases up to 3*10^5.

So, I need an O(n log n) per test case solution, or something similar.

First, I need to group the sticks by their lengths, since multiple sticks can have the same length.

Given that a_i can be up to n, and n can be up to 3*10^5, I can have exponents up to 3*10^5, which means lengths up to 2^{3*10^5}, but since I'm dealing with powers of 2, I can represent lengths by their exponents.

So, I can count the frequency of each a_i, since sticks with the same a_i have the same length.

Let me sort the a_i's and count the frequency of each unique a_i.

Then, for each unique a_i, I can have v[a_i] sticks of length 2^{a_i}.

Now, to form a triangle, I need to choose three sticks such that the sum of the two smaller ones is greater than the largest one.

Given that lengths are powers of 2, which are strictly increasing, I can consider the exponents.

Let me denote the exponents as e1, e2, e3, with e1 <= e2 <= e3.

Then, the condition for forming a triangle is 2^{e1} + 2^{e2} > 2^{e3}.

Given that 2^{e1} + 2^{e2} <= 2*2^{e2} = 2^{e2+1}.

So, for 2^{e1} + 2^{e2} > 2^{e3}, it must be that 2^{e2+1} > 2^{e3}, which implies e2 + 1 > e3, or e3 < e2 + 1.

But e3 >= e2, since e1 <= e2 <= e3.

So, the only way this can happen is if e3 = e2, because if e3 >= e2 + 1, then 2^{e2} + 2^{e2} = 2^{e2+1} = 2^{e3}, which is not greater than 2^{e3}.

Wait, but 2^{e2} + 2^{e2} = 2^{e2+1}, which is equal to 2^{e3} if e3 = e2 + 1, but equal to 2^{e3}, which is not greater.

If e3 > e2 + 1, then 2^{e2} + 2^{e2} = 2^{e2+1} < 2^{e3}, so the triangle inequality fails.

If e3 = e2, then 2^{e2} + 2^{e1} > 2^{e2}, which simplifies to 2^{e1} > 0, which is always true since 2^{e1} >=1.

Wait, 2^{e1} >=1, so yes, 2^{e2} + 2^{e1} > 2^{e2} holds.

Similarly, 2^{e2} + 2^{e2} > 2^{e1}, which is also true.

So, in this case, when e3 = e2, the triangle inequality holds.

Moreover, if e3 = e2, and e1 <= e2, then as long as e1 <= e2, the inequalities hold.

Wait, but in this case, e3 = e2, so e1 can be less than or equal to e2.

So, for e3 = e2, any e1 <= e2 will satisfy the triangle inequality.

Similarly, for e3 = e2, e1 can be less than or equal to e2.

Wait, but e1 <= e2 <= e3, and e3 = e2.

So, e1 <= e2 = e3.

So, for e3 = e2, any e1 <= e2 will work.

Wait, but in terms of choosing sticks, I need to consider the frequencies.

Let me think in terms of frequencies.

Suppose I have frequencies v[e], for each exponent e, representing the number of sticks with length 2^e.

I need to consider all possible triplets (e1, e2, e3), with e1 <= e2 <= e3, and count the number of ways to choose sticks such that e3 <= e2 + something.

Wait, from earlier, it seems that the only way to satisfy the triangle inequality is when e3 < e2 + 1, which would mean e3 <= e2.

But e3 >= e2, so e3 = e2.

Hence, the only way to satisfy the triangle inequality is when e3 = e2.

If e3 > e2, then 2^{e2} + 2^{e1} <= 2^{e2} + 2^{e2} = 2^{e2+1}, which is only greater than 2^{e3} if e3 < e2 + 1, which is not possible since e3 >= e2.

Hence, the only possibility is e3 = e2.

Therefore, the only way to form a triangle is when e3 = e2.

In other words, when the three sticks have lengths 2^{e1}, 2^{e2}, and 2^{e3}, with e1 <= e2 = e3.

So, e3 = e2, and e1 <= e2.

Therefore, in terms of frequencies, for each e, if v[e] >= 2, I can choose two sticks with e and one stick with any e1 <= e.

But, I need to choose exactly three sticks, so I need to consider the combinations.

Let me try to formalize this.

For each e, if v[e] >= 2, I can choose two sticks from the v[e] sticks, and pair them with any stick having e1 <= e.

But, since I'm choosing three sticks, and e3 = e2 = e, and e1 <= e, I need to choose e1 <= e, and e2 = e3 = e.

So, the number of ways for a particular e is C(v[e], 2) * (number of sticks with e1 <= e).

But, since e1 can be from any exponent less than or equal to e, I need the cumulative sum of v[0 to e].

Wait, but I need to be careful not to double-count.

Wait, perhaps it's better to iterate over e in increasing order and keep a running total of the number of sticks encountered so far.

Wait, perhaps.

Let me try to think differently.

Let me sort the exponents in increasing order.

Then, for each pair of sticks with exponents e2 and e3, where e2 <= e3, I need to find the number of sticks with exponents e1 <= e2 such that e1 <= e2 and e3 = e2.

Wait, since e3 = e2 for the triangle to be formed, I need e3 = e2.

So, for each e, where v[e] >= 2, I can choose two sticks from v[e], and pair them with any stick having e1 <= e.

So, I need to keep a prefix sum of the number of sticks up to e.

Let me denote prefix[e] as the total number of sticks with exponents <= e.

Then, for each e where v[e] >= 2, the number of ways is C(v[e], 2) * prefix[e].

But, this counts the case where all three sticks have e1 = e2 = e3 = e, which is counted in C(v[e], 2) * v[e], but we need to choose exactly three sticks, so we need to use C(v[e], 3).

Wait, perhaps I need to subtract the cases where all three sticks have e = e2 = e3.

Wait, let's think carefully.

For each e where v[e] >= 2, the number of ways to choose two sticks from v[e] is C(v[e], 2).

Then, for each such pair, I can choose a third stick with e1 <= e.

But, this includes the cases where the third stick also has e1 = e, which is C(v[e], 3).

So, the total for each e is C(v[e], 2) * prefix[e] - C(v[e], 3).

Wait, but C(v[e], 2) * prefix[e] counts the number of ways to choose two sticks from v[e] and one stick from prefix[e].

But, C(v[e], 3) is included in this, so to exclude the overcounting, I need to subtract C(v[e], 3).

Wait, actually, C(v[e], 2) * prefix[e] includes C(v[e], 3) times, because when e1 = e2 = e3 = e, it's counted in C(v[e], 2) * v[e], but C(v[e], 3) is the number of ways to choose all three sticks from v[e].

So, to correct for this, I need to subtract C(v[e], 3).

Hence, for each e, the number of ways is C(v[e], 2) * prefix[e] - C(v[e], 3).

Then, sum over all e where v[e] >= 2.

Wait, but is this the complete count?

Wait, perhaps there is a better way.

Let me consider that the only way to form a triangle is when e3 = e2.

So, for each e, if v[e] >= 2, I can choose two sticks from v[e], and pair them with any stick having e1 <= e.

But, in this case, the number of ways is C(v[e], 2) * prefix[e], where prefix[e] is the total number of sticks with exponents <= e.

However, this counts the cases where all three sticks have e = e2 = e3, which is C(v[e], 3), so I need to subtract that to avoid overcounting.

Hence, for each e, the number of ways is C(v[e], 2) * prefix[e] - C(v[e], 3).

Then, sum over all e where v[e] >= 2.

Wait, but in the first test case, where all a_i = 1, so e = 1, v[1] = 7.

Then, C(7, 2) * prefix[1] - C(7, 3) = 21 * 7 - 35 = 147 - 35 = 112, which is not equal to 35.

Wait, that doesn't make sense.

Wait, perhaps I'm missing something.

Wait, in the first test case, all sticks have e = 1, so prefix[1] = 7.

Then, C(7, 2) = 21, C(7, 3) = 35.

Then, 21 * 7 - 35 = 147 - 35 = 112, which is not equal to 35.

So, my formula is incorrect.

Wait, perhaps I need to think differently.

Let me consider that for e3 = e2 = e, the number of ways is C(v[e], 2) * (prefix[e] - v[e]) + C(v[e], 3).

Wait, C(v[e], 2) * (prefix[e] - v[e]) counts the number of ways to choose two sticks from v[e] and one stick from prefix[e] excluding the v[e] sticks, which is not correct.

Wait, perhaps I need to think in terms of choosing two sticks from v[e] and one stick from prefix[e], but subtract the cases where all three are from v[e].

Wait, but in the first test case, all sticks have e=1, so prefix[1]=7, v[1]=7.

Then, C(7,2)*7 - C(7,3) = 21*7 - 35 = 147 - 35 = 112, which is not equal to 35.

So, clearly, my approach is flawed.

Let me try to think differently.

Let me consider that for any three sticks with e1 <= e2 <= e3, and e3 = e2, the triangle can be formed.

So, for each e, if v[e] >= 2, I can choose two sticks from v[e] and pair them with any stick having e1 <= e.

But, in this case, the number of ways is C(v[e], 2) * prefix[e], where prefix[e] is the cumulative sum up to e.

But, this includes the cases where e1 = e2 = e3 = e, which is C(v[e], 3).

So, the total should be sum over e where v[e] >= 2 of C(v[e], 2) * (prefix[e] - v[e] + C(v[e], 1)).

Wait, I'm getting confused.

Let me try to think in terms of combinations.

For each e, if v[e] >= 2, I can choose two sticks from v[e], and pair them with any stick except those with e1 > e.

But, since e3 = e2 = e, e1 can be from 0 to e.

Wait, but in my earlier approach, prefix[e] includes all sticks with exponents <= e.

So, the number of ways should be C(v[e], 2) * prefix[e].

But, in the first test case, C(7,2)*7 = 21*7=147, and C(7,3)=35.

But, 147 - 35 = 112, which is not equal to 35.

Wait, perhaps I need to divide by something.

Wait, perhaps I'm miscounting.

Let me think about it differently.

Let me consider that for e3 = e2 = e, the number of ways is C(v[e], 2) * (v[e] + (prefix[e]-v[e])).

Wait, that seems redundant.

Wait, perhaps I need to think about selecting two sticks from v[e] and one stick from prefix[e], but adjust for overcounting.

Wait, maybe inclusion-exclusion is getting too complicated.

Let me try to think about inclusion-exclusion differently.

Total number of ways is sum over e where v[e] >= 2 of C(v[e], 2) * prefix[e] - sum over e where v[e] >= 3 of C(v[e], 3).

But, in the first test case, that would be C(7,2)*7 - C(7,3) = 21*7 - 35 = 147 - 35 = 112, which is not 35.

So, clearly, this approach is incorrect.

Wait, perhaps I need to consider that when e3 = e2 = e, and e1 <= e, the number of ways is C(v[e], 2) * (prefix[e] - C(v[e],1)), but that doesn't make sense.

Wait, perhaps I need to subtract the cases where e1 < e.

Wait, I'm getting stuck.

Let me try to think about it differently.

Let me consider that for e3 = e2 = e, the number of ways is C(v[e], 2) * (prefix[e] - C(v[e],1)), but that doesn't seem right.

Wait, perhaps I need to think about selecting two sticks from v[e] and one stick from prefix[e-1].

Wait, that is,