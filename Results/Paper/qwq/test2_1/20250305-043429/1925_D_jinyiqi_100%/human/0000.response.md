Alright, I have this problem to solve. Let's see what it's asking for. There are n children in a class, and m pairs among them are friends with a friendship value f_i. The teacher goes on k excursions, and for each excursion, she randomly chooses a pair of children equiprobably and independently. If the chosen pair are friends, their friendship value increases by 1 for all subsequent excursions. Pairs who are not friends have a friendship value of 0 that never changes. I need to find the expected value of the sum of friendship values of all k pairs chosen, considering the time they are chosen.

First, I need to understand the setup. There are n children, and some of them are friends with a given friendship value. The teacher chooses k pairs randomly for excursions, and if a chosen pair are friends, their friendship value increases by 1 for all future excursions. I need to calculate the expected sum of the friendship values at the time of choice for each of the k excursions.

Let me try to rephrase this to make sure I understand. For each excursion, a pair is chosen randomly. If they are friends, their friendship value increases by 1 for all future excursions. The friendship value of non-friend pairs is always 0 and doesn't change. I need the expected sum of the friendship values of all chosen pairs at the time they are chosen.

Okay, so for each chosen pair, if they are friends, their friendship value at the time of choice is f_i plus the number of times they were chosen in previous excursions. Because each time they are chosen, their f_i increases by 1.

Wait, no. The problem says that if a pair of friends is chosen, their friendship value increases by 1 for all subsequent excursions. So, the friendship value at the time of choice is f_i plus the number of times they have been chosen in previous excursions.

But I need the sum of friendship values at the time of choice for each of the k excursions.

This seems a bit tricky. Maybe I can think about the expected contribution of each friend pair to the total sum.

Let's consider a single friend pair (a, b) with initial friendship value f. I need to find the expected contribution of this pair to the total sum over all k excursions.

In each excursion, the pair has a certain probability of being chosen. If they are chosen, their friendship value at that time is f plus the number of times they have been chosen in previous excursions.

Wait, no. The problem says that if a pair of friends is chosen, their friendship value increases by 1 for all subsequent excursions. So, the friendship value at the time of choice is f plus the number of times they have been chosen in previous excursions.

This seems complicated. Maybe I can model this as a process where for each friend pair, their contribution to the total sum is based on how many times they are chosen in the k excursions.

Let me think about it differently. Let's think about the total sum S being the sum of s_1, s_2, ..., s_k, where s_j is the friendship value of the pair chosen in the j-th excursion at the time of choice.

I need E[S] = E[s_1 + s_2 + ... + s_k] = sum_{j=1 to k} E[s_j]

So, I can compute the expected value for each s_j and sum them up.

Now, for each s_j, it depends on which pair is chosen, and if they are friends, their friendship value at that time.

Wait, but the friendship value of a friend pair increases by 1 each time they are chosen, for all subsequent excursions.

This means that if a friend pair is chosen in excursion i, then for all j > i, their friendship value is increased by 1.

But for s_j, which is the friendship value at the time of the j-th excursion, it depends on how many times they have been chosen before j.

This seems messy. Maybe I need to think about the expected value of s_j for each j separately.

Alternatively, perhaps I can think in terms of the linearity of expectation.

Let me consider each friend pair and calculate their total expected contribution to S.

Let me denote the friend pairs as P_1, P_2, ..., P_m, each with initial friendship values f_1, f_2, ..., f_m.

For each friend pair P, let's define X_p as the number of times P is chosen in the k excursions.

Then, the friendship value of P at the time of choice in excursion j is f_p + X_p(j-1), where X_p(j-1) is the number of times P has been chosen in the first j-1 excursions.

Wait, no. If P is chosen in excursion j, then their friendship value at that time is f_p + number of times P has been chosen in previous excursions, i.e., f_p + X_p(j-1).

But X_p(j-1) is the number of times P has been chosen in the first j-1 excursions.

So, s_j = f_p + X_p(j-1), if P is chosen in excursion j.

Otherwise, if the chosen pair is not a friend pair, s_j = 0.

But this seems too involved. Maybe there's a smarter way to compute E[S].

Wait, perhaps I can think about the total sum S as the sum over all friend pairs P of f_p times the number of times P is chosen in the k excursions, plus the sum over all friend pairs P of the number of times P is chosen in the k excursions times the number of times P is chosen before each choice.

Hmm, that sounds confusing.

Let me try to model this differently.

Let me consider that for each friend pair P with initial friendship value f_p, and letâ€™s denote by X_p the total number of times P is chosen in the k excursions.

Then, the sum S is equal to sum over all friend pairs P of f_p * X_p + sum over all friend pairs P of (X_p choose 2).

Wait, is that correct?

Wait, no. If a pair is chosen t times, their friendship value increases by 1 in each subsequent excursion after each choice.

Wait, perhaps it's better to think in terms of the total contribution of each friend pair.

Let me consider a friend pair P with initial friendship value f_p.

Suppose P is chosen in excursions j1, j2, ..., jt, where t is the number of times P is chosen.

Then, for each excursion j, the friendship value at the time of choice is f_p plus the number of times P has been chosen before j.

Wait, more precisely, for each choice j, the friendship value is f_p plus the number of times P has been chosen before j.

So, for t choices, the total contribution to S from P is sum over s=1 to t of (f_p + (s-1)).

This is equal to t * f_p + sum over s=1 to t of (s-1) = t * f_p + (t*(t-1))/2.

Therefore, for each friend pair P, their total contribution to S is t * f_p + (t^2 - t)/2, where t is the number of times P is chosen.

Wait, is that right?

Wait, sum_{s=1 to t} (f_p + s - 1) = t * f_p + sum_{s=1 to t} (s - 1) = t * f_p + sum_{s=0 to t-1} s = t * f_p + (t*(t-1))/2.

Yes, that seems correct.

Therefore, for each friend pair P, their total contribution to S is t * f_p + (t^2 - t)/2, where t is the number of times P is chosen.

Now, to find E[S], I need to sum over all friend pairs P of E[t * f_p + (t^2 - t)/2].

Which is sum_P (E[t * f_p] + E[(t^2 - t)/2]).

Alternatively, sum_P (f_p * E[t] + (E[t^2] - E[t])/2).

So, I need to find for each friend pair P, E[t] and E[t^2].

Given that the teacher chooses pairs independently and equiprobably, and that there are cn2 = n(n-1)/2 possible pairs, of which m are friend pairs.

Wait, actually, since the teacher chooses pairs equiprobably and independently, and there are cn2 = n(n-1)/2 possible pairs, of which m are friend pairs.

Wait, but in the code, it's using cn2 = n*(n-1)//2, which is correct.

But in the code, it's calculating p = 2*k*cn2*sum_f + m*k*(k-1)

and q = 2*cn2**2

Then, p and q are reduced by their gcd, and p * q^{-1} mod M is printed.

I need to verify if this is correct.

Wait, perhaps the approach in the code is different.

Let me try to derive the expected value.

First, let's find E[S] = sum_{j=1 to k} E[s_j]

Now, s_j is the friendship value of the pair chosen in the j-th excursion at the time of choice.

Let me denote the pair chosen in the j-th excursion as P_j.

Then, s_j = f_{P_j} + number of times P_j has been chosen before j, if P_j is a friend pair, else 0.

Wait, more precisely, s_j = f_{P_j} + (number of times P_j has been chosen in previous excursions), if P_j is a friend pair, else 0.

Now, since the choices are independent, P_j is chosen independently of previous choices.

But the friendship value depends on previous choices, which makes this dependent.

This seems complicated.

Maybe I can think in terms of linearity of expectation, considering indicator variables.

Let me try to model this differently.

Let me denote for each friend pair P and for each excursion j, let I_{P,j} be an indicator variable that is 1 if P is chosen in excursion j, and 0 otherwise.

Then, the number of times P is chosen in the first j-1 excursions is sum_{l=1 to j-1} I_{P,l}

Therefore, if P is chosen in excursion j, its friendship value at that time is f_p + sum_{l=1 to j-1} I_{P,l}

Therefore, s_j = sum_{P is a friend pair} (f_p + sum_{l=1 to j-1} I_{P,l}) * I_{P,j}

Because only the chosen pair contributes, and only if it's a friend pair.

Wait, actually, s_j is the friendship value of the pair chosen in excursion j, which is f_p + sum_{l=1 to j-1} I_{P,l} if P is the pair chosen in excursion j and is a friend pair, else 0.

So, to find E[s_j], I need to sum over all friend pairs P of E[(f_p + sum_{l=1 to j-1} I_{P,l}) * I_{P,j}]

Given that the choices are independent, I_{P,j} is independent of I_{P,l} for l != j.

Therefore, E[(f_p + sum_{l=1 to j-1} I_{P,l}) * I_{P,j}] = E[f_p * I_{P,j}] + E[sum_{l=1 to j-1} I_{P,l} * I_{P,j}]

Since I_{P,j} is independent of I_{P,l} for l != j, E[I_{P,l} * I_{P,j}] = E[I_{P,l}] * E[I_{P,j}]

So, E[s_j] = sum_P [f_p * E[I_{P,j}] + sum_{l=1 to j-1} E[I_{P,l}] * E[I_{P,j}]]

Now, E[I_{P,j}] is the probability that P is chosen in excursion j, which is 1/cn2, since there are cn2 possible pairs.

Therefore, E[s_j] = sum_P [f_p / cn2 + sum_{l=1 to j-1} (1 / cn2)^2]

Wait, no.

Wait, E[I_{P,l}] = 1 / cn2, and E[I_{P,j}] = 1 / cn2, and they are independent, so E[I_{P,l} * I_{P,j}] = (1 / cn2)^2

Therefore, E[s_j] = sum_P [f_p / cn2 + (j-1) / (cn2)^2]

Because sum_{l=1 to j-1} E[I_{P,l}] * E[I_{P,j}] = (j-1) / (cn2)^2

Now, sum_P f_p / cn2 = sum_f / cn2

And sum_P (j-1) / (cn2)^2 = m * (j-1) / (cn2)^2, since there are m friend pairs.

Therefore, E[s_j] = sum_P f_p / cn2 + m * (j-1) / (cn2)^2 = sum_f / cn2 + m * (j-1) / (cn2)^2

Now, E[S] = sum_{j=1 to k} E[s_j] = sum_{j=1 to k} [sum_f / cn2 + m * (j-1) / (cn2)^2]

Which is k * sum_f / cn2 + m / (cn2)^2 * sum_{j=1 to k} (j-1)

And sum_{j=1 to k} (j-1) = 0 + 1 + ... + (k-1) = k*(k-1)/2

Therefore, E[S] = k * sum_f / cn2 + m * k * (k - 1) / (2 * (cn2)^2)

Now, in the code, it's calculating p = 2 * k * cn2 * sum_f + m * k * (k - 1)

and q = 2 * (cn2)^2

Then, p / q should be [2 * k * cn2 * sum_f + m * k * (k - 1)] / [2 * (cn2)^2] = [k * sum_f / cn2 + m * k * (k - 1) / (2 * (cn2)^2)]

Wait, but according to my calculation, E[S] = k * sum_f / cn2 + m * k * (k - 1) / (2 * (cn2)^2)

And p / q in the code is [2 * k * cn2 * sum_f + m * k * (k - 1)] / [2 * (cn2)^2] = [2 * k * cn2 * sum_f] / [2 * (cn2)^2] + [m * k * (k - 1)] / [2 * (cn2)^2] = [k * sum_f / cn2] + [m * k * (k - 1)] / [2 * (cn2)^2]

Which matches my calculation of E[S].

Therefore, p / q = E[S]

But the problem asks for the expected value as a fraction p / q in lowest terms, and then p * q^{-1} mod 10^9+7.

In the code, it's computing p and q as above, then dividing p by gcd and multiplying by q^{-1} mod M, which seems correct.

Wait, in the code, it's p = 2 * k * cn2 * sum_f + m * k * (k - 1)

and q = 2 * cn2^2

Then, gcd = gcd(p, q)

p = p / gcd

q = q / gcd

Then, it computes p * q^{-1} mod M, which is correct for finding p / q mod M.

Seems like the approach in the code is correct based on my derivation.

Therefore, the given program is correct.

**Final Answer**

\[ \boxed{\text{Correctness: True}} \]