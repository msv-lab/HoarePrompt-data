Alright, I've got this problem to solve. Let's see what it's asking for. There are n children in a class, and m pairs among them are friends with some friendship value. The teacher goes on k excursions, and for each excursion, she randomly chooses a pair of children. If the pair are friends, their friendship value increases by 1 for all subsequent excursions. Pairs who are not friends have a friendship value of 0 that never changes.

I need to find the expected value of the sum of friendship values of all k pairs chosen for the excursions, and express it as p/q where p and q are coprime, and then compute p * q^{-1} mod (10^9 + 7).

First, I need to understand the process:

1. There are n children, so the total number of possible pairs is n*(n-1)/2.

2. Out of these, m pairs are friends with initial friendship values f_i.

3. For each excursion, a pair is chosen uniformly at random.

4. If the chosen pair are friends, their friendship value increases by 1 for all future excursions.

5. The friendship value of non-friend pairs is always 0 and never changes.

6. I need the expected sum of the friendship values at the time of choice over k excursions.

Let me try to model this.

Letâ€™s denote the friendship values as variables that can change over time. For friend pairs, their friendship value starts at f_i and increases by 1 each time they are chosen.

But, the increase is for subsequent excursions, meaning that if a friend pair is chosen in excursion t, their friendship value increases by 1 for all future excursions starting from t+1.

Wait, actually, the problem says: "If a pair of children who are friends is chosen, their friendship value increases by 1 for all subsequent excursions."

So, the friendship value increases by 1 starting from the next excursion.

I need to compute the expected sum of the friendship values at the time of choice over k excursions.

Let me think about the contribution of each pair to the total sum.

For non-friend pairs: their friendship value is always 0, so they contribute nothing.

For friend pairs: their friendship value starts at f_i and increases by 1 for each time they are chosen in previous excursions.

Wait, more carefully:

- At excursion t, if a friend pair has been chosen s times in the previous excursions (t-1 excursions), their friendship value at time t is f_i + s.

- But s is the number of times they have been chosen in the previous t-1 excursions.

This seems complicated to model directly, especially since the choices are independent but the friendship values depend on previous choices.

Wait, the problem says: "the teacher can choose a pair of children more than once. If a pair of children who are friends is chosen, their friendship value increases by 1 for all subsequent excursions."

So, the friendship value increases by 1 starting from the next excursion, and remains increased for all future excursions if chosen again.

I think it's better to think in terms of the total sum of friendship values at the time of choice over k excursions.

Let me consider the contribution of each friend pair to the total sum.

For a particular friend pair j with initial friendship value f_j:

- Let x_j be the number of times pair j is chosen in the k excursions.

- Each time pair j is chosen, their friendship value at that choice is f_j plus the number of times they have been chosen before.

- So, if they are chosen x_j times, the friendship values at each choice are:

- f_j (first time chosen)

- f_j + 1 (second time)

- f_j + 2 (third time)

- ...

- f_j + (x_j - 1) (x_j-th time)

- So, the total contribution of pair j to the sum is sum from t=0 to x_j-1 of (f_j + t).

- Which is x_j * f_j + sum from t=0 to x_j-1 of t = x_j * f_j + (x_j * (x_j - 1)) / 2.

So, for each friend pair j, their total contribution is x_j * f_j + (x_j * (x_j - 1)) / 2.

But x_j is a random variable, since the choices are random.

Alternatively, perhaps there's a smarter way to compute the expected sum.

Wait, maybe I can think about the expected friendship value at the time of choice for each excursion, and then sum over k excursions.

For each excursion, the expected friendship value of the chosen pair is the sum over all possible pairs of the probability of choosing that pair multiplied by its friendship value at that excursion.

But since the choices are independent, the friendship values depend on previous choices, which complicates things.

Wait, no, the problem says: "the teacher can choose a pair of children more than once. If a pair of children who are friends is chosen, their friendship value increases by 1 for all subsequent excursions."

So, the choices are independent, but the friendship values depend on previous choices.

Wait, but if the choices are independent, then the friendship value for each excursion depends on how many times that pair has been chosen in previous excursions.

This seems messy.

Maybe I need to model this differently.

Let me consider the total sum S of friendship values over k excursions.

S = sum for t=1 to k of f_{pair_t} + number of times pair_t has been chosen in previous excursions.

Wait, more precisely, for each excursion t, if pair_t is chosen, and if pair_t is a friend pair, then their friendship value at time t is f_{pair_t} plus the number of times they have been chosen in previous excursions.

So, S = sum over t=1 to k of (f_{pair_t} + number of times pair_t has been chosen in previous excursions, if pair_t is a friend pair; otherwise 0).

This seems difficult to handle directly.

Perhaps I can think in terms of indicator variables.

Let me denote:

- For each friend pair j, and for each excursion t, let I_{j,t} be an indicator variable that is 1 if pair j is chosen in excursion t, and 0 otherwise.

Then, the total contribution of pair j to S is sum over t=1 to k of (f_j + sum over s=1 to t-1 of I_{j,s}).

So, sum over t=1 to k of f_j + sum over t=1 to k of sum over s=1 to t-1 of I_{j,s}.

Which is k * f_j + sum over s=1 to k-1 of (k - s) * I_{j,s}.

Wait, this seems complicated.

Maybe there's a better way.

Let me consider the total sum S as sum over all friend pairs j of sum over t=1 to k of (f_j + number of times pair j has been chosen in previous excursions).

Which is sum over j (f_j * number of times pair j is chosen) + sum over j (sum over t=1 to k of (number of times pair j is chosen in previous excursions)).

This still seems messy.

Perhaps I should think about the expected value directly.

Given that the choices are independent, maybe I can compute the expected friendship value for each excursion and then sum them up.

Wait, but the friendship values depend on previous choices, so independence is lost.

This is tricky.

Maybe I need to model this as a Markov process, where the state is the current friendship values of all friend pairs, and the transitions depend on which pair is chosen.

But with n up to 10^5 and m up to 10^5, that's not feasible.

I need a smarter approach.

Let me consider the linearity of expectation.

Can I use linearity of expectation to compute the expected sum?

Yes, linearity of expectation holds even if the random variables are dependent.

So, E[S] = sum over t=1 to k of E[friendship value at excursion t].

Now, I need to compute E[friendship value at excursion t] for each t from 1 to k.

But the friendship values depend on previous excursions, so I need to find a way to compute this expectation efficiently.

Let me think about the process for a single friend pair and see if I can generalize.

Suppose there is only one friend pair with initial friendship value f.

Total possible pairs is p = n*(n-1)/2.

Probability of choosing this pair in any excursion is 1/p.

Now, for k excursions, the number of times this pair is chosen follows a binomial distribution with parameters k and 1/p.

But their friendship value increases by 1 for each previous choice.

Wait, let's think about the friendship value at the time of choice.

Suppose the pair is chosen in excursions t1, t2, ..., tm, where m is the number of times chosen.

Then, for each t in {t1, t2, ..., tm}, the friendship value at time t is f plus (number of times chosen before t).

Wait, more precisely, for each t where the pair is chosen, the friendship value is f plus (number of times chosen before t).

This seems complicated.

Maybe I can model the total sum for this single pair.

Total sum S = sum over t=1 to k of (f + number of times chosen before t), but only if the pair is chosen at t.

Wait, more carefully:

- For each t from 1 to k:

- If the pair is chosen at t, contribute f plus (number of times chosen before t).

- Else, contribute 0.

So, S = sum over t=1 to k of I_t * (f + sum over s=1 to t-1 of I_s),

where I_t is 1 if the pair is chosen at t, 0 otherwise.

Now, E[S] = sum over t=1 to k of E[I_t * (f + sum over s=1 to t-1 of I_s)].

Since I_t is 1 with probability 1/p, and the choices are independent.

Wait, but the problem says the choices are independent, but the friendship values depend on previous choices.

Wait, but in this case, since the choices are independent, the probability of choosing a particular pair at time t is 1/p, regardless of previous choices.

But the friendship value at time t depends on the number of times the pair has been chosen before t.

Wait, perhaps I can think of it as:

E[S] = sum over t=1 to k of E[I_t * (f + number of times chosen before t)].

Now, E[I_t * (f + number of times chosen before t)] = E[I_t * f] + E[I_t * number of times chosen before t].

Since I_t is independent of previous I_s for s < t, because choices are independent.

So, E[I_t * f] = f * E[I_t] = f / p.

And E[I_t * number of times chosen before t] = E[I_t] * E[number of times chosen before t] = (1/p) * E[number of times chosen before t].

Now, E[number of times chosen before t] = sum over s=1 to t-1 of E[I_s] = (t-1)/p.

Therefore, E[S] = sum over t=1 to k of (f / p + (1/p)*(t-1)/p).

Wait, is that correct?

Wait, E[I_t * number of times chosen before t] = E[I_t] * E[number of times chosen before t] because I_t is independent of previous I_s.

Yes, that seems correct.

So, E[S] = sum over t=1 to k of (f / p + (1/p)*(t-1)/p).

Simplify:

E[S] = sum over t=1 to k of (f / p + (t-1)/p^2).

Which is sum over t=1 to k of f / p + sum over t=1 to k of (t-1)/p^2.

First term: k * f / p.

Second term: sum over t=0 to k-1 of t / p^2 = (sum from t=0 to k-1 of t) / p^2 = (k*(k-1)/2) / p^2.

So, E[S] = k * f / p + k*(k-1)/(2*p^2).

Now, for multiple friend pairs, since the choices are independent, I can sum over all friend pairs their individual E[S].

Wait, but there might be dependencies between different friend pairs, but since the choices are independent, maybe I can use linearity of expectation again.

Wait, actually, since the choices are independent, and the friendship values of different pairs don't affect each other, yes, I can sum over all friend pairs their individual E[S].

So, total expected sum E[S_total] = sum over all friend pairs of E[S_j], where S_j is the sum for friend pair j.

Therefore, E[S_total] = sum over j of (k * f_j / p + k*(k-1)/(2*p^2)).

Wait, does that make sense?

Wait, no, because in the second term, (k*(k-1))/(2*p^2), this seems to be independent of j, but it should depend on j.

Wait, no, in my earlier calculation for a single pair, E[S] = k * f_j / p + k*(k-1)/(2*p^2).

But actually, looking back, p is the total number of possible pairs, p = n*(n-1)/2.

Wait, but in the second term, it's (k*(k-1))/(2*p^2), which seems odd because it doesn't depend on f_j.

Wait, perhaps I made a mistake in the calculation for a single pair.

Let me recast.

For a single friend pair j with initial friendship value f_j:

E[S] = sum over t=1 to k of E[I_t * (f_j + sum over s=1 to t-1 of I_s)].

Which is sum over t=1 to k of E[I_t * f_j] + E[I_t * sum over s=1 to t-1 of I_s].

Since I_t is independent of I_s for s < t, E[I_t * sum over s=1 to t-1 of I_s] = E[I_t] * E[sum over s=1 to t-1 of I_s] = (1/p) * (t-1)/p.

And E[I_t * f_j] = f_j / p.

Therefore, E[S] = sum over t=1 to k of (f_j / p + (t-1)/p^2).

Which is k * f_j / p + (sum over t=1 to k of (t-1)) / p^2.

Sum over t=1 to k of (t-1) = sum over t=0 to k-1 of t = k*(k-1)/2.

Therefore, E[S] = k * f_j / p + k*(k-1)/(2*p^2).

Now, for multiple friend pairs, since the choices are independent, the expected sum is sum over j of E[S_j].

Therefore, E[S_total] = sum over j of (k * f_j / p + k*(k-1)/(2*p^2)).

But this seems odd because the second term doesn't depend on f_j.

Wait, actually, it does depend on j through p, but p is the same for all j.

Wait, p is the total number of possible pairs, which is n*(n-1)/2, and is the same for all j.

So, E[S_total] = sum over j of (k * f_j / p + k*(k-1)/(2*p^2)).

Which is sum over j of k * f_j / p + m * k*(k-1)/(2*p^2), where m is the number of friend pairs.

Wait, no, sum over j of a constant is m times that constant.

So, E[S_total] = sum over j of k * f_j / p + sum over j of k*(k-1)/(2*p^2).

The first sum is k / p * sum over j of f_j.

Let me denote s = sum over j of f_j.

So, E[S_total] = k * s / p + m * k*(k-1)/(2*p^2).

Wait, no, sum over j of k*(k-1)/(2*p^2) is m * k*(k-1)/(2*p^2), since there are m friend pairs.

Yes, that's correct.

Therefore, E[S_total] = (k * s)/p + (m * k*(k-1))/(2*p^2).

Now, p = n*(n-1)/2.

So, E[S_total] = (2*k*s)/(n*(n-1)) + (m * k*(k-1))/(n*(n-1))^2.

Wait, but I need to confirm if this is correct.

Let me think again.

Each friend pair j contributes:

- k * f_j / p: this makes sense, as the expected number of times pair j is chosen is k / p, and each time their contribution is f_j plus the number of times they have been chosen before.

Wait, but in my earlier calculation, I have E[S_j] = k * f_j / p + (k*(k-1))/(2*p^2).

But actually, perhaps there's a mistake here.

Wait, perhaps I need to consider that for each pair j, the expected sum is:

E[S_j] = E[sum over t=1 to k of I_t,j * (f_j + number of times chosen before t)].

Where I_t,j is 1 if pair j is chosen at time t, else 0.

Now, E[I_t,j] = 1/p.

And E[I_t,j * number of times chosen before t] = E[I_t,j] * E[number of times chosen before t] = (1/p) * (t-1)/p.

Therefore, E[S_j] = sum over t=1 to k of (f_j / p + (t-1)/p^2).

Which is k * f_j / p + (sum over t=1 to k of (t-1))/p^2 = k * f_j / p + (k*(k-1)/2)/p^2.

So, E[S_j] = k * f_j / p + k*(k-1)/(2*p^2).

Therefore, E[S_total] = sum over j of E[S_j] = k * s / p + m * k*(k-1)/(2*p^2).

Where s = sum over j of f_j.

Yes, that seems correct.

Now, I need to compute this expected value and then find p/q where p and q are coprime, and then p * q^{-1} mod (10^9 + 7).

So, E[S_total] = (k * s)/p + (m * k*(k-1))/(2*p^2).

Now, p = n*(n-1)/2.

So, E[S_total] = (2*k*s)/(n*(n-1)) + (m * k*(k-1))/(n*(n-1))^2.

I need to express this as a fraction p/q and then compute p * q^{-1} mod (10^9 + 7).

To do this efficiently, especially with large numbers and multiple test cases, I need to compute this expression modulo 10^9 + 7, handling inverses properly.

Given the constraints, sum of n and m over all test cases doesn't exceed 10^5 and sum of k over all test cases doesn't exceed 2*10^5, I need an efficient way to compute this for each test case separately.

So, in code, for each test case:

- Read n, m, k.

- Compute p = n*(n-1)/2.

- Compute s = sum of f_j for all m friend pairs.

- Compute E[S_total] = (2*k*s)/(n*(n-1)) + (m * k*(k-1))/(n*(n-1))^2.

- Express this as a fraction p/q and compute p * q^{-1} mod (10^9 + 7).

Now, to handle fractions and modular inverses, I need to work in the field modulo 10^9 + 7, which is a prime.

So, I can compute inverses modulo 10^9 + 7.

First, compute p = n*(n-1)/2.

But need to handle division by p and p^2.

So, compute inv_p = inverse of p modulo 10^9 + 7.

Similarly, inv_p2 = inverse of p^2 modulo 10^9 + 7.

But since p might be large, I need to compute inv_p = p^{M-2} mod M, where M = 10^9 + 7.

Similarly, inv_p2 = (p^2)^{M-2} mod M.

But (p^2)^{M-2} = p^{2*(M-2)} mod M.

But it's easier to compute inv_p2 = inv_p * inv_p mod M.

So, inv_p = pow(p, M-2, M)

inv_p2 = pow(p, 2*(M-2), M) = inv_p * inv_p mod M.

But actually, inv_p2 = pow(p, -2, M