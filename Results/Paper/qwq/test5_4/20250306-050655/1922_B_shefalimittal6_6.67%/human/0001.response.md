Alright, I've got this problem to solve. Let's see what it's asking for. So, I have n sticks, each with a length of 2 raised to the power of a_i, where a_i is given for each stick. I need to choose exactly 3 sticks and form a non-degenerate triangle with them. A non-degenerate triangle means that the area is greater than 0, which in terms of side lengths means that the sum of any two sides must be greater than the third side. That's the triangle inequality theorem.

So, my task is to count how many ways I can choose 3 sticks such that their lengths satisfy the triangle inequality.

First, I need to understand the input and output format. There are multiple test cases, and for each test case, I get n and a list of a_i values. The constraints are that t can be up to 10^4, and n can be up to 3*10^5, with the sum of n over all test cases not exceeding 3*10^5. That means I need an efficient solution, probably O(n) or O(n log n) per test case to handle the time limits.

Let me think about the properties of the stick lengths. Each stick has a length of 2^{a_i}. Since a_i can be up to n, and n can be up to 3*10^5, the lengths can be very large, but since they are powers of 2, they are distinct except when a_i are equal.

Wait a minute, powers of 2 are distinct unless the exponents are the same. So, if a_i are unique, then all stick lengths are unique. But in this problem, a_i can be the same, so stick lengths can be the same if a_i are the same.

But in the example given, for n=7 and all a_i=1, which means all sticks have length 2^1=2. So, any three sticks will form a triangle because all sides are equal, satisfying the triangle inequality.

In the second example, n=4 with a_i=[3,2,1,3], so lengths are [8,4,2,8]. So, possible triangles are (8,8,4) and (8,4,2). But wait, (8,8,4) satisfies the triangle inequality because 8+4 > 8, 8+8 > 4, and 8+4 > 8. But (8,4,2) does not satisfy because 4 + 2 = 6, which is not greater than 8. So, only (8,8,4) should be a valid triangle, but the output shows 2. Hmm, maybe I miscalculated.

Wait, in the second test case, output is 2, but according to the note, you can choose the 1st, 2nd, and 4th stick, or the 1st, 3rd, and 4th stick. Let's see:

Sticks: 1st=8, 2nd=4, 3rd=2, 4th=8.

So, combinations:

- (1,2,4): lengths (8,4,8) -> 8+4 > 8, 8+8 > 4, 4+8 > 8 -> valid.

- (1,3,4): lengths (8,2,8) -> 8+2 > 8, 8+8 > 2, 2+8 > 8 -> valid.

- (2,3,4): lengths (4,2,8) -> 4+2=6 > 8? No, 6 < 8 -> invalid.

So, there are two valid triangles, as per the output.

In the third test case, n=3 with a_i=[1,2,3], so lengths [2,4,8]. As I saw earlier, (2,4,8) does not satisfy the triangle inequality because 2+4=6 < 8. So, no valid triangles, output is 0.

Fourth test case, n=1 with a_i=[1], only one stick, can't form a triangle, output is 0.

So, I need to find the number of combinations of three sticks where the sum of any two sides is greater than the third side.

Now, how to approach this efficiently.

First thought: generate all possible combinations of three sticks and check the triangle inequality for each. But with n up to 3*10^5, that would be O(n^3), which is way too slow.

Need a smarter approach.

Let's think about the properties of the triangle inequality.

For three lengths a, b, c to form a triangle, they must satisfy:

a + b > c

a + c > b

b + c > a

Assuming a <= b <= c, then the most restrictive condition is a + b > c, because if that holds, the other two inequalities will automatically hold.

So, if I sort the stick lengths in non-decreasing order, and for every triplet (a, b, c), check if a + b > c, then I can count the number of such triplets.

But even with sorting, checking all possible triplets would still be O(n^3), which is too slow.

I need a way to count the number of triplets where a + b > c, given that the sticks are sorted.

Let me recall that for a sorted array, I can fix the largest stick c and find pairs (a, b) such that a + b > c.

But iterating over each c and then finding pairs (a, b) where a + b > c is still O(n^2), which might be acceptable for n up to 3*10^5, but considering t up to 10^4 and the sum of n over all test cases is up to 3*10^5, the total time complexity would be O(t * n^2), which would be too slow.

I need a better approach.

Let me think differently.

Given that the stick lengths are powers of 2, perhaps there are some properties of powers of 2 that I can exploit.

Powers of 2 are 1, 2, 4, 8, 16, etc. They double each time.

Let's see, in the first test case, all a_i are 1, so all sticks have length 2. So, any three sticks will form a triangle because 2 + 2 > 2.

In the second test case, lengths are 8,4,2,8. Sorted: 2,4,8. Only (4,8,8) form a valid triangle.

Wait, in the second test case, output is 2, but according to the sorted array, only one unique triplet (4,8,8), but since there are two sticks of length 8, there are two ways to choose them.

Ah, I see. So, it's (4,8,8) and (4,8,8), but since the sticks are numbered, they are distinct even if their lengths are the same.

Wait, no. In the problem statement, it says "the order of choosing sticks does not matter". So, choosing stick 1, stick 2, stick 4 is the same as choosing stick 4, stick 2, stick 1.

In the second test case, there are two triplets that satisfy the triangle inequality: (1,2,4) and (1,3,4), as per the note.

So, perhaps I need to consider the frequencies of each stick length.

Let me think about frequencies.

Suppose I have multiple sticks with the same length.

If I have multiple sticks with the same length, I need to consider combinations where I choose multiple sticks of the same length.

So, if I have k sticks of length l, then the number of ways to choose three sticks of length l is C(k,3), assuming k >= 3.

Also, for sticks of different lengths, I need to consider pairs of sticks.

Wait, perhaps inclusion-exclusion could be applied here.

But I'm getting confused.

Let me try to think of a better way.

I recall that in a sorted array, for each c, I can find the number of pairs (a,b) where a + b > c.

Given that the array is sorted, I can use two pointers to find, for each c, how many pairs (a,b) have a + b > c.

Here's how it works:

- Sort the stick lengths in non-decreasing order.

- For each c from n-1 down to 2:

- Set two pointers, left = 0, right = c - 1.

- While left < right:

- If sticks[left] + sticks[right] > sticks[c], then all pairs from left to right-1 will satisfy the condition, so add (right - left) to the result, and decrement right.

- Else, increment left.

This way, for each c, I can find the number of pairs (a,b) where a + b > c in O(n) time, and since I do this for each c from n-1 down to 2, the total time complexity is O(n^2), which might be acceptable for n up to 3*10^5, but considering t up to 10^4, it's still too slow.

I need a better approach.

Let me think about the properties of powers of 2.

Powers of 2 are such that each length is double the previous one.

Wait, but in the problem, a_i can be up to n, so lengths can be up to 2^n, which for n=3*10^5 is huge, but since they are powers of 2, they are sparse.

Wait, but a_i can be up to n, so lengths are up to 2^n, but n is up to 3*10^5, so 2^{3*10^5} is way beyond any standard integer type.

But in Python, integers can be arbitrarily large, so that's fine.

But perhaps there's a smarter way to use the properties of powers of 2.

Let me consider that for any three sticks with lengths 2^x, 2^y, 2^z, where x <= y <= z.

For them to form a triangle, we need 2^x + 2^y > 2^z.

Given that x <= y <= z, the largest side is 2^z.

So, the condition is 2^x + 2^y > 2^z.

Now, since 2^x + 2^y <= 2^{y+1} (because 2^x + 2^y <= 2^y + 2^y = 2^{y+1}).

So, if y < z, then 2^{y+1} <= 2^z, because y + 1 <= z.

Wait, if y < z, then y + 1 <= z, so 2^{y+1} <= 2^z.

Therefore, 2^x + 2^y <= 2^{y+1} <= 2^z, which would mean 2^x + 2^y <= 2^z.

But for the triangle inequality, we need 2^x + 2^y > 2^z.

So, the only way for 2^x + 2^y > 2^z is if y = z.

Wait, let's see.

If y = z, then 2^x + 2^y = 2^x + 2^y.

If x < y, then 2^x + 2^y = 2^x + 2^y.

Is 2^x + 2^y > 2^y?

Yes, because 2^x > 0.

Wait, but if x < y, then 2^x + 2^y = 2^x + 2^y, which is greater than 2^y.

But in this case, 2^x + 2^y = 2^y + 2^x, which is greater than 2^y, but I need to check if it's greater than 2^z, which is 2^y.

So, 2^x + 2^y > 2^y only if 2^x > 0, which is always true.

But that can't be right because in the second test case, (2,4,8) doesn't form a triangle.

Wait, in that case, x=1, y=2, z=3, so 2^1 + 2^2 = 2 + 4 = 6, which is less than 8=2^3.

So, according to my earlier reasoning, if y = z, then 2^x + 2^y > 2^z.

But in this case, y=2, z=3, y < z, so y != z.

Wait, so my earlier assumption that y must be equal to z for the inequality to hold is incorrect.

Because in the case where y = z, 2^x + 2^y > 2^z becomes 2^x + 2^y > 2^y, which simplifies to 2^x > 0, which is always true.

So, if y = z, then 2^x + 2^y > 2^z always holds.

But in the case where y < z, 2^x + 2^y <= 2^z, as I thought earlier.

Therefore, the triangle inequality holds if and only if y = z.

In other words, in any valid triangle, the two larger sides must be equal.

So, in the sorted order, if I have sticks a <= b <= c, then b must be equal to c for the triangle inequality to hold.

Wait, but in the second test case, we have sticks 2,4,8, and only (4,8,8) forms a valid triangle, which aligns with this.

Because in (4,8,8), b = c = 8, so b = c.

In (2,4,8), b = 4, c = 8, b != c, so it's invalid.

Similarly, in the first test case, all sticks are of length 2, so any triplet has a=b=c=2, which satisfies b=c.

In the third test case, sticks are 2,4,8, only possible triplet is (2,4,8), which doesn't satisfy b=c.

Hence, the number of valid triangles is equal to the number of triplets where the two larger sticks have the same length.

So, to generalize, for a given set of stick lengths, sort them, and count the number of triplets where the second largest and the largest sticks have the same length.

This seems like a much simpler condition to work with.

So, my plan is:

1. Sort the stick lengths in non-decreasing order.

2. For each possible c (from n-1 down to 2), find the number of pairs (a,b) where a <= b <= c and b = c.

Given that, I can group the sticks by their lengths and count the number of triplets where the second and third sticks have the same length.

Let me think about how to implement this efficiently.

First, count the frequency of each stick length.

Let's say I have frequencies f_l for each length l.

Then, for each unique length l, the number of ways to choose two sticks of length l is C(f_l, 2).

For each such pair, I can choose any a < l, and the triplet will satisfy the triangle inequality because a + l > l (since l > a).

Wait, but a + l > l holds because a > 0, but in the earlier analysis, I saw that for the triangle inequality to hold, the two larger sides must be equal.

Wait, but in this case, if I have two sticks of length l, and one stick of length a < l, then a + l > l holds, and l + l > a holds, since l + l = 2l > a.

Similarly, a + l > l holds.

So, indeed, any triplet where two sticks have the same length l, and the third stick has length a < l will satisfy the triangle inequality.

Wait, but in the second test case, we have two sticks of length 8 and one stick of length 4.

So, choosing two sticks of length 8 and one stick of length 4 satisfies the condition.

Similarly, in the first test case, all sticks have the same length, so any triplet where two sticks are of length 2 and the third is also 2 satisfies the condition.

In the third test case, we have one stick of length 2, one of 4, and one of 8. There are no two sticks of the same length, so no valid triplets.

In the fourth test case, only one stick, so no valid triplets.

So, the number of valid triplets is equal to the sum over all lengths l of f_l choose 2 times the number of sticks with lengths less than l.

Wait, but in the second test case, f_8 = 2, so C(2,2) = 1, and there is one stick with length less than 8, which is 4, so 1 * 1 = 1, but the output is 2.

Hmm, that doesn't match.

Wait, perhaps I'm missing something.

Wait, in the second test case, there are two sticks of length 8, and one stick of length 4.

So, f_8 = 2, f_4 = 1, f_2 = 1.

But the valid triplets are (4,8,8), which corresponds to choosing two sticks of length 8 and one stick of length 4.

So, in this case, it's C(2,2) * 1 = 1, but the output is 2.

Wait, maybe I need to consider that the two sticks of length 8 are distinct because they are different sticks, even if their lengths are the same.

Wait, but in combinatorics, if I have two sticks of length 8, and I choose both of them, and pair them with one stick of length 4, it should be only one combination.

But according to the problem, there are two ways to choose the sticks: (1,2,4) and (1,3,4), assuming stick 1 and stick 4 are the two sticks of length 8, and stick 2 is length 4.

So, in this case, choosing stick 1 and stick 4 (both of length 8) with stick 2 (length 4) is one triplet, and choosing stick 1 and stick 3 (both of length 8) with stick 2 (length 4) is another triplet.

Wait, but if stick 1 and stick 4 are both length 8, and stick 3 is also length 8, then choosing stick 1 and stick 4 with stick 2, and choosing stick 1 and stick 3 with stick 2 are two different triplets.

But in terms of lengths, both triplets are (8,8,4), so perhaps in the problem, sticks are considered distinct based on their indices, even if their lengths are the same.

So, in that case, the number of valid triplets where two sticks have length l and one stick has length a < l is C(f_l, 2) * (total number of sticks with lengths less than l).

Wait, but in the second test case, f_8 = 2, C(2,2) = 1, and number of sticks with length less than 8 is 1 (the stick of length 4), so 1 * 1 = 1, but the output is 2.

Wait, perhaps I need to consider that the sticks are distinct, so even if their lengths are the same, choosing different sticks counts as different triplets.

So, in that case, for two sticks of length 8 and one stick of length 4, the number of valid triplets is C(2,2) * 1 = 1, but since the two sticks of length 8 are distinct, choosing stick 1 and stick 4 with stick 2, and stick 1 and stick 3 with stick 2 are two different triplets.

Wait, but C(2,2) is 1, so multiplying by 1 gives 1, but the output is 2.

I must be misunderstanding something.

Wait, perhaps I need to consider that for each pair of sticks with length l, I can choose any of the sticks with length less than l, but considering that the sticks with length l are distinct.

Wait, perhaps I need to think in terms of combinations, but considering that sticks with the same length are still distinct entities because of their indices.

So, if I have f_l sticks of length l, the number of ways to choose two sticks of length l is C(f_l, 2), and for each such pair, I can choose any stick with length less than l.

If there are s sticks with lengths less than l, then the number of valid triplets for that l is C(f_l, 2) * s.

In the second test case, f_8 = 2, s = 1 (only one stick with length less than 8, which is 4), so C(2,2) * 1 = 1 * 1 = 1, but the output is 2.

Wait, maybe I need to consider that s is the number of sticks with lengths less than or equal to l, but that would include sticks of length l, which are already chosen in the pair.

Wait, no, in the triangle inequality, for a <= b <= c, to have b = c, I need to choose two sticks of length c and one stick of length a < c.

So, s is the number of sticks with lengths less than c.

In the second test case, c = 8, s = 1 (stick of length 4), f_c = 2, so C(2,2) * 1 = 1.

But the output is 2, which suggests that there is another triplet.

Wait, perhaps I miscounted the number of sticks with lengths less than c.

Wait, in the second test case, sticks are [2,4,8,8]. So, for c=8, s = number of sticks < 8, which is 2 (sticks of length 2 and 4).

Wait, is that right? Let's see.

Sticks: 2,4,8,8.

For c=8, s = number of sticks < 8, which is 2 (2 and 4).

Then, f_c = 2.

So, number of triplets is C(2,2) * 2 = 1 * 2 = 2, which matches the output.

Ah, I see. So, s is the number of sticks with lengths less than c.

In my earlier calculation, I mistakenly thought s=1, but actually s=2.

Yes, that makes sense.

So, generalizing, for each unique length l, if f_l is the frequency of l, and s is the number of sticks with lengths less than l, then the number of valid triplets for that l is C(f_l, 2) * s.

Then, sum over all l of C(f_l, 2) * s.

Wait, but in the first test case, all a_i=1, so all sticks have length 2.

So, f_2 = 7.

s = number of sticks < 2, which is 0, since all sticks have length 2.

But according to the problem, any three sticks form a valid triangle.

But according to this formula, C(7,2) * 0 = 0, which is not correct.

Wait, there must be a mistake in this approach.

Wait, in the first test case, all sticks have the same length of 2.

So, for l=2, f_l=7, s=0 (since no sticks have length less than 2).

But in reality, for sticks of length 2, to form a triangle, we need to choose any three sticks, which will have a=b=c=2, which satisfies a + b > c (2 + 2 > 2).

So, in this case, even though s=0, we still have valid triplets.

This suggests that my earlier assumption is incomplete.

I need to reconsider.

Wait, perhaps I need to consider that when b = c, and a < b, then a + b > c holds.

But in the case where a = b = c, it still holds because a + b = 2a > a.

So, in the first test case, where all sticks have the same length, any three sticks will form a valid triangle.

So, perhaps I need to consider that when f_l >= 3, then C(f_l,3) triplets where all three sticks have length l, and these triplets are valid.

In addition to that, the triplets where two sticks have length l and one stick has length less than l.

So, total number of valid triplets is sum over all l of [C(f_l,3) + C(f_l,2) * s], where s is the number of sticks with lengths less than l.

In the first test case, for l=2, f_l=7, s=0.

So, C(7,3) + C(7,2)*0 = 35 + 0 = 35, which matches the output.

In the second test case, l=8, f_l=2, s=2 (sticks of length 2 and 4).

So, C(2,3)=0 (since f_l < 3), C(2,2)*2 = 1*2=2, which matches the output.

In the third test case, l=3, f_l=1, s=2 (sticks of length 1 and 2).

But f_l=1, so C(1,2)=0, and C(1,3)=0, so total 0, which matches the output.

Fourth test case, l=1, f_l=1, s=0, so 0, which matches the output.

Yes, this seems correct.

So, the general formula is:

For each unique length l, with frequency f_l, and s being the number of sticks with lengths less than l, the number of valid triplets is C(f_l,3) + C(f_l,2)*s.

Then, sum this over all l.

This accounts for both the triplets where all three sticks have the same length and where two sticks have the same length and the third is smaller.

This seems to be the correct approach.

Now, to implement this efficiently, I need to:

1. For each test case, count the frequency of each a_i.

2. Sort the unique lengths in ascending order.

3. For each length l, calculate s, which is the sum of frequencies of all lengths less than l.

4. For each length l, add