Alright, I've got this problem to solve. Let's see what it's about. So, there are two players, Bodya and Sasha, who start at certain positions in a permutation, and they play a game for k turns. Each turn, they can choose to stay or move to another position based on the permutation. Their score increases by the value at their current position each turn. The goal is to determine who wins after k turns, assuming both play optimally.

First, I need to understand the inputs and what's being asked. The input consists of multiple test cases. For each test case, I get the length of the permutation n, the number of turns k, and the starting positions for Bodya and Sasha, pb and ps respectively. Then, there's the permutation p of length n and an array a of length n with values.

The problem is to determine, after exactly k turns, who has the higher score: Bodya or Sasha. If their scores are equal, it's a draw.

Okay, so both players make decisions simultaneously each turn: they can choose to stay or move to p[x], where x is their current position. They're trying to maximize their own scores.

I need to figure out what the optimal strategy is for both players. Since they make decisions simultaneously, it's not a zero-sum game in the traditional sense, but they are independently trying to maximize their scores.

One approach is to model this as two separate processes, since their moves don't directly affect each other. So, for each player, I can determine the optimal sequence of stays and moves to maximize their score over k turns.

But, since they make moves simultaneously, I need to consider that their decisions are made independently.

Wait, no, their decisions don't affect each other directly; they just follow their own strategies.

So, perhaps I can treat each player separately and find the maximum score each can achieve individually, then compare those scores.

But, I need to make sure that I'm considering the same turns for both.

Wait, no, since they make moves simultaneously, their moves correspond to the same turns.

But, since they make decisions independently, I can treat their paths separately.

Wait, but in the explanation, it seems like their moves are interleaved in a sense, but actually, they make decisions at each turn independently.

So, for each turn, both decide whether to stay or move.

But, the problem is that their decisions are simultaneous, so neither knows what the other will do.

But, in this game, since the decisions don't interfere with each other, except through the positions they choose, but positions don't affect each other directly.

Wait, no, their positions are independent; they just follow their own permutation paths.

So, perhaps I can model each player's path independently.

Let me think differently.

Each player has a sequence of positions over k turns, based on their decisions to stay or move.

The goal is to maximize the sum of a[x] over k turns, where x is their position.

Since they can choose to stay or move each turn, they can choose to remain at a position or follow the permutation.

I need to find, for each player, the maximum possible sum over k turns.

Then, compare these sums to see who wins.

But, computing all possible sequences is exponential in k, which is up to 1e9, so that's not feasible.

I need a smarter approach.

Let me consider the structure of the permutation.

A permutation consists of cycles.

If a player is in a cycle, repeatedly following the permutation will cycle through the same positions.

So, perhaps I can find the cycles in the permutation and analyze the behavior within each cycle.

For example, if a player is in a cycle of length m, and m divides k, then the player can choose to cycle through the cycle or stay at one position.

But, since k can be up to 1e9, and n is up to 2e5, I need an efficient way to compute the maximum possible sum for each player.

Wait, perhaps I can model this as a graph where each position is a node, and there is an edge from x to p[x], and an option to stay at x.

Then, the problem becomes finding the path of length k for each player that maximizes the sum of a[x] over the path.

But, with n up to 2e5 and k up to 1e9, this seems too slow.

I need a better way.

Let me consider that in each turn, a player can choose to stay or move to p[x].

So, for each position x, the player can choose to stay at x and get a[x], or move to p[x] and get a[p[x]].

Wait, no: if they stay, they get a[x], and if they move, they move to p[x] and get a[p[x]] in the next turn.

Wait, no: in each turn, they first add a[x] to their score, then choose to stay at x or move to p[x].

So, it's more like:

- At the start of turn t, they are at position x.

- They add a[x] to their score.

- Then, they choose to stay at x or move to p[x].

- The next turn, they are at the position they chose in the previous step.

So, in other words, in each turn, they decide where to be next: x or p[x].

Wait, but in the problem statement, it says:

"On each turn, two things happen to each player:

- If the current position of the player is x, his score increases by a_x.

- Then the player either stays at his current position x or moves from x to p_x."

So, in each turn:

1. Add a[x] to the player's score.

2. Choose to stay at x or move to p[x].

So, in the next turn, they are at x (if they stayed) or p[x] (if they moved).

This is similar to a Markov decision process, where each player has a state (their current position), and they make a decision to stay or move.

Since both players make decisions independently, I can treat their decision processes separately.

Now, I need to find, for each player, the maximum possible score over k turns, given their starting position.

Then, compare the two scores to determine who wins.

But, with k up to 1e9, I need an efficient way to compute this.

Let me consider what happens in the game.

For a single player, starting at position x, each turn they can choose to stay at x or move to p[x].

If they stay, their position remains x, and they get a[x] again next turn.

If they move, their position changes to p[x], and they get a[p[x]] next turn.

So, for a player, their sequence of positions over k turns is determined by their choices to stay or move at each turn.

The goal is to maximize the sum of a[x] over k turns.

This looks like a dynamic programming problem, but with k up to 1e9, I need a smarter way.

I need to find a way to compute the maximum possible sum for each player efficiently.

Let me consider that the permutation consists of cycles.

If a player is in a cycle of length m, then after m moves, they return to their starting position.

But, since they can choose to stay at any point, the cycle structure might not be directly applicable.

Wait, perhaps I can model this differently.

Let me fix a player and consider their possible positions over time.

Let's define f(t, x) as the maximum score achievable after t turns, starting from position x.

Then, the recurrence is:

f(t, x) = a[x] + max(f(t-1, x), f(t-1, p[x]))

Because in each turn, they add a[x] and then choose to stay at x or move to p[x].

But this is O(n*k), which is too slow for n=2e5 and k=1e9.

I need a better approach.

Let me consider that for each player, the optimal strategy is to choose to stay at the position with the maximum a[x] in their accessible positions.

But, since they can choose to stay or move, they might be able to cycle through positions to maximize their score.

Wait, perhaps I can find, for each player, the position with the maximum a[x] in their accessible positions, and then decide to stay there for all remaining turns.

But, they might gain more by moving to another position and then staying there.

Wait, perhaps I need to find the maximum a[x] in the permutation cycle that the player can reach.

But, since they can choose to stay or move each turn, they can choose which positions to visit.

Wait, perhaps I can model this as each player having a graph where edges are from x to p[x], and they can choose to stay or move each turn.

This seems complicated.

Let me think differently.

Suppose a player is at position x.

They can choose to stay at x for any number of turns, getting a[x] each turn, or move to p[x] and repeat the process.

So, for each player, the optimal strategy is to find the position with the maximum a[x] in their accessible positions and stay there for as many turns as possible.

But, they might gain more by moving to another position and then staying there.

Wait, perhaps I can compute, for each player, the maximum a[x] in their accessible positions, and then set their score to k * max_a.

But, this might not be correct, because they might need to move through some positions to reach that maximum a[x].

Wait, no, they can choose to stay or move each turn, so they can reach any position in their accessible positions in one move.

Wait, no, they can only move to p[x] each turn, or stay at x.

So, their accessible positions are the positions in the permutation cycle that includes their starting position.

But, in reality, since the permutation is a cycle, they can reach any position in the cycle by moving repeatedly.

But, they can also choose to stay at any position.

So, perhaps the optimal strategy is to find the position in their cycle with the maximum a[x], and then stay there for the remaining turns.

But, they might gain more by staying at a position with a lower a[x] for some turns before moving to the position with the maximum a[x].

Wait, let's consider an example.

Take the first example in the input:

n=4, k=2, pb=3, ps=2

p = [4,1,2,3]

a = [7,2,5,6]

So, positions:

1 -> 4 -> 3 -> 2 -> 1 -> ...

So, it's a cycle of length 4: 1 -> 4 -> 3 -> 2 -> 1

Bodya starts at 3, Sasha starts at 2.

In the first turn:

- Bodya is at 3, gets a[3]=5, chooses to stay at 3 or move to p[3]=2.

- Sasha is at 2, gets a[2]=2, chooses to stay at 2 or move to p[2]=1.

In the second turn:

- If Bodya stayed at 3, gets a[3]=5 again.

- If Bodya moved to 2, gets a[2]=2.

- If Sasha stayed at 2, gets a[2]=2 again.

- If Sasha moved to 1, gets a[1]=7.

So, possible scores:

- Bodya: 5 + 5 = 10 (stay at 3), or 5 + 2 = 7 (move to 2)

- Sasha: 2 + 2 = 4 (stay at 2), or 2 + 7 = 9 (move to 1)

So, Bodya's maximum score is 10, Sasha's maximum score is 9. Bodya wins.

In this case, Bodya chose to stay at 3, getting a[3]=5 each turn, while Sasha chose to move to 1 and get a[1]=7 in the second turn.

Wait, but in the explanation, it says:

Turn | Bodya's position | Bodya's score | Bodya's move | Sasha's position | Sasha's score | Sasha's move

---|---|---|---|---|---|---

first | 3 | 0 + 5 = 5 | stays | 2 | 0 + 2 = 2 | moves to 1

second | 3 | 5 + 5 = 10 | stays | 1 | 2 + 7 = 9 | stays

So, Bodya stayed at 3 both turns, getting 5 + 5 = 10, Sasha moved to 1 in the first turn and stayed there in the second turn, getting 2 + 7 = 9.

Hence, Bodya wins.

But, could Sasha have done better? If Sasha had stayed at 2 in the first turn and moved to 1 in the second turn, their scores would be 2 + 7 = 9, same as before.

If Sasha moved to 1 in the first turn and then to 4 in the second turn, getting 2 + 7 + a[4]=6, but wait, no: in each turn, they add a[x] and then choose to stay or move.

So, in the first turn, Sasha is at 2, gets a[2]=2, chooses to move to p[2]=1.

In the second turn, Sasha is at 1, gets a[1]=7, chooses to stay at 1.

Total score: 2 + 7 = 9.

If Sasha had chosen to move to 1 in the first turn and then to 4 in the second turn:

- First turn: at 2, get a[2]=2, move to 1.

- Second turn: at 1, get a[1]=7, move to p[1]=4.

- Third turn: at 4, get a[4]=6, but k=2, so only two turns.

Wait, no, k=2 turns, so only two steps.

So, in the second turn, Sasha is at 1, gets a[1]=7, chooses to stay at 1 or move to p[1]=4.

If stays at 1, gets a[1]=7.

If moves to 4, gets a[4]=6.

So, better to stay at 1 and get 7.

Hence, total score: 2 (first turn) + 7 (second turn) = 9.

Similarly, if Sasha stays at 2 in the first turn and moves to 1 in the second turn: 2 + 7 = 9.

So, maximum score for Sasha is 9.

For Bodya:

- Stay at 3 in both turns: 5 + 5 = 10.

- Move to 2 in the first turn and stay at 2 in the second turn: 5 (first turn) + 2 (second turn) = 7.

- Move to 2 in the first turn and move to 1 in the second turn: 5 (first turn) + 2 (second turn) = 7.

- Stay at 3 in the first turn and move to 2 in the second turn: 5 (first turn) + 2 (second turn) = 7.

Hence, Bodya's maximum score is 10.

So, Bodya wins.

Now, in this example, Bodya has a position with a[3]=5, and Sasha has positions with a[2]=2 and a[1]=7.

Bodya can choose to stay at 3 and get 5 each turn, while Sasha can move to 1 and stay there to get 7 in the second turn.

But, in this case, Bodya's score is higher.

Now, in this specific case, since k=2 is small, it's manageable, but for k up to 1e9, I need a general approach.

Let me consider that for each player, the optimal strategy is to reach the position with the maximum a[x] in their accessible positions as soon as possible and then stay there for the remaining turns.

In the first example, for Bodya, the maximum a[x] in their cycle is a[3]=5, for Sasha, it's a[1]=7.

But, in reality, Bodya can get 10, while Sasha can get 9.

Wait, but according to my previous assumption, Sasha should get k * max_a = 2 * 7 = 14, but that's not possible because they can't reach a[1] in both turns starting from p_s=2.

Wait, perhaps I need to find, for each player, the maximum a[x] they can achieve per turn, considering the time it takes to reach that position.

But, in the first example, Sasha can reach a[1]=7 in one turn, but Bodya's maximum is a[3]=5.

But Bodya can stay at a[3]=5, while Sasha can get a[2]=2 in the first turn and a[1]=7 in the second turn, totaling 9, which is less than Bodya's 10.

Hence, Bodya wins.

Wait, but if Sasha could get a[1]=7 in both turns, that would be 14, but that's not possible because they can't be at position 1 in both turns unless they stay at 1.

But, to reach position 1 from position 2, they need to move in the first turn, then stay at 1 in the second turn.

Hence, their scores are 2 (first turn at 2) + 7 (second turn at 1) = 9.

Similarly, Bodya can stay at 3 and get 5 + 5 = 10.

Hence, Bodya wins.

So, perhaps for each player, the optimal strategy is to reach the best position in their cycle as soon as possible and then stay there for the remaining turns.

Hence, for each player, I need to find:

- The maximum a[x] in their cycle.

- The minimum number of turns required to reach that position.

Then, their total score would be: sum of a[x] for the turns taken to reach the best position, plus (k - t) * max_a, where t is the number of turns taken to reach the best position.

But, in the first example, for Sasha, t=1 to reach position 1, and k=2, so score = a[2] + a[1] = 2 + 7 = 9.

For Bodya, t=0 (since they start at position 3, which is not the best, but staying there gives a higher total than moving to other positions).

Wait, in Bodya's case, a[3]=5, a[2]=2, a[1]=7, a[4]=6.

Bodya starts at 3, can stay at 3 and get 5 each turn, or move to 2 and get 2 each turn.

But, moving to 2 would give only 5 + 2 = 7, which is less than staying at 3 and getting 5 + 5 = 10.

Hence, Bodya chooses to stay at 3.

For Sasha, starting at 2, can stay at 2 and get 2 + 2 = 4, or move to 1 and get 2 + 7 = 9.

Hence, Sasha chooses to move to 1 and stay there.

Hence, Bodya's score is 10, Sasha's score is 9.

Hence, Bodya wins.

So, generalizing, for each player, I need to find the maximum possible sum over k turns, given their choices to stay or move.

This seems similar to finding the maximum achievable score for each player independently.

Hence, perhaps I can model this as follows:

For each player, find the position with the maximum a[x] in their accessible positions.

Then, find the minimum number of turns required to reach that position.

Then, compute the sum as: sum of a[x] for each turn spent reaching the position, plus (k - t) * max_a, where t is the number of turns spent reaching the position.

But, in reality, the players might choose to stay at a position with a high a[x], even if it's not the maximum, if staying there gives a better total score.

In the first example, for Bodya, staying at 3 gives 5 + 5 = 10, which is higher than moving to 2 and getting 5 + 2 = 7.

For Sasha, moving to 1 and staying there gives 2 + 7 = 9, which is higher than staying at 2 and getting 2 + 2 = 4.

Hence, for each player, the optimal strategy is to choose to stay at the position with the maximum a[x] they can reach.

Hence, for each player, I need to find the position with the maximum a[x] in their cycle, and then decide to reach that position as soon as possible and stay there.

But, in some cases, staying at a position with a high a[x] but not the maximum might be better if the time to reach the maximum a[x] position is too long.

Wait, in the first example, Bodya chooses to stay at 3 (a[3]=5) instead of moving to 2 (a[2]=2) and then to 1 (a[1]=7), because moving would give only 5 + 2 in the first two turns, which is less than staying at 3 and getting 5 + 5.

Hence, for Bodya, staying at 3 is better.

Similarly, for Sasha, moving to 1 and staying there gives 2 + 7 = 9, which is better than staying at 2 and getting 2 + 2 = 4.

Hence, for Sasha, moving to 1 and staying there is better.

Hence, for each player, the strategy is to reach the position with the maximum a[x] as soon as possible and then stay there.

Hence, for each player, I need to find:

- The maximum a[x] in their accessible positions.

- The minimum number of turns required to reach that position from their starting position.

Then, their total score would be: sum of a[x] for each turn spent reaching the position, plus (k - t) * max_a, where t is the number of turns spent reaching the position.

But, in the first example, for Sasha, t=1 to reach position 1, and k=2, so score = a[2] + a[1] = 2 + 7 = 9.

For Bodya, t=0 (since a[3]=5 is not the maximum, but staying at 3 gives a higher total than moving to 2 and getting a[2]=2).

Wait, in Bodya's case, a[3]=5, which is not the maximum in the cycle (a[1]=7 is higher), but staying at 3 gives a higher total than moving to 2 and getting a[2]=2.

Hence, in this case, Bodya chooses to stay at 3.

Hence, perhaps for each player, I need to consider both options: staying at the current position or moving to the next one, and choose the one that maximizes the total score.

This seems too time-consuming for large k.

Is there a better way?

Let me consider that in each turn, the player can choose to stay at their current position or move to p[x].

Hence, for each turn, the player has two choices: stay and get a[x], or move to p[x] and get a[p[x]] in the next turn.

Wait, no: in each turn, they first add a[x], then choose to stay or move.

So, if they stay, next turn they are still at x and get a[x] again.

If they move, next turn they are at p[x] and get a[p[x]].

Hence, for each turn, the player's score increases by a[x], and then they choose to stay at x or move to p[x].

Hence, for each player, their sequence of positions over k turns is determined by their choices to stay or move each turn.

Given that, for each player, I need to find the maximum possible sum of a[x] over