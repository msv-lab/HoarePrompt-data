Alright, I have this problem to solve. Let me read it carefully.

There are n children in a class, and m pairs among them are friends with a friendship value f_i. The teacher goes on k excursions, and for each excursion, she chooses a pair of children randomly and equiprobably. If the chosen pair are friends, their friendship value increases by 1 for all subsequent excursions. Pairs who are not friends have a friendship value of 0 that doesn't change.

I need to find the expected value of the sum of friendship values of all k pairs chosen for the excursions, and express it as p/q where p and q are coprime, and then compute p * q^{-1} mod (10^9 + 7).

First, I need to understand the problem.

There are n children, and m pairs of friends with given friendship values. The teacher chooses k pairs randomly, and for each chosen pair that are friends, their friendship value increases by 1 for all subsequent excursions.

I need to find the expected sum of the friendship values at the time of choosing each pair.

Let me try to rephrase this.

At each excursion, a pair is chosen randomly. If they are friends, their friendship value increases by 1 for all future excursions. Non-friend pairs have a friendship value of 0 that never changes.

I need the expected sum of the friendship values at the time of choosing, over all k excursions.

Let me think about a small example.

Take n=2, m=1, k=2.

Pairs: (1,2) with f=1.

Possible sequences:

1. Choose (1,2) both times.

First choice: f=1.

Second choice: f=2 (since it increased by 1 after the first choice).

Sum: 1 + 2 = 3.

2. Choose (1,2) first, then another pair.

But since n=2, the only other pair is (2,1), which is the same as (1,2). So only one unique pair.

Wait, in this case, there's only one unique pair, but the problem allows choosing the same pair multiple times, independently.

Wait, the problem says "the teacher can choose a pair of children more than once."

So, in this case, only one pair exists, and it's chosen both times.

Then, the sum is 1 + 2 = 3.

But according to the sample input, for n=2, m=1, k=10, with f=1, the output is 55.

Wait, in that case, it's choosing the same pair every time, and the friendship value increases by 1 each time it's chosen.

So, sum = 1 + 2 + 3 + ... + 10 = 55.

Yes, that matches.

So, in this specific case where there's only one pair, it's straightforward.

But in general, there are multiple pairs, some are friends with initial friendship values, and some are not friends with friendship value 0.

I need to find the expected sum of friendship values over k choices.

Let me think about how to approach this.

First, I need to model how the friendship values change over time based on which pairs are chosen.

But this seems complicated because the choices are independent, but the friendship values depend on how many times a friend pair has been chosen before.

Wait, no, the problem says: "the teacher chooses a pair of children randomly, equiprobably and independently."

But if a pair who are friends are chosen, their friendship value increases by 1 for all subsequent excursions.

So, the choices are independent, but the friendship values depend on the history of choices.

This seems tricky.

Wait, perhaps I can think in terms of linearity of expectation.

Each chosen pair contributes its friendship value at the time of choice to the total sum.

I need to compute the expected value of the sum of these contributions over k excursions.

So, E[sum] = sum_{t=1 to k} E[f_t], where f_t is the friendship value of the pair chosen at time t.

Now, the issue is that f_t depends on how many times the same pair has been chosen before.

Wait, but the problem allows choosing any pair independently, so the choices are with replacement.

This seems complex because the friendship values can increase over time based on how many times a friend pair is chosen.

I need a better way to model this.

Let me consider that for each friend pair, their friendship value starts at f_i and increases by 1 each time they are chosen.

Non-friend pairs have friendship value 0 and never change.

So, for each friend pair, their contribution to the total sum depends on how many times they are chosen, and when they are chosen.

Wait, perhaps I can think about each friend pair independently, and compute their expected contribution to the total sum.

Then, by linearity of expectation, sum over all friend pairs of their expected contribution.

Also, add the expected contribution from non-friend pairs, which is 0.

Wait, non-friend pairs have friendship value 0 and don't change, so their expected contribution is 0.

So, I only need to consider the friend pairs.

So, total expected sum = sum over friend pairs of their expected contribution.

Now, for each friend pair, their expected contribution is equal to their initial friendship value f_i multiplied by the expected number of times they are chosen, plus the expected sum of the increments.

Wait, no.

Wait, each time a friend pair is chosen, their friendship value increases by 1 for all subsequent choices.

But the problem says: "if a pair of children who are friends is chosen, their friendship value increases by 1 for all subsequent excursions."

So, the increase happens after the choice, affecting future choices.

But for the sum, we are to consider the friendship value at the time of choosing.

So, for each choice, the friendship value is f_i plus the number of times this pair has been chosen before.

Wait, yes.

So, for each friend pair, their contribution to the sum is equal to (f_i + number of times they have been chosen before), each time they are chosen.

So, their total contribution is f_i * number of times chosen + sum_{t=1 to number of times chosen} (t-1).

Wait, perhaps it's better to model it as f_i * number of times chosen + (number of times chosen) * (number of times chosen - 1)/2.

Because each time they are chosen, their friendship value increases by the number of times they have been chosen before.

Wait, let's think carefully.

Let me denote for a friend pair j, let x_j be the number of times it is chosen in the k excursions.

Then, the total contribution of pair j to the sum is sum over each time it is chosen of (f_j + number of times chosen before that time).

So, if it's chosen x_j times, the first time its contribution is f_j + 0, second time f_j +1, third time f_j +2, and so on up to f_j + (x_j -1).

So, total contribution is sum_{m=0 to x_j-1} (f_j + m) = x_j * f_j + sum_{m=0 to x_j-1} m = x_j * f_j + (x_j * (x_j -1))/2.

So, for each friend pair j, total contribution is x_j * f_j + (x_j * (x_j -1))/2.

Therefore, the total sum S = sum over j=1 to m of [x_j * f_j + (x_j * (x_j -1))/2].

And we need to find the expected value of S.

Now, since expectation is linear, E[S] = sum over j=1 to m of [E[x_j * f_j] + E[(x_j * (x_j -1))/2]].

Now, E[x_j * f_j] = f_j * E[x_j], and E[(x_j * (x_j -1))/2)] = (E[x_j*(x_j -1)])/2.

So, E[S] = sum over j=1 to m of [f_j * E[x_j] + (E[x_j*(x_j -1)])/2)].

Now, I need to find E[x_j] and E[x_j*(x_j -1)] for each friend pair j.

Given that each pair is chosen with equal probability, and choices are independent.

Total number of possible pairs is C(n,2) = n*(n-1)/2.

So, probability of choosing a particular friend pair j in one excursion is p_j = 1 / C(n,2).

Wait, but actually, the pairs are chosen equiprobably, so each possible pair has the same probability.

But in the input, m friend pairs are given, and the rest are non-friend pairs with friendship value 0.

But for the choice, all possible pairs are chosen equiprobably, including non-friend pairs.

Wait, but the friendship value increases only if the chosen pair is a friend pair.

So, for each friend pair j, the probability of choosing it in one excursion is p_j = 1 / C(n,2).

Then, x_j follows a binomial distribution with parameters k and p_j.

So, E[x_j] = k * p_j = k / C(n,2).

Similarly, E[x_j*(x_j -1)] = k*(k-1)*p_j^2.

Because for binomial, E[x(x-1)] = k*(k-1)*p^2.

So, plugging back, E[S] = sum over j=1 to m of [f_j * (k / C(n,2)) + (k*(k-1)/ C(n,2)^2)/2)].

Wait, no.

Wait, E[S] = sum over j=1 to m of [f_j * E[x_j] + E[(x_j*(x_j -1))/2]].

We have E[x_j] = k * p_j = k / C(n,2).

And E[x_j*(x_j -1)] = k*(k-1)*p_j^2.

So, E[(x_j*(x_j -1))/2] = (k*(k-1)*p_j^2)/2.

Therefore, E[S] = sum over j=1 to m of [f_j * (k / C(n,2)) + (k*(k-1)*p_j^2)/2)].

Now, p_j = 1 / C(n,2), so p_j^2 = 1 / C(n,2)^2.

Therefore, E[S] = sum over j=1 to m of [f_j * (k / C(n,2)) + (k*(k-1)/ (2 * C(n,2)^2))].

Now, sum over j=1 to m of f_j * (k / C(n,2)) = (k / C(n,2)) * sum over j=1 to m f_j.

Let me denote S_f = sum over j=1 to m f_j.

Similarly, sum over j=1 to m of (k*(k-1)/ (2 * C(n,2)^2)) = m * (k*(k-1)/ (2 * C(n,2)^2)).

Therefore, E[S] = (k / C(n,2)) * S_f + m * (k*(k-1)/ (2 * C(n,2)^2)).

Now, C(n,2) = n*(n-1)/2.

So, E[S] = (k / (n*(n-1)/2)) * S_f + m * (k*(k-1)/ (2 * (n*(n-1)/2)^2)).

Simplify:

E[S] = (2k / (n*(n-1))) * S_f + m * (k*(k-1)/ (2 * (n*(n-1)/2)^2)).

Simplify further:

E[S] = (2k / (n*(n-1))) * S_f + m * (k*(k-1)/ (2 * (n*(n-1)/2)^2)).

Simplify the denominator in the second term:

(n*(n-1)/2)^2 = n^2 * (n-1)^2 / 4.

So, E[S] = (2k / (n*(n-1))) * S_f + m * (k*(k-1)/ (2 * (n^2 * (n-1)^2 / 4))).

Simplify the second term:

k*(k-1)/ (2 * (n^2 * (n-1)^2 / 4)) = k*(k-1)/ ( (n^2 * (n-1)^2)/4 ) * (1/2) = k*(k-1)/ ( (n^2 * (n-1)^2)/4 ) * (1/2) = k*(k-1)*4 / (2 * n^2 * (n-1)^2) = (2*k*(k-1)) / (n^2 * (n-1)^2).

So, E[S] = (2k / (n*(n-1))) * S_f + m * (2*k*(k-1)) / (n^2 * (n-1)^2).

Now, I need to compute this expression modulo (10^9 +7), after expressing it as p/q with p and q coprime, and then p * q^{-1} mod (10^9 +7).

This seems a bit involved, but I think I can compute it step by step.

First, compute C = n*(n-1)/2.

Then, compute inv_C = 1/C modulo (10^9 +7).

Wait, but C could be up to 10^{10}, which is beyond the modulo, so I need to compute the modular inverse of C modulo (10^9 +7).

But (10^9 +7) is a prime, so I can compute inv_C = pow(C, mod-2, mod).

Similarly, I need to compute inv_C2 = 1/(C^2) modulo (10^9 +7), which is pow(C, 2*(mod-2), mod).

Wait, no, inv_C2 = inv_C^2 modulo mod.

So, inv_C2 = pow(C, 2*(mod-2), mod).

But actually, since inv_C = pow(C, mod-2, mod), then inv_C2 = pow(C, 2*(mod-2), mod).

But it's easier to compute inv_C2 = (inv_C * inv_C) % mod.

So, proceed step by step.

Compute C = n*(n-1)//2.

Compute inv_C = pow(C, mod-2, mod).

Compute inv_C2 = (inv_C * inv_C) % mod.

Then, compute S_f = sum of f_j for j=1 to m.

Then, the first term is (2k / (n*(n-1))) * S_f = (2k * inv_C) * S_f.

But 2k / (n*(n-1)) = 2k * inv_C.

Wait, but n*(n-1) = 2*C, so 2k / (2*C) = k / C.

Wait, earlier I had 2k / (n*(n-1)) = 2k / (2*C) = k / C.

So, the first term is (k / C) * S_f = k * inv_C * S_f.

The second term is m * (2*k*(k-1)) / (n^2 * (n-1)^2) = m * 2*k*(k-1) / ((n*(n-1))^2) = m * 2*k*(k-1) / (4*C^2) = m * 2*k*(k-1) / (4*C^2) = m * k*(k-1) / (2*C^2).

Wait, but earlier I had E[S] = (2k / (n*(n-1))) * S_f + m * (2*k*(k-1)) / (n^2 * (n-1)^2).

And n*(n-1) = 2*C, and n^2*(n-1)^2 = 4*C^2.

So, E[S] = (2k / (2*C)) * S_f + m * (2*k*(k-1)) / (4*C^2) = (k / C) * S_f + m * (k*(k-1)) / (2*C^2).

So, E[S] = k * inv_C * S_f + m * k*(k-1) * inv_C2 / 2.

But need to handle division by 2 modulo (10^9 +7).

Since (10^9 +7) is odd, 2 has an inverse modulo (10^9 +7), which is (10^9 +7 +1)//2 = 500000004.

So, 1/2 modulo (10^9 +7) is 500000004.

So, E[S] = k * inv_C * S_f + m * k * (k-1) * inv_C2 * 500000004 % mod.

Now, I need to compute this expression modulo (10^9 +7).

I need to make sure that all operations are done modulo (10^9 +7).

Also, need to handle large exponents in pow, but since (10^9 +7) is prime, it should be fine.

Let me try to implement this step by step.

First, read t, the number of test cases.

Then, for each test case:

Read n, m, k.

Read m lines, each with a_i, b_i, f_i.

Compute C = n*(n-1)//2.

Compute inv_C = pow(C, mod-2, mod).

Compute inv_C2 = (inv_C * inv_C) % mod.

Compute S_f = sum of f_i for i=1 to m.

Compute first_term = (k * inv_C * S_f) % mod.

Compute second_term = (m * k * (k-1) * inv_C2 * 500000004) % mod.

Compute E[S] = (first_term + second_term) % mod.

Print E[S].

Now, check if this matches the sample input and output.

Sample Input:

4

100 0 24

2 1 10

1 2 1

3 1 2

2 1 1

5 2 4

1 2 25

3 2 24

Sample Output:

0

55

777777784

40000020

Let's verify the first test case:

n=100, m=0, k=24

C = 100*99//2 = 4950

inv_C = pow(4950, 1000000006, 1000000007)

S_f = 0

first_term = 24 * inv_C * 0 = 0

second_term = 0 * 24 * 23 * inv_C2 * 500000004 = 0

So, E[S] = 0, which matches the sample output.

Second test case:

n=2, m=1, k=10

Pair: 1 2 1

C = 1

inv_C = 1

S_f = 1

first_term = 10 * 1 * 1 = 10

second_term = 1 * 10 * 9 * 1 * 1 * 500000004 = 90 * 500000004 % 1000000007

But 90 * 500000004 = 45000000360 % 1000000007 = 45000000360 - 45*1000000007 = 45000000360 - 45000000315 = 545

Wait, that doesn't seem right. But according to the sample, it should be 55.

Wait, perhaps I made a mistake in the formula.

Wait, in the second term, it's m * k * (k-1) * inv_C2 * 500000004.

In this case, m=1, k=10, k-1=9, inv_C2=1, so second_term = 1 * 10 * 9 * 1 * 500000004 = 90 * 500000004.

But 90 * 500000004 = 45000000360.

Now, 45000000360 mod 1000000007.

Compute 1000000007 * 45 = 45000000315.

45000000360 - 45000000315 = 45.

So, second_term = 45.

Then, E[S] = first_term + second_term = 10 + 45 = 55, which matches the sample output.

Good.

Third test case:

n=3, m=1, k=2

Pair: 2 1 1

C = 3

inv_C = pow(3, 1000000006, 1000000007) = 333333336

S_f =1

first_term = 2 * 333333336 *1 = 666666672

second_term =1 *2*1 *333333336*333333336*500000004

Compute 333333336 *333333336 = 111111111555555556 % 1000000007 = 111111111555555556 - 111111111*1000000007 = 111111111555555556 - 111111111777777777 = -222222221 mod 1000000007 = 1000000007 - 222222221 = 777777786

Then, second_term =1 *2*1 *777777786*500000