Alright, I've got this problem to solve. Let's see what it's asking for. There are n children in a class, and m pairs among them are friends with some friendship value f_i. The teacher goes on k excursions, and for each excursion, she randomly chooses a pair of children equiprobably and independently. If the chosen pair are friends, their friendship value increases by 1 for all subsequent excursions. Pairs who are not friends have a friendship value of 0, which never changes.

I need to find the expected value of the sum of friendship values of all k pairs chosen during the excursions, considering that friendship values can increase over time.

First, I need to understand how the friendship values change over time. Let's consider that for each excursion, a pair is chosen randomly, and if they are friends, their friendship value increases by 1 for all future excursions.

This sounds like a dynamic process where the friendship values can grow as more excursions happen. I need to calculate the expected sum of the friendship values at the time each pair is chosen.

Let me try to model this.

Let’s denote the set of friend pairs as F, where each pair has an initial friendship value f_i.

Total possible pairs are n choose 2, which is n*(n-1)/2.

The probability of choosing any specific pair is 2/(n*(n-1)) because there are n*(n-1)/2 pairs, and each pair is equally likely to be chosen.

Wait, actually, the probability of choosing a specific pair is 1/(C(n,2)) = 2/(n*(n-1)), but since C(n,2) = n*(n-1)/2, the probability is 1/(n*(n-1)/2) = 2/(n*(n-1)).

But in the code provided, there's a line `c = pow(n * (n - 1) // 1, -1, M)`. Wait, n*(n-1)//1 is just n*(n-1), so c is the modular inverse of n*(n-1) modulo 10^9+7.

Hmm, but in probability terms, the factor should involve C(n,2), which is n*(n-1)/2, so the probability of choosing a specific pair is 1/(n*(n-1)/2). But in the code, c is set to the inverse of n*(n-1), not divided by 2.

Wait, perhaps there's a mistake here.

Let me double-check.

C(n,2) = n*(n-1)/2.

So, probability of choosing a specific pair is 1/(C(n,2)) = 2/(n*(n-1)).

But in the code, c is set to the inverse of n*(n-1) modulo 10^9+7, which is equivalent to (n*(n-1))^{-1} mod 10^9+7.

Wait, but in the formula, if I need 2/(n*(n-1)), that would be 2 * (n*(n-1))^{-1}.

But in the code, c is set to pow(n*(n-1)//1, -1, M), which is pow(n*(n-1), -1, M), which is (n*(n-1))^{-1} mod M.

But in the formula, I need 2/(n*(n-1)), which is 2 * (n*(n-1))^{-1}.

So, the code should have c = 2 * pow(n*(n-1), -1, M), but it doesn't have the multiplication by 2.

This might be a mistake.

Wait, perhaps the author intended to calculate 1/C(n,2), which is 2/(n*(n-1)), but implemented it incorrectly.

This could be a problem.

Let me see further.

The code then calculates s, which seems to accumulate some sum over k excursions.

There's a loop that runs m times to read the friend pairs and sum their initial friendship values into variable a.

Then, there's a loop that runs k times, and in each iteration, it adds to s: c * i * c * m + c * a.

Wait, this looks suspicious.

Let's think about what the expected sum should be.

I need to find the expected sum of friendship values for each of the k excursions.

Let's think about the expected friendship value for a single excursion.

For a single excursion, the teacher chooses a pair randomly.

If the pair is a friend pair, their friendship value is f_i plus the number of times this pair was chosen in previous excursions.

Wait, but the problem says: "If a pair of children who are friends have a friendship value of f_i. If they are chosen, their friendship value increases by 1 for all subsequent excursions."

So, for each excursion, when a pair is chosen, if they are friends, their f_i increases by 1 for all future excursions.

But the sum we need is the sum of their friendship values at the time they are chosen.

So, for each excursion, whatever pair is chosen, we add their friendship value at that moment.

Since the friendship values can increase over time, this is a bit tricky.

I need to model how the friendship values evolve over the k excursions.

Let me try to think differently.

Let’s consider that for each friend pair, their friendship value starts at f_i and increases by 1 each time they are chosen.

But since the choices are independent and random, I need to find the expected number of times each pair is chosen across the k excursions.

Wait, but because the choices are independent and random, the expected number of times a specific pair is chosen in k excursions is k * (1/C(n,2)).

But, since the friendship value increases by 1 each time they are chosen, their friendship value after k excursions would be f_i plus the number of times they were chosen.

But, I need the sum of their friendship values at the time they were chosen.

This seems complicated.

Maybe I should think in terms of the contribution of each friend pair to the total sum.

For each friend pair, their contribution to the total sum depends on when they are chosen.

If they are chosen in excursion t, their friendship value at that time is f_i plus the number of times they were chosen before that.

Wait, but since each choice is independent, it's tricky to model.

Perhaps it's better to think in terms of linearity of expectation.

Let me consider each excursion independently and find the expected friendship value for that excursion, then sum them up.

For each excursion, the expected friendship value is the sum over all possible pairs of the probability of choosing that pair multiplied by their friendship value at that excursion.

But since the choices are independent, this might not be straightforward.

Wait, but the problem says that the teacher chooses a pair equiprobably and independently each time.

So, for each excursion, the pair is chosen independently of previous excursions.

This means that for each excursion, the friendship value of a pair depends on how many times that pair was chosen in previous excursions.

But because of the independence, maybe I can model this recursively or find a closed-form formula.

This seems complex.

Let me look at the example provided.

In the second test case:

n=2, m=1, k=10

Friend pair: (1,2) with f_i=1

Since n=2, there's only one possible pair, which is (1,2).

So, in each excursion, this pair is always chosen.

Therefore, their friendship value starts at 1 and increases by 1 each time they are chosen.

So, in excursion 1, f=1, after choosing, f becomes 2.

In excursion 2, f=2, after choosing, f becomes 3, and so on.

So, the sum of friendship values over 10 excursions is 1+2+3+...+10 = 55, which matches the sample output.

Wait, but in this case, since there's only one pair, and it's always chosen, the friendship value increases by 1 each time.

So, the sum is the sum of an arithmetic series from 1 to k.

But in general, with multiple pairs and m friend pairs, it's more complicated.

Wait, perhaps I can model the expected increase in friendship values.

Let’s think about it differently.

Let’s consider that for each friend pair, their friendship value starts at f_i and increases by 1 each time they are chosen.

But since choices are independent, the expected increase in their friendship value per excursion is equal to the probability of choosing that pair.

So, for each friend pair, the expected number of times they are chosen in k excursions is k / C(n,2).

Therefore, their friendship value after k excursions would be f_i plus the expected number of times they are chosen, which is k / C(n,2).

But since the choices are independent, the friendship value at the time of choosing in each excursion can be considered accordingly.

Wait, perhaps I should think in terms of the expected value for each excursion and sum them up.

For each excursion, the expected friendship value is the sum over all friend pairs of the probability of choosing that pair multiplied by their friendship value at that excursion.

But since the friendship value increases by 1 each time the pair is chosen, it's like a self-increasing expectation, which is tricky.

Maybe I need to model this recursively.

Let me denote E_t as the expected sum of friendship values after t excursions.

Then, E_t = E_{t-1} + expected friendship value of the t-th excursion.

But this seems circular.

Alternatively, perhaps I can think of the total sum as the sum of expected friendship values for each excursion, and since excursions are independent, I can sum them up.

But the friendship values depend on previous excursions, so they are not independent.

This is confusing.

Let me try to find a pattern with small values.

Suppose n=2, m=1, k=2.

Only one friend pair, (1,2), with f_i=1.

In excursion 1:

- Choose the pair, friendship value =1, then increase to 2 for future excursions.

In excursion 2:

- Choose the pair again, friendship value =2.

Total sum:1 + 2=3.

Another scenario:

- In excursion 1: choose the pair, f=1, increase to 2.

- In excursion 2: choose the pair, f=2.

Total sum:1+2=3.

Since there's only one pair, it's always chosen, so sum is 1+2=3, which matches the arithmetic series sum.

Generalizing, for k excursions, sum is 1+2+3+...+k = k(k+1)/2.

Which aligns with the sample input where k=10, sum=55.

But in general, with multiple pairs, it's different.

Wait, in the third test case:

n=3, m=1, k=2

Friend pair: (2,1) with f_i=1

Total possible pairs: C(3,2)=3.

So, probability of choosing the friend pair in each excursion is 1/3.

Expected friendship value for each excursion:

- With probability 1/3: choose the friend pair, friendship value = current f_i.

- With probability 2/3: choose non-friend pair, friendship value=0.

But since the friendship value increases by 1 each time the friend pair is chosen, it's dynamic.

Let’s compute for k=2.

First excursion:

- Choose friend pair with prob 1/3, f=1, then f becomes 2 for the second excursion.

- Choose non-friend pair with prob 2/3, f=0, f remains 1 for the second excursion.

Second excursion:

- If friend pair was chosen first, f=2, choose again with prob 1/3, f=2, and choose non-friend with prob 2/3, f=0.

- If non-friend was chosen first, f=1, choose friend pair with prob 1/3, f=1, and choose non-friend with prob 2/3, f=0.

So, total expected sum:

- Case 1: choose friend pair both times: prob (1/3)*(1/3), sum=1+2=3

- Case 2: choose friend pair first, non-friend second: prob (1/3)*(2/3), sum=1+0=1

- Case 3: choose non-friend first, friend pair second: prob (2/3)*(1/3), sum=0+1=1

- Case 4: choose non-friend both times: prob (2/3)*(2/3), sum=0+0=0

So, expected sum = (1/9)*3 + (2/9)*1 + (2/9)*1 + (4/9)*0 = 3/9 + 2/9 + 2/9 + 0 = 7/9

Which should be 777,777,784 mod 10^9+7, as per the sample output.

Okay, so in this small case, it works.

Now, how to generalize this for larger n, m, and k.

It seems too time-consuming to model all possible sequences.

I need a smarter approach.

Let me consider that for each friend pair, their contribution to the total sum is equal to their friendship value multiplied by the number of times they are chosen.

But since their friendship value increases by 1 each time they are chosen, it's like a geometric series.

Wait, perhaps I can model the expected sum for each friend pair separately and then sum them up due to linearity of expectation.

Wait, but the friendship values are interdependent because choosing one pair affects its own friendship value but not others directly.

Wait, actually, since only the chosen pair's friendship value increases, and different pairs are independent in terms of their friendship value changes.

So, perhaps I can model the expected sum by summing over the expected contribution of each friend pair across all excursions.

Let me try that.

For each friend pair j with initial friendship value f_j, let's find its expected contribution to the total sum.

The expected contribution of pair j is the expected sum of its friendship value over all the excursions in which it is chosen.

Since its friendship value increases by 1 each time it is chosen, its friendship value at the time of being chosen for the t-th time is f_j + (t-1).

Wait, perhaps it's better to think in terms of the number of times it's chosen.

Let’s denote X_j as the number of times pair j is chosen in k excursions.

Then, the total friendship value contributed by pair j is sum from t=1 to X_j of (f_j + (t-1)).

This simplifies to X_j * f_j + (X_j * (X_j - 1)) / 2.

So, the expected contribution of pair j is E[X_j * f_j + X_j * (X_j - 1)/2].

Since X_j follows a binomial distribution with parameters k and p_j, where p_j is the probability of choosing pair j in a single excursion.

Given that, E[X_j] = k * p_j and E[X_j^2] = k * p_j * (1 - p_j) + (k * p_j)^2.

So, E[X_j^2] = k * p_j * (1 - p_j) + k^2 * p_j^2.

Therefore, E[X_j * f_j + X_j * (X_j - 1)/2] = f_j * E[X_j] + E[X_j^2]/2 - E[X_j]/2.

Substituting E[X_j] and E[X_j^2]:

= f_j * k * p_j + [k * p_j * (1 - p_j) + k^2 * p_j^2]/2 - k * p_j / 2

Simplify:

= k * f_j * p_j + (k * p_j * (1 - p_j) + k^2 * p_j^2)/2 - k * p_j / 2

= k * f_j * p_j + (k * p_j * (1 - p_j))/2 + (k^2 * p_j^2)/2 - k * p_j / 2

This seems messy.

Maybe there's a better way.

Alternatively, perhaps I can think of the total expected sum as k times the expected friendship value of a single excursion.

But since the friendship values change over time, this might not hold.

Wait, perhaps I can model the expected friendship value for each excursion and sum them up.

For the first excursion, the expected friendship value is sum over all friend pairs of p_j * f_j, where p_j is the probability of choosing pair j.

For the second excursion, it's similar, but now the friendship value of each friend pair that was chosen in the first excursion is increased by 1.

But because the choices are independent, it's like each excursion is choosing a pair independently, and if it's a friend pair, their friendship value increases by 1 for all future excursions.

Wait, but independence implies that the choices don't affect each other, which they do because choosing a friend pair increases its friendship value for future excursions.

This is confusing.

Let me try to think recursively.

Let’s denote E_k as the expected sum of friendship values over k excursions.

Then, E_k = E_{k-1} + expected friendship value of the k-th excursion.

But I need to find a way to compute this recursively.

Alternatively, perhaps I can model this as a Markov chain, where the state is the current friendship values of all pairs, but that seems too complex.

Given the constraints, with sum of k up to 2*10^5 and m up to 10^5 per test case, I need an efficient solution.

Looking back at the provided code:

def func():

for i in range(int(input())):

(n, m, k) = map(int, input().split())

M = 10 ** 9 + 7

c = pow(n * (n - 1) // 1, -1, M)

s = 0

a = 0

for i in range(m):

(u, v, f) = map(int, input().split())

a += f

for i in range(k):

s = s + c * i * c * m + c * a

print(s % M)

It seems to be trying to calculate s as the sum over k excursions of some expression involving c and a.

Here, c is set to the modular inverse of n*(n-1) modulo 10^9+7.

But as I thought earlier, it should be the inverse of C(n,2), which is n*(n-1)/2, so it should be 2 * pow(n*(n-1), -1, M).

But the code doesn't have that multiplication by 2.

This might be a mistake.

Moreover, in the loop, s is being updated as s + c * i * c * m + c * a.

This seems arbitrary and not aligned with any formula I can think of.

I think the code is incorrect.

Let me try to derive the correct formula.

From earlier thoughts, for each friend pair j, its expected contribution to the total sum is E[X_j * f_j + X_j * (X_j - 1)/2], where X_j is the number of times pair j is chosen.

But this seems too complicated to compute directly.

An alternative approach is to consider that for each excursion, the expected friendship value is the sum over all friend pairs of p_j * (f_j + number of times pair j was chosen before the current excursion).

But since the choices are independent, the number of times pair j was chosen in previous excursions follows a binomial distribution.

This still seems too involved.

Wait, perhaps I can consider that for each friend pair j, the expected sum of its friendship value over all excursions where it is chosen can be calculated separately and then summed over all friend pairs.

Given that, for a single friend pair j with initial friendship value f_j and probability p_j of being chosen in each excursion, the expected sum of its friendship value over all excursions where it is chosen can be calculated as follows:

Let X_j be the number of times pair j is chosen in k excursions.

Then, the total friendship value contributed by pair j is sum_{t=1 to X_j} (f_j + (t - 1)).

This simplifies to X_j * f_j + (X_j * (X_j - 1))/2.

So, the expected contribution is E[X_j * f_j + X_j * (X_j - 1)/2] = f_j * E[X_j] + E[X_j^2]/2 - E[X_j]/2.

Given that X_j ~ Binomial(k, p_j), we have E[X_j] = k * p_j and E[X_j^2] = k * p_j * (1 - p_j) + (k * p_j)^2.

Substituting:

Expected contribution = f_j * k * p_j + [k * p_j * (1 -