Alright, I've got this problem to solve. Let's see what it's asking for. Monocarp has n friends, and he wants at least 2 of them to come to his party. Each friend has a best friend, and the best friends are specified in this list p, where p_i is the best friend of the i-th friend. The conditions are a bit tricky, so I need to understand them carefully.

First, all p_i are distinct, and no p_i equals i, which makes sense because no one is their own best friend. That's good to know.

Now, when Monocarp sends invitations, he sends them to specific friends. A friend i will come to the party only if both they and their best friend p_i receive an invitation. Importantly, the best friend doesn't have to come; they just need to have received an invitation.

The goal is to minimize the number of invitations sent, but ensure that at least 2 friends come to the party.

Let me try to rephrase this to make sure I get it. So, for a friend to attend, both they and their best friend must be invited. But their best friend might not attend unless their best friend also receives an invitation, which could create a chain, but the problem seems to suggest that only the direct best friend relationship matters for attendance, not further down the line.

Let me look at the example to understand better.

In the first test case:

n = 5

p = [3, 1, 2, 5, 4]

Monocarp sends invitations to [1, 2, 4, 5]

Then, friends [2, 4, 5] will come.

- Friend 1: invited, but best friend is 3, who is also invited. However, friend 3 is not invited, wait, no, friend 3 is invited because 2 is invited, but friend 3's best friend is 2, who is invited. But friend 3 is not coming because they are not invited themselves. Wait, the explanation says friend 1 won't come because his best friend didn't receive an invitation, but in this case, friend 1's best friend is 3, who is invited. So why isn't friend 1 coming? Oh, maybe because friend 1 needs both themselves and their best friend to be invited, but in this scenario, friend 1 is invited, and friend 3 is invited, so friend 1 should come. But according to the example, friend 1 doesn't come. Hmm, maybe I'm misunderstanding.

Wait, the example says: "The friend 1 won't come since his best friend didn't receive an invitation; the friend 3 won't come since he didn't receive an invitation."

Wait, but in the invitation list, friend 3 is invited. Wait, no, in the invitation list [1, 2, 4, 5], friend 3 is not invited. Wait, maybe I misread. Let's check again.

n = 5

p = [3, 1, 2, 5, 4]

So, friend 1's best friend is 3

friend 2's best friend is 1

friend 3's best friend is 2

friend 4's best friend is 5

friend 5's best friend is 4

Monocarp sends invitations to [1, 2, 4, 5]

So, friend 1 is invited, and their best friend 3 is not invited, so friend 1 doesn't come.

friend 2 is invited, and their best friend 1 is invited, so friend 2 comes.

friend 3 is not invited, so friend 3 doesn't come.

friend 4 is invited, and their best friend 5 is invited, so friend 4 comes.

friend 5 is invited, and their best friend 4 is invited, so friend 5 comes.

So, friends 2, 4, and 5 come to the party.

Wait, but the example says only friends 2, 4, 5 will come, which matches this.

So, in this case, sending invitations to 4 people results in 3 friends coming, but the minimal number is what we need to find.

The example says that sending invitations to friends [4,5] would make friends [4,5] come, but actually, in this case, since p_4 = 5 and p_5 = 4, both are invited, so both would come. Wait, but the example says that sending invitations to [4,5] would make [2,4,5] come, which doesn't make sense because friend 2 is not invited.

Wait, perhaps I'm misunderstanding the problem.

Wait, no, in the example, when invitations are sent to [1,2,4,5], friends [2,4,5] come. But in the minimal case, sending invitations to [4,5] should make [4,5] come, since they are each other's best friends and both are invited.

Wait, but according to the problem statement, for friend i to come, both i and p_i must be invited. So, in the case of sending invitations to [4,5], both are invited, and p_4 = 5 is invited, p_5 = 4 is invited, so both should come.

So, perhaps the minimal number is 2 in this case.

But the problem says that in this test case, the answer is 2.

In the second test case:

n = 4

p = [2,3,4,1]

The answer is 3.

In the third test case:

n = 2

p = [2,1]

The answer is 2.

So, seems like in some cases, the minimal number is 2, in others, it's 3.

I need to find a general way to determine the minimal number of invitations needed to ensure at least 2 friends come.

Let me think about the structure of the problem.

Given that p_i are distinct and p_i != i, the mapping from i to p_i is a permutation without fixed points.

In permutation theory, such a permutation is a derangement.

So, p is a derangement of [1,2,...,n].

In such a derangement, we can have cycles of various lengths.

For example, in the first test case:

1 -> 3 -> 2 -> 1 (cycle of length 3)

4 -> 5 -> 4 (cycle of length 2)

So, we have a 3-cycle and a 2-cycle.

In the second test case:

1 -> 2 -> 3 -> 4 -> 1 (single 4-cycle)

In the third test case:

1 -> 2 -> 1 (2-cycle)

So, derangements can be decomposed into disjoint cycles.

Now, in terms of sending invitations, I need to ensure that at least 2 friends come, and for a friend to come, both they and their best friend must be invited.

Given the cycle structure, perhaps there is a way to exploit the cycles to minimize the number of invitations.

Let me consider the cycles separately.

First, consider a 2-cycle: a -> b -> a

In this case, if I invite both a and b, then both will come, because each and their best friend are invited.

Alternatively, if I invite only one of them, say a, then a's best friend b is invited only if b is invited, which in this case, b is not invited, so a doesn't come. Similarly, if I invite only b, a doesn't come, and b's best friend a is not invited, so b doesn't come.

Therefore, to get at least one friend from this 2-cycle to come, I need to invite both a and b.

But since I need at least 2 friends to come, and this 2-cycle can provide 2 friends, inviting both a and b would suffice.

Now, consider a 3-cycle: a -> b -> c -> a

In this case, to get a to come, I need to invite a and p_a = b.

Similarly, for b to come, I need to invite b and p_b = c.

For c to come, I need to invite c and p_c = a.

If I invite a and b, then a's best friend is b, who is invited, so a comes. b's best friend is c, who is not invited, so b doesn't come. c is invited, but c's best friend a is invited, so c comes.

Wait, but c is invited, and p_c = a is invited, so c comes.

Similarly, a is invited, and p_a = b is invited, so a comes.

b is invited, and p_b = c is invited, so b comes.

So, if I invite a and b, then a, b, and c all come.

Wait, is that correct?

Wait, according to the problem, a friend comes only if they and their best friend are invited.

So, for a: invited and p_a = b is invited, so a comes.

For b: invited and p_b = c is invited, so b comes.

For c: invited and p_c = a is invited, so c comes.

So, inviting a and b in a 3-cycle results in all three coming.

Similarly, inviting any two in the 3-cycle would result in all three coming.

Alternatively, inviting only one in the 3-cycle: suppose I invite only a.

Then, a's best friend b is invited? No, b is not invited, so a doesn't come.

b's best friend c is not invited, so b doesn't come.

c's best friend a is invited, but c is not invited, so c doesn't come.

So, no one comes.

Similarly, inviting two in the 3-cycle causes all three to come.

Inviting all three also works, but that's more invitations than necessary.

So, in a 3-cycle, inviting any two friends is sufficient to make all three come.

Therefore, in a 3-cycle, the minimal number of invitations to get at least two friends to come is 2.

Now, consider a 4-cycle: a -> b -> c -> d -> a

If I invite a and b, then:

a: invited, p_a = b is invited -> a comes

b: invited, p_b = c is invited? c is not invited -> b doesn't come

c: invited, p_c = d is invited? d is not invited -> c doesn't come

d: invited, p_d = a is invited -> d comes

So, only a and d come.

So, inviting a and b makes a and d come.

Similarly, inviting a and c:

a: invited, p_a = b is not invited -> a doesn't come

c: invited, p_c = d is invited -> c comes

d: invited, p_d = a is not invited -> d doesn't come

So, only c comes, which is less than 2.

Inviting a and d:

a: invited, p_a = b is not invited -> a doesn't come

d: invited, p_d = a is invited -> d comes

So, only d comes, which is less than 2.

Inviting a, b, c:

a: invited, p_a = b is invited -> a comes

b: invited, p_b = c is invited -> b comes

c: invited, p_c = d is invited? d is not invited -> c doesn't come

d: invited, p_d = a is invited -> d comes

So, a, b, d come.

Inviting a, b, d:

a: invited, p_a = b is invited -> a comes

b: invited, p_b = c is not invited -> b doesn't come

c: invited, p_c = d is invited -> c comes

d: invited, p_d = a is invited -> d comes

So, a, c, d come.

Wait, but b is invited but doesn't come because their best friend c is not invited.

Wait, c is invited, but in this case, b's best friend is c, who is invited, so b should come.

Wait, no: b is invited, and p_b = c is invited, so b comes.

So, a, b, c, d all come.

But that's more than needed.

Alternatively, inviting a, c, d:

a: invited, p_a = b is not invited -> a doesn't come

c: invited, p_c = d is invited -> c comes

d: invited, p_d = a is invited -> d comes

So, c and d come.

That's at least 2 friends coming.

So, in a 4-cycle, inviting 3 specific friends can make at least 2 come.

Is there a way to invite fewer than 3?

From above, inviting 2 in a 4-cycle may result in only 1 coming, which is insufficient.

For example, inviting a and b: a and d come.

But d is invited and p_d = a is invited, so d comes.

a is invited and p_a = b is invited, so a comes.

b is invited, p_b = c is not invited, so b doesn't come.

c is invited, p_c = d is invited, so c comes.

Wait, but in this case, inviting a and b makes a and d come, which is 2.

So, in this specific case, inviting 2 in a 4-cycle makes 2 come.

Wait, but in my earlier analysis, inviting a and b makes a and d come.

Wait, perhaps I need to verify that again.

If I invite a and b:

a: invited, p_a = b is invited -> a comes

b: invited, p_b = c is not invited -> b doesn't come

c: invited, p_c = d is invited -> c comes

d: invited, p_d = a is invited -> d comes

So, a, c, d come.

That's 3 friends coming.

But if I invite only a and b, then a, c, d come.

So, that seems to work.

Alternatively, inviting a and d:

a: invited, p_a = b is not invited -> a doesn't come

d: invited, p_d = a is invited -> d comes

So, only d comes, which is less than 2.

Inviting a and c:

a: invited, p_a = b is not invited -> a doesn't come

c: invited, p_c = d is invited -> c comes

d: invited, p_d = a is invited -> d comes

So, c and d come.

That's 2 friends.

So, in a 4-cycle, inviting any 2 non-adjacent friends makes 2 friends come.

Wait, in this case, a and c are not directly connected, but through b and d.

Wait, in a 4-cycle, a -> b -> c -> d -> a.

So, a and c are not directly connected, but are connected through b and d.

But in terms of invitations, inviting a and c makes c and d come.

Similarly, inviting a and d makes only d come, which is insufficient.

So, to ensure at least 2 come in a 4-cycle, inviting 2 specific friends might work, but in some cases, it might not.

Wait, in the second test case, n=4, p=[2,3,4,1], which is a single 4-cycle.

The answer is 3, meaning that inviting 2 is not sufficient in general for a 4-cycle.

But in my earlier analysis, inviting a and c makes c and d come, which is 2 friends.

So, perhaps in some 4-cycles, inviting 2 is enough, but in others, it's not.

Wait, perhaps it depends on which 2 are invited.

Wait, in the second test case, p = [2,3,4,1], which is a cycle: 1->2->3->4->1.

If I invite 1 and 3:

1: invited, p_1=2 is not invited -> 1 doesn't come

3: invited, p_3=4 is invited -> 3 comes

4: invited, p_4=1 is invited -> 4 comes

So, 3 and 4 come.

That's 2 friends.

Alternatively, inviting 1 and 2:

1: invited, p_1=2 is invited -> 1 comes

2: invited, p_2=3 is not invited -> 2 doesn't come

3: invited, p_3=4 is invited -> 3 comes

4: invited, p_4=1 is invited -> 4 comes

So, 1, 3, 4 come.

That's 3 friends.

But according to the example, the minimal number is 3.

Wait, but in my analysis, inviting 1 and 3 makes 2 friends come, which should be sufficient, but the example says the answer is 3.

Wait, perhaps I'm missing something.

Wait, in the second test case, the answer is 3, meaning that inviting only 2 is not sufficient to get at least 2 friends to come in some scenarios.

Wait, perhaps there are cases where inviting 2 doesn't guarantee at least 2 friends coming.

Let me consider inviting 1 and 4:

1: invited, p_1=2 is not invited -> 1 doesn't come

4: invited, p_4=1 is invited -> 4 comes

So, only 4 comes, which is less than 2.

Hence, inviting 1 and 4 is insufficient.

Similarly, inviting 2 and 3:

2: invited, p_2=3 is invited -> 2 comes

3: invited, p_3=4 is invited -> 3 comes

4: invited, p_4=1 is invited -> 4 comes

So, 2, 3, 4 come.

That's 3 friends.

So, in this case, inviting 2 and 3 makes 3 friends come.

But inviting 1 and 4 makes only 1 friend come.

Therefore, to guarantee at least 2 friends come, I need to ensure that no matter which 2 I invite, at least 2 friends come.

But that's not the case here, since inviting 1 and 4 results in only 1 friend coming.

Therefore, to guarantee at least 2 friends come, I need to invite in such a way that no matter what, at least 2 come.

Alternatively, perhaps the problem doesn't require guaranteeing it in all possible invitation sets, but finding the minimal number of invitations where there exists a set of that size that makes at least 2 friends come.

In that case, for the second test case, there exists a set of 3 invitations that makes at least 2 friends come.

But according to the example, the answer is 3, but in my analysis, inviting 1 and 3 makes 2 friends come, so why is the answer 3?

Wait, perhaps I'm misunderstanding the problem.

Wait, re-reading the problem: "Calculate the minimum number of invitations Monocarp has to send so that at least 2 friends come to the party."

So, it's about finding the minimal number of invitations such that at least 2 friends come.

In the second test case, inviting 1 and 3 makes 2 friends come (3 and 4), but according to the example, the answer is 3.

Wait, perhaps in the example, they are considering that inviting [1,2,3] makes 1,2,3 come, which is 3 friends.

But why isn't inviting 1 and 3 sufficient?

Wait, in my earlier analysis, inviting 1 and 3 makes 3 and 4 come, which is 2 friends, so it should be sufficient.

But according to the example, the answer is 3.

Wait, perhaps in the explanation, they say it's impossible to send invitations to fewer than 3 friends in such a way that at least 2 come.

But according to my analysis, inviting 1 and 3 makes 2 friends come.

Is there a mistake in my reasoning?

Wait, perhaps the friends who come must be those who are invited, but in my analysis, 3 and 4 come, but they are invited.

Wait, no, in the invitation list, 1 and 3 are invited, but 4 is also invited, so 4 comes because p_4=1 is invited.

Wait, but in the problem statement, it says "each invitation is sent to exactly one of the friends."

So, in inviting [1,3], friends 1 and 3 are invited, and friend 4 is invited as well, but only if they are sent an invitation.

Wait, no, each invitation is sent to exactly one friend, so if I invite 1 and 3, only friends 1 and 3 receive invitations.

Wait, perhaps I misread.

Wait, re-reading the problem: "Each invitation is sent to exactly one of the friends."

So, if I invite friends 1 and 3, then only friends 1 and 3 receive invitations.

Friend 1: invited, p_1=2 is not invited -> doesn't come

Friend 2: not invited -> doesn't come

Friend 3: invited, p_3=4 is not invited -> doesn't come

Friend 4: not invited -> doesn't come

So, in this case, no one comes.

Wait, that's different from my earlier assumption.

Wait, perhaps I misunderstood the invitation process.

Let me read the problem again carefully.

"The i-th friend comes to the party if both the i-th friend and the p_i-th friend receive an invitation."

So, for friend i to come, both friend i and friend p_i must be invited.

It doesn't matter if p_p_i is invited or not, only that i and p_i are invited.

So, in the second test case, n=4, p=[2,3,4,1]

So, p = [2,3,4,1], meaning:

friend 1's best friend is 2

friend 2's best friend is 3

friend 3's best friend is 4

friend 4's best friend is 1

If I invite friends 1 and 3:

- friend 1: invited, p_1=2 is not invited -> doesn't come

- friend 2: not invited -> doesn't come

- friend 3: invited, p_3=4 is not invited -> doesn't come

- friend 4: not invited -> doesn't come

So, no one comes.

Similarly, if I invite friends 1 and 4:

- friend 1: invited, p_1=2 is not invited -> doesn't come

- friend 2: not invited -> doesn't come

- friend 3: not invited -> doesn't come

- friend 4: invited, p_4=1 is invited -> comes

So, only friend 4 comes, which is less than 2.

If I invite friends 1, 2, and 3:

- friend 1: invited, p_1=2 is invited -> comes

- friend 2: invited, p_2=3 is invited -> comes

- friend 3: invited, p_3=4 is not invited -> doesn't come

- friend 4: not invited -> doesn't come

So, friends 1 and 2 come.

Similarly, inviting friends 1, 2, and 4:

- friend 1: invited, p_1=2 is invited -> comes

- friend 2: invited, p_2=3 is not invited -> doesn't come

- friend 3: not invited -> doesn't come

- friend 4: invited, p_4=1 is invited -> comes

So, friends 1 and 4 come.

Inviting friends 1, 3, and 4:

- friend 1: invited, p_1=2 is not invited -> doesn't come

- friend 2: not invited -> doesn't come

- friend 3: invited, p_3=4 is invited -> comes

- friend 4: invited, p_4=1 is invited -> comes

So, friends 3 and 4 come.

Inviting friends 2, 3, and 4:

- friend 1: not invited -> doesn't come

- friend 2: invited, p_2=3 is invited -> comes

- friend 3: invited, p_3=4 is invited -> comes

- friend 4: invited, p_4=1 is not invited -> doesn't come

So, friends 2 and 3 come.

So, in all cases where I invite 3 friends, I get at least 2 friends coming.

If I try to invite only 2 friends, as in inviting 1 and 3, no one comes, which is insufficient.

