Alright, I've got this problem to solve. Let's see what it's asking for. There are n children in a class, and m pairs among them are friends with some friendship value. The teacher goes on k excursions, and for each excursion, she randomly chooses a pair of children equiprobably and independently. If the chosen pair are friends, their friendship value increases by 1 for all subsequent excursions. Pairs who are not friends have a friendship value of 0 that doesn't change. I need to find the expected value of the sum of friendship values of all k pairs chosen, considering the time they are chosen.

First, I need to understand the setup. There are n children, and some of them are friends with a given friendship value. The teacher chooses k pairs randomly for excursions, and if a chosen pair are friends, their friendship value increases by 1 for all future excursions. So, the friendship values can change over time based on which pairs are chosen.

The problem asks for the expected value of the sum of friendship values at the time each pair is chosen. That means for each excursion, I need to consider the friendship value of the chosen pair at the time of choosing it, and then sum these up over all k excursions.

Let me think about how to approach this. Since the choices are independent and random, I need to consider the probability that a particular pair is chosen in a particular excursion and what the friendship value would be at that time.

But wait, the choices are independent, but the friendship values can change based on previous choices. This seems tricky because the friendship values can increase over time if friends are chosen.

Hmm. Maybe I can think in terms of expectation and linearity of expectation. Linearity of expectation is often useful in probability problems, especially when dealing with sums of random variables.

Let me define X as the total sum of friendship values over all k excursions. So, X = X1 + X2 + ... + Xk, where Xi is the friendship value of the pair chosen in the i-th excursion at the time of choosing it.

By linearity of expectation, E[X] = E[X1] + E[X2] + ... + E[Xk].

So, I need to compute E[Xi] for each i and then sum them up.

Now, each Xi depends on which pair is chosen in the i-th excursion and what its friendship value is at that time.

Given that the choices are independent and equiprobable, the probability of choosing any particular pair in any excursion is the same, which is 2 / (n choose 2), since there are (n choose 2) possible unique pairs, and order doesn't matter.

Wait, actually, in the problem, it says "the teacher chooses a pair of children randomly, equiprobably and independently." So, I need to make sure about the way pairs are chosen.

Let's recall that in the context of choosing pairs from n children, the total number of unique unordered pairs is (n choose 2) = n(n-1)/2.

But in the code provided, it has "cn2 = n * (n - 1) // 2", which is correct for the number of unique unordered pairs.

However, in the code, it seems to be using 2 * cn2 in some calculations, which might be related to ordered pairs. I need to clarify this.

Wait, in the code, it has "p = 2 * k * cn2 * sum_f + m * k * (k - 1)", and "q = 2 * cn2 ** 2". Then it computes gcd of p and q, reduces them, and computes p * q^{-1} mod M.

I need to understand if this correctly computes the expected value as described in the problem.

First, let's think about how friendship values change over time.

For each excursion:

- A pair is chosen uniformly at random from all possible pairs.

- If the chosen pair are friends, their friendship value increases by 1 for all subsequent excursions.

- Pairs that are not friends have a friendship value of 0, which never changes.

I need to find the expected sum of friendship values at the time each pair is chosen, over k excursions.

Let me try to model this.

Let’s denote P as the set of all possible pairs, with size |P| = (n choose 2).

Among these, there are m pairs that are friends, each with an initial friendship value f_i.

For each excursion, a pair is chosen uniformly at random from P.

If the chosen pair is a friend pair, say pair j, then f_j increases by 1 for all subsequent excursions.

Non-friend pairs always have friendship value 0.

I need to compute E[sum_{i=1 to k} X_i], where X_i is the friendship value of the pair chosen in the i-th excursion at the time of choosing it.

Given that the choices are independent, the expectation can be separated.

But wait, the choices are independent, but the friendship values can change based on previous choices, so they are not entirely independent.

However, perhaps I can model the expected increase in friendship values over time.

Let me consider the contribution of each friend pair to the total expected sum.

For each friend pair j with initial friendship value f_j, I need to consider how many times it is chosen across the k excursions, and how its friendship value increases over time.

Wait, perhaps it's better to think in terms of the number of times each friend pair is chosen.

Let’s denote N_j as the number of times pair j is chosen in the k excursions.

Then, the total friendship value contributed by pair j over all excursions is sum over each excursion where j is chosen of its friendship value at that time.

Since each time j is chosen, its friendship value increases by 1 for all subsequent excursions, its friendship value at the time of choosing it is f_j plus the number of times it has been chosen before.

Wait, more carefully:

- Let’s say pair j is chosen in excursions t1, t2, ..., tk_j, where k_j is the number of times it's chosen.

- Each time it's chosen, its friendship value at that time is f_j plus the number of times it has been chosen before.

- So, for the first time it's chosen, its friendship value is f_j.

- Second time: f_j + 1.

- Third time: f_j + 2.

- And so on.

- So, the total contribution to the sum X is f_j + (f_j + 1) + (f_j + 2) + ... + (f_j + (k_j - 1)).

- This simplifies to k_j * f_j + (0 + 1 + 2 + ... + (k_j - 1)) = k_j * f_j + k_j * (k_j - 1) / 2.

But this seems complicated to handle directly.

Maybe there's a better way to compute the expected sum.

Let me consider the total sum X as the sum over all excursions of the friendship value of the chosen pair at that time.

I can think of X as the sum over all excursions of the friendship value at the time of choosing the pair.

Given that the choices are independent, perhaps I can find the expected friendship value for a single excursion and then multiply by k.

Wait, but the friendship values change over time based on previous choices, so the expected friendship value in later excursions depends on what happened in earlier excursions.

This suggests that the expectations are not independent across excursions, so I can't simply multiply the expected value of a single excursion by k.

This seems tricky.

Maybe I need to model this as a Markov process, where the state is the current friendship values of all friend pairs, and then compute the expected sum over k steps.

But that seems too complicated, especially considering the constraints on n and m, which can be up to 1e5, and k up to 2e5 per test case, with t up to 5e4 test cases.

Computational complexity is a concern, so any approach that is not O(1) or O(m) per test case is likely too slow.

Looking back at the code provided, it seems to compute p and q as follows:

p = 2 * k * cn2 * sum_f + m * k * (k - 1)

q = 2 * cn2 ** 2

Then, it computes p / q, reduced to lowest terms, and outputs p * q^{-1} mod M.

I need to verify if this correctly computes the expected value as per the problem.

First, let's understand what p and q represent.

The expected value is a fraction p / q, which needs to be reduced and then computed modulo M.

I need to see if p and q are correctly calculated.

Let me think about the expected sum X.

As X = X1 + X2 + ... + Xk, where Xi is the friendship value of the pair chosen in the i-th excursion at the time of choosing it.

I need to compute E[X] = sum_{i=1 to k} E[Xi].

Now, since each Xi is chosen independently, and the probability distribution for each Xi is the same (because excursions are independent), E[Xi] is the same for all i.

Therefore, E[X] = k * E[X1].

So, I only need to compute E[X1], the expected friendship value for a single excursion, and then multiply it by k.

Wait, is this correct? Given that the choices are independent, but the friendship values change based on previous choices, does E[Xi] remain the same for all i?

Actually, no. Because as friend pairs are chosen in earlier excursions, their friendship values increase, which affects the expected value in later excursions.

Therefore, E[Xi] is not necessarily the same for all i.

So, my previous assumption is incorrect.

This seems more complicated than I thought.

Maybe I need to think differently.

Let me consider the total sum X as the sum over all excursions of the friendship value at the time of choosing the pair.

I need to find E[X].

Let me think about the contribution of each friend pair to E[X].

For each friend pair j with initial friendship value f_j, its contribution to X depends on how many times it is chosen in the k excursions and the state of its friendship value at each choice.

Let’s denote N_j as the number of times pair j is chosen in the k excursions.

Then, the total contribution of pair j to X is sum over each time it is chosen of its friendship value at that time.

As previously, this is f_j * N_j + (0 + 1 + ... + (N_j - 1)) = f_j * N_j + N_j * (N_j - 1) / 2.

Therefore, the total X is sum over all friend pairs j of [f_j * N_j + N_j * (N_j - 1) / 2].

Now, since non-friend pairs always have friendship value 0, their contribution is 0.

Therefore, E[X] = sum over j of [f_j * E[N_j] + E[N_j * (N_j - 1) / 2]].

This seems manageable.

I need to compute E[N_j] and E[N_j * (N_j - 1)] for each friend pair j.

Given that the excursions are independent and each pair is chosen with equal probability, N_j follows a binomial distribution with parameters k and p, where p is the probability of choosing pair j in a single excursion.

Since there are (n choose 2) possible pairs, p = 1 / (n choose 2).

Wait, but in the code, it has "cn2 = n * (n - 1) // 2", which is (n choose 2).

So, p = 1 / cn2.

Therefore, N_j ~ Binomial(k, 1/cn2).

Therefore, E[N_j] = k / cn2.

Also, E[N_j * (N_j - 1)] = Var(N_j) + (E[N_j])^2 - E[N_j] = (k * (1/cn2) * (1 - 1/cn2)) + (k / cn2)^2 - (k / cn2).

But perhaps there's a simpler way.

Alternatively, since N_j is binomial, E[N_j * (N_j - 1)] = k * (k - 1) * (1 / cn2)^2.

Wait, no.

Actually, for a binomial random variable N_j ~ Binomial(k, p), E[N_j * (N_j - 1)] = k * (k - 1) * p^2.

So, in this case, E[N_j * (N_j - 1)] = k * (k - 1) * (1 / cn2)^2.

Therefore, E[X] = sum over j of [f_j * (k / cn2) + (k * (k - 1) / cn2^2)/2].

Wait, plugging back:

E[X] = sum over j of [f_j * E[N_j] + E[N_j * (N_j - 1)] / 2]

= sum over j of [f_j * (k / cn2) + (k * (k - 1) / cn2^2)/2]

But wait, there are m friend pairs, so sum over j of f_j is sum_f.

Therefore, E[X] = sum_f * (k / cn2) + m * (k * (k - 1) / (2 * cn2^2))

Wait, where does the m come from?

Because there are m friend pairs, each contributing E[N_j * (N_j - 1)] / 2.

So, sum over j of E[N_j * (N_j - 1)] / 2 = m * (k * (k - 1) / (2 * cn2^2))

Wait, no.

Actually, E[N_j * (N_j - 1)] / 2 = k * (k - 1) * (1 / cn2)^2 / 2 for each j.

Since there are m friend pairs, sum over j of E[N_j * (N_j - 1)] / 2 = m * [k * (k - 1) / (2 * cn2^2)]

So, E[X] = sum_f * (k / cn2) + m * [k * (k - 1) / (2 * cn2^2)]

Now, let's see if this matches the p and q in the code.

In the code:

p = 2 * k * cn2 * sum_f + m * k * (k - 1)

q = 2 * cn2 ** 2

Then, p / q should be equal to E[X].

Let's see:

p / q = [2 * k * cn2 * sum_f + m * k * (k - 1)] / [2 * cn2 ^ 2]

= [2 * k * cn2 * sum_f] / [2 * cn2 ^ 2] + [m * k * (k - 1)] / [2 * cn2 ^ 2]

= [k * sum_f] / [cn2] + [m * k * (k - 1)] / [2 * cn2 ^ 2]

Comparing this to the earlier expression for E[X]:

E[X] = sum_f * (k / cn2) + m * [k * (k - 1) / (2 * cn2 ^ 2)]

These match exactly.

Therefore, the expression for p and q in the code correctly represents the expected value E[X].

Now, the code computes gcd of p and q, reduces them, and then computes p * q^{-1} mod M, where M = 10^9 + 7.

This is correct for computing the fraction p / q modulo M, provided that q and M are coprime, which they are since M is prime and q is 2 * cn2 ^ 2, and cn2 is a positive integer.

Therefore, the code correctly computes the expected value and outputs it in the required format.

Hence, the given program is correct.

**Final Answer**

\[ \boxed{\text{True}} \]