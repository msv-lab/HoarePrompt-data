Alright, I have this problem to solve. Let's read it carefully.

So, I have some cards, each with an integer from 1 to n, and I have a_i cards of each type i. I can buy k new cards, and each new card can be any integer from 1 to n. After buying, I arrange all my cards in a line, and I need to find the maximum number of contiguous subarrays of length n that are permutations of [1, 2, ..., n].

First, I need to understand what a permutation of [1, 2, ..., n] means in this context. It means that in any subarray of length n, each number from 1 to n appears exactly once.

So, my goal is to arrange all my cards (after buying k new ones) in such a way that the number of these special subarrays is maximized.

Let me think about how to approach this.

I recall that in array problems, especially those involving subarrays with specific properties, sliding window techniques are often useful. Maybe I can apply something similar here.

But before jumping into that, let's consider what the problem is asking for.

I need to maximize the number of subarrays of length n that are permutations of [1, 2, ..., n]. That means, in each window of n cards, every number from 1 to n must appear exactly once.

To maximize the number of such windows, I need to arrange the cards in a way that satisfies this condition as many times as possible.

Let me think about the constraints.

I have a large number of cards, up to 10^12 for each a_i, and k can be up to 10^12, and n can be up to 2*10^5. So, brute-force approaches are definitely out of the question due to time and memory constraints.

I need a smarter way to calculate the maximum number of such subarrays without actually arranging the cards.

Let me consider the frequency of each card type.

Suppose I have frequencies f1, f2, ..., fn for cards 1 to n, where fi is the number of cards of type i after buying k new cards.

My task is to arrange these cards in a sequence such that in every window of size n, each number from 1 to n appears exactly once.

Wait, that sounds tricky. Maybe I need to think differently.

Another way to look at it is to maximize the number of positions where the window of size n is a permutation of [1,2,...,n].

I recall that in some problems, the number of such windows can be calculated by sliding a window and keeping track of the frequency of each element within the window.

But again, with the large constraints, I can't implement a traditional sliding window approach.

Let me think about the minimal number of each card I need to have to form at least one permutation of [1,2,...,n]. I need at least one of each card from 1 to n.

But I can have multiple permutations if I have more cards.

Wait, perhaps I can think in terms of how many complete sets of [1,2,...,n] I can form.

If I have enough cards to form m complete permutations, then I can arrange them in a sequence where each permutation is placed one after another, and in this arrangement, there would be m overlapping windows where each window is a permutation.

But actually, if I place m permutations one after another, the number of overlapping windows would be m + (n - 1), but I need to verify that.

Wait, let's think about an example.

Suppose n=2, and I have m=2 permutations.

If I arrange them as [1,2,1,2], then the windows are [1,2] and [2,1]. Both are permutations of [1,2].

So, for m=2, I have 2 windows.

Wait, but in this arrangement, the second window [2,1] is also a permutation.

So, total windows equal to m.

Wait, no, in a sequence of m permutations placed one after another, the number of overlapping windows of size n is m + (n - 1).

Wait, let's think carefully.

If I have m permutations placed sequentially, the total length is m*n.

The number of windows of size n in a sequence of length m*n is (m*n - n + 1).

But not all of them will be permutations.

Wait, perhaps I need a better approach.

Let me consider the minimal number of each card I need to form m permutations.

To form m permutations, I need at least m cards of each type.

Because each permutation requires one of each card.

So, if I have a_i cards of type i initially, and I can buy k more cards, the total number of cards I can have for type i is a_i + b_i, where b_i is the number of type i cards I buy, and sum of b_i <= k.

I need to maximize the number of permutations, say p, such that for each i, a_i + b_i >= p.

Because each permutation requires one of each card.

So, p <= min over i of (a_i + b_i).

But I can distribute the k buys to maximize p.

So, I need to maximize p such that sum over i of max(p - a_i, 0) <= k.

This looks like a standard problem where we can binary search on p.

But perhaps there's a better way, given the time constraints.

Wait, but with n up to 2*10^5 and t test cases up to 100, and sum of n over all test cases up to 5*10^5, I need an O(n log n) or better solution per test case.

Let me think about the problem differently.

Suppose I fix p, the number of permutations I want to form.

Then, the number of cards I need for each type is at least p.

So, the total number of cards I need to buy is sum over i of max(p - a_i, 0).

I need this sum to be <= k.

So, to maximize p, I can binary search on p, and check if sum of max(p - a_i, 0) <= k.

This seems feasible.

Let me try to formalize this.

Let low = 0 and high = some large number, say 10^12, since a_i can be up to 10^12.

While low < high:

mid = (low + high + 1) // 2

sum_needed = sum(max(mid - a_i, 0) for all i)

if sum_needed <= k:

low = mid

else:

high = mid - 1

Then, p = low

This will give me the maximum p such that sum of max(p - a_i, 0) <= k.

But now, I need to arrange the cards in such a way that the number of windows of size n that are permutations is maximized.

Wait, but if I have p permutations, and I arrange them in a sequence, how many windows of size n are permutations?

In the earlier example with n=2 and m=2, arranged as [1,2,1,2], there are two windows: [1,2] and [2,1], both are permutations.

So, it seems that the number of such windows is p.

But I'm not sure.

Wait, perhaps it's p + (n - 1).

Wait, no.

Let me think about n=3 and p=2.

Arranged as [1,2,3,1,2,3].

Windows are [1,2,3], [2,3,1], [3,1,2], [1,2,3].

So, four windows, which is p + (n - 1) = 2 + 2 = 4.

Wait, in general, for a sequence of p*n cards, the number of consecutive windows of size n is p*n - n + 1.

But in this arrangement, not all of them will be permutations.

In the above example, all four windows are permutations.

Is that always the case?

Wait, in [1,2,3,1,2,3], all four windows are permutations.

Similarly, in [1,2,1,2], both windows are permutations.

So, perhaps arranging the permutations in a sequence like this maximizes the number of such windows.

In general, if I arrange the p permutations one after another, and each permutation is a rearrangement of [1,2,...,n], then in the sequence, the number of windows that are permutations would be p + (n - 1).

Wait, in the first example with n=2, p=2, sequence [1,2,1,2], windows are [1,2], [2,1], which is p + n - 1 = 2 + 1 = 3, but there are only 2 windows.

Wait, maybe I miscalculated.

Wait, for n=2 and p=2, length is 4, number of windows is 3: [1,2], [2,1], [1,2].

So, p + n - 1 = 3, and indeed there are 3 windows, and all are permutations in this case.

Similarly, for n=3 and p=2, sequence [1,2,3,1,2,3], windows are [1,2,3], [2,3,1], [3,1,2], [1,2,3], which is p + n -1 = 2 + 3 -1 = 4 windows.

So, it seems that in this arrangement, the number of windows that are permutations is p + n -1.

But wait, in the first test case, with n=1 and k=10, a=[1], so p is maximized such that sum(max(p - a_i, 0)) <= k.

So, p = k + min(a_i) = 11, since a_1 =1, and k=10, so p=11.

Then, according to p + n -1 =11 +1 -1=11, which matches the first output.

In the second test case, n=2, k=4, a=[8,4].

So, p is the maximum where sum(max(p - a_i,0)) <=4.

So, p -8 (if p >8) + p -4 (if p >4) <=4.

Suppose p=5:

max(5-8,0)=0 + max(5-4,0)=1 <=4, okay.

p=6: 0 + 2 <=4

p=7: 0 + 3 <=4

p=8: 0 +4 <=4

p=9: 1 +5=6 >4

So, p=8.

Then, according to p + n -1=8+2-1=9, but the output is 15.

Wait, that doesn't match.

So, perhaps my assumption is wrong.

Wait, maybe the number of windows is not p + n -1.

Looking back at the second test case, output is 15.

If p=8, and n=2, p + n -1=9, which is less than 15.

So, my assumption is incorrect.

I must be missing something.

Let me think again.

Perhaps I need to consider overlapping permutations beyond just p + n -1.

Wait, in the second test case, with p=8, and n=2, arranging them as [1,2,1,2,...,1,2], there would be 8 +1=9 windows that are permutations.

But the output is 15, which is higher.

So, perhaps I can arrange the cards in a way that allows more overlapping permutations.

Wait, maybe I can interleave the permutations to get more overlapping windows.

For example, if I arrange [1,2,1,2,1,2,1,2,1,2,1,2,1,2,1,2], then the windows are [1,2], [2,1], [1,2], etc., alternating between [1,2] and [2,1], both of which are permutations.

In this case, for p=8, I have 16 elements, and the number of windows is 15, which matches the output.

So, perhaps the number of windows is p*(n) -1, but in this case, it's 8*2 -1=15, which matches.

Wait, but p is the number of permutations, and each permutation has n elements.

So, total length is p*n.

Number of consecutive windows of size n is p*n - n +1.

In this case, 8*2 -2 +1=16 -2 +1=15, which matches.

So, perhaps the formula is p*n - n +1.

But in the first test case, n=1, p=11, so 11*1 -1 +1=11, which matches output 11.

In the second test case, p=8, n=2, 16 -2 +1=15, matches output 15.

In the third test case, p=6, n=3, 18 -3 +1=16, but output is 15.

Wait, doesn't match.

Wait, perhaps I need to adjust p.

Wait, in the third test case, n=3, k=4, a=[6,1,8].

So, p is maximum where sum(max(p - a_i,0)) <=4.

So, p -6 (if p>6) + p -1 (if p>1) + p -8 (if p>8) <=4.

Let me compute p.

If p=2:

max(2-6,0)=0 + max(2-1,0)=1 + max(2-8,0)=0 =1 <=4, okay.

p=3: 0 +2 +0=2 <=4

p=4:0 +3 +0=3 <=4

p=5:0 +4 +0=4 <=4

p=6:0 +5 +0=5 >4

So, p=5.

Then, total windows would be p*n -n +1=15 -3 +1=13, but the output is 15.

Hmm, doesn't match.

Wait, maybe I'm miscalculating p.

Wait, sum of max(p - a_i,0):

For p=5:

max(5-6,0)=0 + max(5-1,0)=4 + max(5-8,0)=0=4 <=4, okay.

p=6:0 +5 +0=5 >4, so p=5.

Then, total windows p*n -n +1=15 -3 +1=13, but output is 15.

So, discrepancy here.

Perhaps my assumption is incorrect.

Maybe I need to consider how the permutations overlap.

Wait, perhaps I can arrange the cards in a way that some windows are permutations beyond just p*n -n +1.

Wait, maybe I need to maximize the number of windows that are permutations, not necessarily by arranging p permutations one after another.

Perhaps there's a better arrangement.

Let me consider that.

Suppose I have p permutations, each of size n, and I arrange them in a way that the overlapping parts also form permutations.

For example, in n=2, p=2, arrangement [1,2,1,2], windows are [1,2],[2,1],[1,2], all are permutations.

So, total windows is p + n -1=3, but in reality, it's p*(n) -n +1=3, which matches.

But in the second test case, p=8, n=2, total windows=15, which matches p*n -n +1=16 -2 +1=15.

In the third test case, p=5, n=3, p*n -n +1=15 -3 +1=13, but output is 15.

So, discrepancy here.

Wait, maybe I need to consider that some windows beyond the p*n -n +1 can also be permutations if arranged properly.

Wait, but p*n -n +1 is the total number of possible windows, so I can't have more than that.

Wait, perhaps I miscounted p.

Wait, in the third test case, n=3, k=4, a=[6,1,8].

I need to maximize p where sum(max(p - a_i,0)) <=4.

So, sum is max(p-6,0) + max(p-1,0) + max(p-8,0) <=4.

Let me try p=5:

0 +4 +0=4 <=4, okay.

p=6:0 +5 +0=5 >4.

So, p=5.

Then, total windows should be p*n -n +1=15 -3 +1=13, but output is 15.

So, perhaps my formula is incorrect.

Wait, maybe I need to consider that some windows can be permutations even beyond p*n -n +1.

But that doesn't make sense, because p*n -n +1 is the total number of possible windows.

Wait, perhaps I need to consider that some windows are counted multiple times, but that's not possible in a sliding window.

Wait, maybe I need to arrange the cards in a way that maximizes the number of windows that are permutations, potentially exceeding p*n -n +1.

But that seems impossible.

Wait, perhaps I need to consider that some windows can be permutations even outside the p permutations.

Wait, maybe I can interleave the permutations in a smarter way.

Wait, perhaps I need to think differently.

Let me consider that after arranging the p permutations, I might have some extra cards that can be used to create additional permutation windows.

But I need to think carefully.

Maybe I need to maximize the number of windows that are permutations, not necessarily constrained by p*n -n +1.

Wait, perhaps I need to find the maximum number of windows of size n that are permutations, given that I can arrange the cards optimally with the constraints on the number of each card.

This seems more accurate.

But how to calculate that?

I need a way to maximize the number of windows of size n that are permutations, given the frequencies of the cards.

This sounds like a sliding window maximum problem, but it's too slow for the constraints.

Wait, perhaps I can think in terms of the number of times each number appears in the sequence, and ensure that in every window of size n, each number appears exactly once.

But that seems too vague.

Let me consider the problem in terms of the number of valid windows.

Suppose I have a sequence of length m, then the number of windows of size n is m - n +1.

I need to maximize the number of windows that are permutations of [1,2,...,n].

Given that I can arrange the cards in any order, and I can buy up to k additional cards, choosing any numbers from 1 to n.

So, I need to maximize the number of windows that contain each number from 1 to n exactly once.

I recall that in some problems, the number of subarrays with exactly k distinct elements is calculated using sliding window techniques.

But here, it's not just about distinct elements, but specifically that each element from 1 to n appears exactly once.

Wait, perhaps I can model this as a sliding window where I keep track of the frequency of each number in the window.

But again, with the large constraints, I need a smarter way.

Let me think about the minimal number of each card I need to have to form m valid windows.

Wait, perhaps I can think of it as forming a sequence where there are as many overlapping permutations as possible.

Wait, maybe I can model this as a sequence where every window of size n is a permutation, and see how long such a sequence can be.

But I'm going in circles here.

Let me look back at the problem.

I need to maximize the number of windows of size n that are permutations.

Given that I can arrange the cards in any order and buy up to k additional cards.

I need to maximize the number of windows that are permutations.

I recall that in de Bruijn sequences, sequences are constructed to contain all possible subsequences of a certain length, but that might not directly apply here.

Wait, perhaps I can think in terms of the number of times each number appears in the sequence.

But I'm not sure.

Let me consider that in a sequence of length m, the number of windows that are permutations depends on how the numbers are arranged.

To maximize the number of such windows, I need to arrange the numbers so that as many windows as possible are permutations.

One way to do this is to arrange the sequence in a repeating pattern of permutations.

For example, for n=2, arranging [1,2,1,2,...] gives every window of size 2 as a permutation.

Similarly, for n=3, arranging [1,2,3,1,2,3,...] gives every window of size 3 as a permutation.

In this case, the number of windows is p*n -n +1, where p is the number of permutations.

But in the third test case, p=5, n=3, so windows=15 -3 +1=13, but the output is 15.

So, perhaps my calculation of p is incorrect.

Wait, in the third test case, with a=[6,1,8], k=4.

I need to maximize p where sum(max(p - a_i,0)) <=4.

So, max(p-6,0) + max(p-1,0) + max(p-8,0) <=4.

Let me try p=5:

0 +4 +0=4 <=4, okay.

p=6:0 +5 +0=5 >4.

So, p=5.

But the output is 15, which is higher than p*n -n +1=15 -3 +1=13.

So, perhaps there is a way to arrange the cards to get more windows.

Wait, maybe I can arrange the sequence so that some windows overlap more than just consecutive windows.

But in a sliding window, each shift by one creates a new window that overlaps with the previous one by n-1 elements.

Wait, perhaps I need to consider that some windows can be permutations even beyond the p*n -n +1.

But that doesn't make sense because p*n -n +1 is the total number of possible windows in a sequence of length p*n.

Wait, maybe I need to make the sequence longer by buying more cards.

Wait, in the third test case, p=5, n=3, so total cards without buying are min(a_i)=1, since a=[6,1,8], min is 1.

So, initial p=1.

Then, to reach p=5, I need to buy enough cards to have p=5.

Sum of max(5 - a_i,0):

max(5-6,0)=0 + max(5-1,0)=4 + max(5-8,0)=0=4 <=k=4, which is allowed.

So, I can have p=5.

Then, total windows are p*n -n +1=15 -3 +1=13.

But the output is 15, which is higher.

So, perhaps my understanding is incomplete.

Wait, maybe I can arrange the sequence in a way that some