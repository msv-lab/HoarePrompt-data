Alright, I've got this problem to solve. Let's see what it's asking for. So, Monocarp wants to throw a party and invite some of his friends, but there are some conditions. He has n friends, and each friend has a best friend, which is represented by p_i. The key points are:

1. All p_i are distinct and p_i ≠ i, meaning everyone has a unique best friend who isn't themselves.

2. A friend comes to the party only if both they and their best friend receive an invitation.

3. Monocarp wants at least 2 friends to come to the party.

4. He needs to send the minimum number of invitations to achieve this.

My task is to determine the minimum number of invitations needed for each test case.

First, I need to understand the relationship between friends and their best friends. Since p_i represents the best friend of the i-th friend, and all p_i are distinct and not equal to i, this means that the friendships form a permutation of the friends.

For example, if n=3 and p=[2,3,1], then:

- Friend 1's best friend is 2.

- Friend 2's best friend is 3.

- Friend 3's best friend is 1.

This forms a cycle where each friend is connected to another in a chain.

Now, the condition for a friend to come to the party is that both they and their best friend receive an invitation. So, for friend i to come, both i and p_i must be invited.

But the invitation is sent to exactly one friend, meaning that if I send an invitation to friend i, it only affects friend i and possibly others indirectly.

Wait, no. Actually, each invitation is sent to exactly one friend, but the condition for a friend to come is that both they and their best friend receive an invitation. So, to make friend i come, I need to send invitations to both i and p_i.

But the way the problem is phrased is a bit confusing. Let me read it again:

"the i-th friend comes to the party if both the i-th friend and the p_i-th friend receive an invitation (note that the p_i-th friend doesn't have to actually come to the party). Each invitation is sent to exactly one of the friends."

So, each invitation is sent to exactly one friend, but for a friend to come, they and their best friend must receive an invitation.

Wait, so if I send an invitation to friend A, that counts as A receiving an invitation. Similarly, sending an invitation to friend B means B receives one.

But for friend A to come, both A and p_A must have received invitations.

So, to make friend A come, I need to send invitations to both A and p_A.

However, p_A is someone else's best friend, so there might be overlaps.

Let me consider the example in the problem:

Example 1:

n=5

p=[3,1,2,5,4]

Monocarp sends invitations to [1,2,4,5]

Then, friends [2,4,5] come.

- Friend 2: received invitation, and p_2=1 also received invitation.

- Friend 4: received invitation, and p_4=5 also received invitation.

- Friend 5: received invitation, and p_5=4 also received invitation.

Friend 1 didn't come because p_1=3 didn't receive an invitation.

Friend 3 didn't come because they didn't receive an invitation.

So, in this case, 3 friends came.

But the problem is to have at least 2 friends come, and minimize the number of invitations sent.

In this example, sending invitations to [4,5] would make friends 4 and 5 come, since both received invitations and their best friends also received invitations.

So, in this case, only 2 invitations are needed to make 2 friends come.

Hence, the answer is 2.

Another example:

n=4

p=[2,3,4,1]

Sending invitations to [1,2,3]:

- Friend 1: received invitation, p_1=2 also received invitation → comes.

- Friend 2: received invitation, p_2=3 also received invitation → comes.

- Friend 3: received invitation, p_3=4 didn't receive invitation → doesn't come.

- Friend 4: didn't receive invitation → doesn't come.

So, friends 1 and 2 come.

Is it possible to have at least 2 friends come with fewer than 3 invitations?

Let's see:

- Send invitations to [1,2]:

- Friend 1: received, p_1=2 also received → comes.

- Friend 2: received, p_2=3 didn't receive → doesn't come.

- Friend 3: didn't receive → doesn't come.

- Friend 4: didn't receive → doesn't come.

Only friend 1 comes, which is less than 2. So, not sufficient.

- Send invitations to [1,3]:

- Friend 1: received, p_1=2 didn't receive → doesn't come.

- Friend 3: received, p_3=4 didn't receive → doesn't come.

- Friend 2: didn't receive → doesn't come.

- Friend 4: didn't receive → doesn't come.

No one comes.

- Send invitations to [2,3]:

- Friend 2: received, p_2=3 also received → comes.

- Friend 3: received, p_3=4 didn't receive → doesn't come.

- Friend 1: didn't receive → doesn't come.

- Friend 4: didn't receive → doesn't come.

Only friend 2 comes.

- Send invitations to [3,4]:

- Friend 3: received, p_3=4 also received → comes.

- Friend 4: received, p_4=1 didn't receive → doesn't come.

- Friend 1: didn't receive → doesn't come.

- Friend 2: didn't receive → doesn't come.

Only friend 3 comes.

So, it seems that to have at least 2 friends come, Monocarp needs to send invitations to at least 3 friends in this case.

Another example:

n=2

p=[2,1]

Sending invitations to [1,2]:

- Friend 1: received, p_1=2 also received → comes.

- Friend 2: received, p_2=1 also received → comes.

So, both friends come with 2 invitations.

Seems straightforward.

From these examples, it seems that the minimal number of invitations needed depends on the structure of the friendships.

Given that p_i are distinct and p_i ≠ i, this means that the friendships form a collection of cycles.

For example:

- In the first example, n=5, p=[3,1,2,5,4], which forms two cycles: 1→3→2→1 and 4→5→4.

- In the second example, n=4, p=[2,3,4,1], which forms one cycle: 1→2→3→4→1.

- In the third example, n=2, p=[2,1], which forms one cycle: 1→2→1.

In general, the friendships form disjoint cycles.

Now, to minimize the number of invitations while ensuring that at least 2 friends come, we need to find a way to cover at least 2 friends such that each of them and their best friend are invited.

Let's think about the cycles.

In a cycle of length k, to make one friend come, we need to select that friend and their best friend, which are two specific positions in the cycle.

But since the cycle is connected, selecting invitations for one pair might affect others.

Wait, perhaps it's better to think in terms of selecting pairs of friends who are each other's best friends.

Wait, but from the problem, it's not necessarily the case that p_{p_i} = i, because the p_i are a permutation with no fixed points and are derangements.

Wait, in the first example:

p = [3,1,2,5,4]

So, p_1 = 3, p_3 = 2, p_2 =1 → cycle: 1→3→2→1

p_4 =5, p_5=4 → cycle:4→5→4

In this case, p_{p_i} ≠ i for some i.

Wait, in the cycle 1→3→2→1, p_1=3, p_3=2, p_2=1.

Similarly, in 4→5→4, p_4=5, p_5=4.

So, in general, the cycles can be of any length >=2, but in this problem, since p_i are distinct and p_i ≠ i, all cycles have length at least 2.

Now, to make a friend come, we need to invite both the friend and their best friend.

But since best friends are linked, inviting both friend and their best friend might cover multiple friendships.

Wait, no. Each invitation is sent to exactly one friend.

So, if I invite friend A and friend B, then for friend A to come, both A and p_A must have received invitations.

Similarly for friend B.

But p_A might be B, but in this problem, it's not necessarily the case that p_{p_i} =i.

Wait, in the first example, p_1=3, p_3=2, p_2=1.

So, p_{p_1} = p_3 =2 ≠1.

So, it's possible to have p_{p_i} ≠i.

This makes it more complicated.

Let's think differently.

Suppose I select a set S of friends to invite.

Then, a friend i comes if both i and p_i are in S.

Our goal is to have at least 2 friends come, i.e., at least 2 friends satisfy both i and p_i are in S.

We need to minimize the size of S.

This is similar to selecting subsets in a graph such that certain edges are covered.

Wait, perhaps modeling this as a graph would help.

Let's consider the friends as nodes in a graph, and the best friend relationships as edges.

So, we have a graph where each node i has exactly one outgoing edge to p_i, and one incoming edge from the j where p_j=i.

Since p_i are distinct and p_i ≠i, this forms a directed graph consisting of disjoint cycles.

In this graph, each cycle is a cycle of best friendships.

For example, in the first example, there are two cycles: 1→3→2→1 and 4→5→4.

Now, to make a friend i come, we need to have both i and p_i in S.

So, in terms of the graph, for each friend i in a cycle, to make i come, we need to have both i and p_i in S.

Our goal is to select the smallest S such that at least 2 friends have both them and their best friend in S.

Let's consider the cycles separately.

Suppose we have disjoint cycles.

In the first example, cycles are 1→3→2→1 and 4→5→4.

For the first cycle, to make friend 1 come, we need to have both 1 and 3 in S.

Similarly, to make friend 3 come, we need both 3 and 2 in S.

To make friend 2 come, we need both 2 and 1 in S.

Similarly, for the second cycle, to make friend 4 come, we need both 4 and 5 in S.

To make friend 5 come, we need both 5 and 4 in S.

Our goal is to have at least 2 friends come, which could be from the same cycle or different cycles.

Let's consider the minimal S for each cycle.

For a cycle of length 2: say a→b→a.

To make friend a come, we need both a and b in S.

Similarly, to make friend b come, we need both b and a in S.

So, with S={a,b}, both a and b would come, satisfying the condition of at least 2 friends coming.

For a cycle of length 3: a→b→c→a.

To make friend a come, we need a and b in S.

Similarly, for friend b, we need b and c in S.

For friend c, we need c and a in S.

If we take S={a,b,c}, then all three friends would come, but we only need at least 2.

Is there a way to have S with fewer than 3 elements?

If S={a,b}, then friend a and friend b would come, since both a and b are in S, and their best friends b and c are in S.

Wait, friend b's best friend is c, which is in S, but friend c's best friend is a, which is in S, so friend c would also come.

Wait, no, friend c needs both c and a in S to come, which they are, so friend c would come.

So, with S={a,b,c}, all come.

But if S={a,b}, then friend a and friend b would come, and friend c would also come, since c and a are both in S.

So, in this case, S={a,b} makes all three come, which is more than enough.

Wait, but according to the problem, we only need at least 2 friends to come.

So, in this case, S={a,b} makes all three come, which satisfies the condition.

Is there a way to have S with fewer than 2 elements?

If S={a}, then friend a needs both a and b in S, which b is not in S, so friend a doesn't come.

Similarly, friend b needs b and c in S, neither c is in S, so doesn't come.

Friend c needs c and a in S, c is not in S, so doesn't come.

So, with S={a}, no one comes.

With S={a,b}, all three come.

With S={a,c}, friend a needs a and b in S, b is not in S, so doesn't come.

Friend c needs c and a in S, both are in S, so friend c comes.

Friend b needs b and c in S, b is not in S, so doesn't come.

So, only friend c comes, which is less than 2.

So, S={a,c} is not sufficient.

Similarly, S={b,c}:

Friend b needs b and c in S, both are there, so friend b comes.

Friend c needs c and a in S, a is not in S, so doesn't come.

Friend a needs a and b in S, a is not in S, so doesn't come.

So, only friend b comes, which is less than 2.

Hence, in a cycle of length 3, to have at least 2 friends come, we need to select S with at least 2 elements, but in practice, selecting any 2 elements makes all 3 come.

So, in this case, the minimal S has 2 elements.

Wait, but in the second test case, with n=4, p=[2,3,4,1], which is a single cycle of length 4: 1→2→3→4→1.

To have at least 2 friends come, what is the minimal S?

Let's try S={1,2}:

- Friend 1 needs 1 and 2 in S, both are there, so comes.

- Friend 2 needs 2 and 3 in S, 3 is not in S, so doesn't come.

- Friend 3 needs 3 and 4 in S, 3 and 4 are not in S, so doesn't come.

- Friend 4 needs 4 and 1 in S, 4 is not in S, so doesn't come.

So, only friend 1 comes, which is less than 2.

S={1,2,3}:

- Friend 1: 1 and 2 in S → comes.

- Friend 2: 2 and 3 in S → comes.

- Friend 3: 3 and 4 in S, 4 not in S → doesn't come.

- Friend 4: 4 and 1 in S, 4 not in S → doesn't come.

So, friends 1 and 2 come.

Is there a way to have S with 2 elements that makes at least 2 friends come?

From earlier, S={1,2} only makes friend 1 come.

S={1,3}:

- Friend 1: 1 and 2 in S, 2 not in S → doesn't come.

- Friend 3: 3 and 4 in S, 4 not in S → doesn't come.

- Friend 2: not in S → doesn't come.

- Friend 4: not in S → doesn't come.

No one comes.

S={2,3}:

- Friend 2: 2 and 3 in S → comes.

- Friend 3: 3 and 4 in S, 4 not in S → doesn't come.

- Friend 1: not in S → doesn't come.

- Friend 4: not in S → doesn't come.

Only friend 2 comes.

S={3,4}:

- Friend 3: 3 and 4 in S → comes.

- Friend 4: 4 and 1 in S, 1 not in S → doesn't come.

- Friend 1: not in S → doesn't come.

- Friend 2: not in S → doesn't come.

Only friend 3 comes.

S={1,4}:

- Friend 1: 1 and 2 in S, 2 not in S → doesn't come.

- Friend 4: 4 and 1 in S → comes.

- Friend 2: not in S → doesn't come.

- Friend 3: not in S → doesn't come.

Only friend 4 comes.

So, in all cases with S of size 2, only one friend comes, which is less than 2.

Hence, we need S of size at least 3 to have at least 2 friends come.

So, in cycles of length 3, S of size 2 suffices, but in cycles of length 4, S of size 3 is needed.

Wait, in the first example with two cycles of lengths 3 and 2, S of size 2 suffices.

In the second example, a single cycle of length 4, S of size 3 is needed.

In the third example, a single cycle of length 2, S of size 2 suffices.

So, perhaps in cycles of even length, S needs to be larger.

Let me consider cycles of different lengths.

Cycle length 2:

a→b→a

To make friend a come, need a and b in S.

Similarly, to make friend b come, need b and a in S.

So, S={a,b} makes both a and b come.

Hence, for cycle length 2, S of size 2 suffices to make 2 friends come.

Cycle length 3:

a→b→c→a

As earlier, S={a,b} makes all three come.

Hence, S of size 2 suffices.

Cycle length 4:

a→b→c→d→a

From earlier, S={a,b,c} makes friends a and b come.

Is there a way to have S of size 3 that makes at least 2 friends come?

S={a,b,c} makes friends a and b come.

S={a,c,d}:

- Friend a: a and b in S, b not in S → doesn't come.

- Friend c: c and d in S → comes.

- Friend d: d and a in S → comes.

- Friend b: not in S → doesn't come.

So, friends c and d come.

Hence, S of size 3 can make at least 2 friends come.

Is there a S of size 2 that makes at least 2 friends come?

From earlier attempts, it seems not.

Hence, for cycle length 4, S of size 3 is minimal to have at least 2 friends come.

Cycle length 5:

a→b→c→d→e→a

Let's see.

S={a,b,c}:

- Friend a: a and b in S → comes.

- Friend b: b and c in S → comes.

- Friend c: c and d in S, d not in S → doesn't come.

- Friend d: d and e in S, d not in S → doesn't come.

- Friend e: e and a in S, e not in S → doesn't come.

So, friends a and b come.

Hence, S of size 3 suffices.

Is there a S of size 2 that makes at least 2 friends come?

S={a,b}:

- Friend a: a and b in S → comes.

- Friend b: b and c in S, c not in S → doesn't come.

- Friend c: c and d in S, c not in S → doesn't come.

- Friend d: d and e in S, d not in S → doesn't come.

- Friend e: e and a in S, e not in S → doesn't come.

Only friend a comes, which is less than 2.

S={a,c}:

- Friend a: a and b in S, b not in S → doesn't come.

- Friend c: c and d in S, d not in S → doesn't come.

- Friend b: not in S → doesn't come.

- Friend d: not in S → doesn't come.

- Friend e: not in S → doesn't come.

No one comes.

Similarly, other combinations of S of size 2 don't seem to work.

Hence, for cycle length 5, S of size 3 is minimal to have at least 2 friends come.

Cycle length 6:

a→b→c→d→e→f→a

S={a,b,c}:

- Friend a: a and b in S → comes.

- Friend b: b and c in S → comes.

- Friend c: c and d in S, d not in S → doesn't come.

- Friend d: d and e in S, d not in S → doesn't come.

- Friend e: e and f in S, e not in S → doesn't come.

- Friend f: f and a in S → comes.

So, friends a, b, and f come.

Hence, S of size 3 makes at least 2 friends come.

Is there a S of size 2 that works?

S={a,b}:

- Friend a: a and b in S → comes.

- Friend b: b and c in S, c not in S → doesn't come.

- Friend c: c and d in S, c not in S →