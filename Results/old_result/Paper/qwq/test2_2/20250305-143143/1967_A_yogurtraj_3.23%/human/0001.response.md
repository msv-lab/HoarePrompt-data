Alright, I've got this problem to solve. Let's see what it's asking for.

So, I have some cards with numbers from 1 to n, and I have a certain number of each. For example, a1 cards with 1, a2 with 2, and so on up to an with n. Then, I can buy k new cards, and each can be any number from 1 to n. After buying, I arrange all my cards in a line and need to find the maximum number of contiguous subarrays of length n that are permutations of [1, 2, ..., n]. Basically, each of these subarrays should contain each number from 1 to n exactly once.

First, I need to understand what makes a subarray of length n a permutation of [1, 2, ..., n]. It means that in every sequence of n consecutive cards, each number from 1 to n appears exactly once. So, no duplicates and all numbers are present.

Now, to maximize the number of such subarrays, I need to arrange all my cards in a way that as many n-length windows as possible satisfy this condition.

I recall that in array problems, especially those involving windows or subarrays, sliding window techniques are often useful. Maybe I can apply something similar here.

But before jumping into the arrangement, I need to think about how many such windows I can possibly have, given the total number of cards I have after buying k new ones.

Let me denote the total number of cards after buying as t = sum of a1 to an + k.

Then, the number of possible n-length windows in this arrangement is t - n + 1.

However, not all of these will necessarily be permutations of [1,2,...,n], so I need to maximize how many of them are.

But thinking in terms of the entire arrangement might be too broad. Maybe I need to think about the minimal repeating pattern or something.

Wait, perhaps I should consider the constraints on the frequencies of each number.

Since each window of size n must contain each number exactly once, that imposes certain restrictions on how often each number can appear in the entire sequence.

For example, the first n-length window requires one of each number, as does the second, and so on.

If I have overlapping windows, there's some interdependence between them.

Let me consider the number of times each number must appear to maximize the number of such windows.

Suppose I have m such windows. Then, for each number from 1 to n, it must appear at least m times, because each window needs one of that number.

But in reality, because the windows overlap, the required number of times each number appears is a bit more complex.

Wait, more precisely, for m such windows, the total number of times a particular number must appear is m plus the number of overlaps where that number is needed again.

This seems complicated. Maybe there's a better way to approach this.

Let me look at the problem differently. Suppose I arrange the cards in a way that sliding windows of size n are as likely as possible to be permutations.

One way to ensure that many windows are permutations is to have a repeating pattern that satisfies the condition.

For instance, if I arrange the cards in a sequence where every n cards form a permutation, like [1,2,3,...,n,1,2,3,...,n,...], then every window of size n would be a permutation.

But in practice, I might not have enough cards to do that, especially if some numbers have low initial counts.

Given that I can buy up to k additional cards, I need to maximize the number of such windows.

Wait, maybe I can think in terms of the number of possible windows constrained by the frequencies of each number.

I need to find the maximum number m such that for each number i from 1 to n, the frequency of i in the entire sequence is at least ceil(m / overlap), but I'm not sure.

This seems too vague. Let's try to find a different approach.

Perhaps I can model this as a sliding window and calculate the maximum number of positions where the window is a permutation.

To do that efficiently, especially given the large constraints (n up to 2e5), I need an efficient algorithm.

But given the time constraints for problem-solving, maybe there's a mathematical formula or a greedy approach that can be applied here.

Looking back at the input format, there are multiple test cases, with t up to 100, and n up to 2e5, with the sum of n over all test cases up to 5e5, and individual a_i up to 1e12, and k up to 1e12.

Given the large constraints, especially on a_i and k, it's clear that a brute-force approach is infeasible.

I need a way to compute the answer based on the frequencies.

Let me consider that in order to have m such windows, each number must appear at least floor((m - 1)/n) + 1 times.

Wait, perhaps not. Let's think about it differently.

Suppose I have a sequence of length l = sum(a_i) + k.

The number of possible windows is l - n + 1.

I need to maximize the number of these windows that are permutations of [1,2,...,n].

But again, without a clear formula, this seems tricky.

Wait, perhaps I can think in terms of the limiting factor being the number of times the least frequent number appears.

But no, because I can buy additional cards to increase frequencies.

Wait, more carefully: the bottleneck will be the numbers that appear least frequently, because each window needs one of each.

So, to maximize m, the number of windows, I need to ensure that for each number i, the total number of cards of i is at least ceil(m / n).

Wait, why ceil(m / n)?

Because in m windows, each window requires one of each number, but since the windows overlap, the actual number of times a number is used is m / n on average.

But actually, it's more accurate to say that over m windows, each number should appear at least ceil(m / n) times, because each window needs one of that number, and with overlapping windows, some numbers can be reused.

But with ceiling, it ensures that if m is not a multiple of n, we still have enough.

However, since a_i and k can be up to 1e12, I need an efficient way to compute m.

Maybe I can perform a binary search on m and check for each m whether it's possible to have at least m such windows given the a_i and k.

But with m potentially up to sum(a_i) + k - n + 1, which can be up to 2e5 * 1e12, that's way too big for binary search.

So, that's not feasible.

I need a smarter way.

Let me consider sorting the a_i in ascending order.

Suppose I sort a_i in ascending order: a1 <= a2 <= ... <= an.

Now, to have m windows, each window needs one of each number.

So, the number of times the least frequent number appears will be the limiting factor.

Wait, but I can buy additional cards to increase frequencies.

So, perhaps I need to find m such that a1 + (m + floor(m/n) -1) <= sum(a_i) + k.

Wait, I'm getting confused.

Let me think differently.

Suppose I have m windows.

Each window is a permutation of [1,2,...,n].

So, for each number i from 1 to n, it must appear at least ceil(m / n) times.

Wait, more precisely, in m windows, each number appears exactly m times, but because of overlaps, it's m - (window positions where it doesn't appear).

Actually, I'm still not getting it.

Let me look at small examples to see the pattern.

Take the second test case from the example:

n=2, k=4

a = [8,4]

After buying 4 cards of type 2, total cards: [8,8]

Arrange them as [1,2,1,2,1,2,1,2,1,2,1,2,1,2,1]

Here, there are 15 subarrays of length 2, and 14 of them are [1,2] or [2,1], which are permutations.

Wait, but according to the explanation, it's 15 subarrays that are permutations.

So, in this arrangement, there are 15 windows that are permutations.

But how was this number calculated?

Let me see: total cards after buying: 8+8=16

Number of windows: 16 - 2 + 1 = 15

So, all 15 windows are permutations.

But in this case, a1 = 8, a2 = 8

Wait, but in the explanation, they bought 0 cards of type 1 and 4 cards of type 2, making a2 = 8.

Wait, but in the input, a2 was already 4, and k=4, so a2 becomes 8.

Then, they arranged them in an alternating pattern: [1,2,1,2,...,1,2,1]

But in this arrangement, every window of size 2 is either [1,2] or [2,1], both of which are permutations.

Hence, all 15 windows are permutations.

So, in this case, m=15.

But how does m relate to a_i and k?

In this case, m = (a1 + a2 + k - n)/(n-1) +1 or something?

Wait, perhaps m = floor((sum(a_i) + k - n)/n) +1

In this case, sum(a_i)+k=16, n=2, so floor((16-2)/2)+1 = floor(14/2)+1=7+1=8, which is not matching the example's m=15.

So, that's not it.

Wait, perhaps m = sum(a_i) + k - n +1

But in this case, 16 - 2 +1=15, which matches.

But is that always the case?

Wait, in the first test case:

n=1, k=10, a=[1]

After buying 10 cards of 1, total cards: 11

Number of windows: 11 -1 +1=11

All are permutations of [1], so m=11, which matches sum(a_i)+k -n +1=11-1+1=11

So, perhaps in general, m = sum(a_i) + k -n +1

But wait, in the second test case, m=15, which is sum(a_i)+k -n +1=16-2+1=15

Seems to hold.

Wait, but is this always the maximum possible?

In the third test case:

n=3, k=4, a=[6,1,8]

After buying 4 cards of, say, type 2, making a=[6,5,8]

Total cards: 6+5+8=19

Number of windows:19-3+1=17

But according to the sample output, m=15, which is less than 17.

So, my earlier assumption is incorrect.

Wait, perhaps I need to consider that not all windows can be permutations due to frequency constraints.

In the third test case, even if I buy 4 cards for type 2, making a=[6,5,8], I need to arrange them such that in every window of 3, each number appears exactly once.

But type 2 has frequency 5, which is less than the number of windows m=17, so m cannot be 17.

Actually, m cannot exceed the minimum of floor(a_i / ceil(m / n)) for all i.

This seems recursive and not directly helpful.

I need a better way to model this.

Let me consider that for m windows, each number must appear at least ceil(m / n) times.

But since m is large, I need to find the maximum m such that for all i, a_i + x_i >= ceil(m / n), where x_i is the number of additional cards bought for i, and sum(x_i) <=k.

But this seems too slow to compute directly.

Wait, perhaps I can find m such that sum(ceil(m / n) - a_i) over all i where ceil(m / n) > a_i is <=k.

But ceil(m / n) can be expressed as floor((m + n -1)/n)

So, I need sum(floor((m + n -1)/n) - a_i) over all i where floor((m + n -1)/n) > a_i to be <=k.

But this is still not straightforward to maximize m under this condition.

Maybe I can perform a binary search on m, given that n and k are large but m can be up to sum(a_i)+k -n +1, which is manageable.

But with n up to 2e5 and t up to 100, and sum over all test cases up to 5e5, this might be too slow if I perform a binary search for each test case.

Wait, but perhaps there's a mathematical formula to compute m directly.

Let me think about the minimal frequency required for each number.

To have m windows, each number must appear at least ceil(m / n) times.

So, the minimal frequency required for each number is ceil(m / n).

Therefore, the total number of additional cards needed is sum(ceil(m / n) - a_i) for all i where ceil(m / n) > a_i.

This total should be <=k.

Given that, I need to maximize m such that sum(max(ceil(m / n) - a_i, 0)) <=k.

Given the large constraints, I need an efficient way to compute m.

Let me consider that ceil(m / n) is equal to floor((m + n -1)/n).

So, I can write ceil(m / n) = floor((m + n -1)/n)

But I need to maximize m such that sum(max(floor((m + n -1)/n) - a_i, 0)) <=k.

This is still not easy to handle directly.

Maybe I can iterate over possible values of q = ceil(m / n), and find the minimal m for each q, then find the optimal m.

Wait, perhaps I can find the minimal q such that sum(max(q - a_i, 0)) <=k, and then m = q * n - (number of a_i >= q).

Wait, I'm getting confused.

Let me consider that for a given q, the minimal m such that ceil(m / n) = q is m = q * n - (n - number of a_i >= q)

Wait, this seems complicated.

Maybe I should look for patterns in the sample inputs and outputs.

In the first test case:

n=1, k=10, a=[1]

Buy 10 cards of 1, total 11 cards.

Number of windows:11 -1 +1=11, which matches the output.

In the second test case:

n=2, k=4, a=[8,4]

Buy 4 cards of 2, making a=[8,8]

Arrange as [1,2,1,2,...,1,2,1]

Number of windows:16 -2 +1=15, which matches the output.

In the third test case:

n=3, k=4, a=[6,1,8]

Buy 4 cards of 2, making a=[6,5,8]

Arrange optimally to get m=15, which is less than 6+5+8 -3 +1=19 -3 +1=17

So, something else is happening here.

Wait, perhaps the maximum m is limited by the minimal a_i.

No, because in the second test case, a_i were [8,8], and m=15.

Wait, perhaps m = sum(a_i) + k -n +1, but in the third test case, sum(a_i)+k=6+1+8+4=19, so m=19-3+1=17, but the output is 15.

So, that can't be it.

Wait, perhaps I need to find m such that m <= (sum(a_i) + k -n +1) and m <= (minimal a_i + floor(k / n)) *n - something.

This is getting too convoluted.

Maybe I need to look for a different approach.

Let me consider that in order to have m windows, each of size n, being permutations, I need to arrange the cards in a way that satisfies the condition for m positions.

But arranging the cards optimally is tricky, so perhaps there's a formula based on the frequencies.

Wait, perhaps I can think in terms of the number of times each number appears and ensure that each number appears sufficiently to cover the windows it's needed in.

But I'm stuck.

Maybe I should look at the reference solution or discuss with others.

Wait, perhaps the reference solution is the one provided, and I need to verify its correctness.

Given that, I should analyze the provided code to see if it correctly computes m based on n, k, and a_i.

Looking at the code:

def func():

for ii in range(int(input())):

(n, k) = map(int, input().split())

a = list(map(int, input().split()))

a.sort()

r = a[0]

rem = 0

y = 0

for i in range(0, n - 1):

if (i + 1) * (a[i + 1] - a[i]) > k:

r = a[i] + k // (i + 1)

rem = k % (i + 1)

y = n - 1 - i

k = 0

break

else:

k -= (i + 1) * (a[i + 1] - a[i])

r = a[i + 1]

if k != 0:

r = a[n - 1] + k // n

print((r - 1) * n + 1)

else:

print((r - 1) * n + 1 + rem + y)

So, the code reads t test cases, then for each test case, reads n and k, then reads the array a of size n, sorts it, and then performs some calculations to compute r, rem, and y, and finally prints a formula based on r, rem, and y.

I need to understand what this code is doing and whether it correctly computes the maximum m.

First, it sorts a in ascending order.

Then, it initializes r to a[0], rem to 0, y to 0.

Then, it loops from i=0 to n-2:

if (i + 1) * (a[i + 1] - a[i]) > k:

r = a[i] + k // (i + 1)

rem = k % (i + 1)

y = n - 1 - i

k = 0

break

else:

k -= (i + 1) * (a[i + 1] - a[i])

r = a[i + 1]

Then, if k != 0, it sets r = a[n - 1] + k // n and prints (r - 1) * n + 1

Else, prints (r - 1) * n + 1 + rem + y

I need to decipher what this code is trying to achieve.

It seems to be trying to find some r such that r is related to the minimal frequency required for the numbers to achieve the maximum m.

But I'm not sure about the exact logic.

Perhaps the author is trying to equalize the frequencies of the numbers by distributing the k additional cards in a way that maximizes m.

But without a clear explanation, it's hard to verify.

Let me try to apply this code to the sample inputs and see if it produces the correct outputs.

First test case:

n=1, k=10

a=[1]

sorted a=[1]

Loop from i=0 to -1: nothing happens.

Then, since k !=0, r = a[0] + 10 //1 =1 +10=11

Print (11-1)*1 +1 =10*1 +1=11, which matches the sample output.

Second test case:

n=2, k=4

a=[8,4], sorted a=[4,8]

i=0: (0+1)*(8-4)=4 > k=4? 4 >4? No, so k -=1*4=4, k=0, r=8

Then, since k==0, print (8-1)*2 +1 +0 + (2-1 -0)=7*2 +1 +0 +1=14+1+0+1=16

But the sample output is 15, not 16.

Wait, perhaps I miscounted.

Wait, in the code, if k !=0, it sets r = a[n-1] + k//n, but here k=0, so it prints (r-1)*n +1 + rem +y

Here, r=8, rem=0, y=0 (since no break occurred), n=2

So, (8-1)*2 +1 +0 +0=14+1=15, which matches the sample output.

Ok, so in this case, it works.

Third test case:

n=3, k=4

a=[6,1,8], sorted a=[1,6,8]

i=0: (0+1)*(6-1)=5 >4? 5>4? Yes, so r=1 +4//1=1+4=5, rem=4%1=0, y=3-1-0=2, k=0

Then, since k=0, print (5-1)*3 +1 +0 +2=4*3 +1 +0 +2=12+1+0+2=15, which matches the sample output.

Ok, so far so good.

Another test case:

n=3, k=9

a=[7,6,2], sorted a=[2,6,7]

i=0: (1)*(6-2)=4 >9? 4>9? No, k -=1*4=9-4=5, r=6

i=1: (2)*(7-6)=2 >5? 2>5? No, k -=2*1=5-2=3, r=7

Then, since k=3 !=0, r=7 +3//3=7+1=8

Print (8-1)*3 +1=7*3 +1=21+1=22, which matches the sample output.

Another test case:

n=5, k=3

a=[6,6,7,4,6], sorted a=[4,6,6,6,7]

i=0:1*(6-4)=2 >3? 2>3? No, k -=1*2=3-2=1, r=6

i=1:2*(6-6)=0 >1? 0>1? No, k -=2*0=1-0=1, r=6

i=2:3*(6-6)=0 >1? 0>1? No, k -=3*0=1-0=1, r=6

i=3:4*(7-6)=4 >1? 4>1? Yes, so r=6 +1//4=6+0=6, rem=1%4=1, y=5-1-3=1, k=0

Then, print (6-1)*5 +1 +1 +1=5*5 +1 +1 +1=25+1+1+1=28, which matches the sample output.

Another test case:

n=9, k=7

a=[7,6,1,7,6,2,4,3,3], sorted a=[1,2,3,3,4,6,6,7,7]

i=0:1*(2-1)=1 >7?1>7? No, k -=1*1=7-1=6, r=2

i=1:2*(3-2)=2 >6?2>6? No, k -=2*1=6-2=4, r=3

i=2:3*(3-3)=0 >4?0>4? No, k -=3*0=4-0=4, r=3

i=3:4*(4-3)=4 >4?4>4? No, k -=4*1=4-4=0, r=4

i=4:5*(6-4)=10 >0?10>0? Yes, so r=4 +0//5=4+0=4, rem=0%5=0, y=9-1-4=4, k=0

Then, print (4-1)*9 +1 +0 +4=3*9 +1 +0 +4=27+1+0+4=32, which matches the sample output.

Another test case:

n=10, k=10

a=[1,3,1,2,1,9,3,5,7,5], sorted a=[1,1,1,2,3,3,5,5,7,9]

i=0:1*(1-1)=0 >10?0>10? No, k -=1*0=10-0=10, r=1

i=1:2*(1-1)=0 >10?0>10? No, k -=2*0=10-0=10, r=1

i=2:3*(2-1)=3 >10?3>10? No, k -=3*1=10-3=7, r=2

i=3:4*(3-2)=4 >7?4>7? No, k -=4*1=7-4=3, r=3

i=4:5*(3-3)=0 >3?0>3? No, k -=5*0=3-0=3, r=3

i=5:6*(5-3)=12 >3?12>3? Yes, so r=3 +3//6=3+0=3, rem=3%6=3, y=10-1-5=4, k=0

Then, print (3-1)*10 +1 +3 +4=2*10 +1 +3 +4=20+1+3+4=28, which matches the sample output.

Last test case:

n=9, k=8

a=[5,8,7,5,1,3,2,9,8], sorted a=[1,2,3,5,5,7,8,8,9]

i=0:1*(2-1)=1 >8?1>8? No, k -=1*1=8-1=7, r=2

i=1:2*(3-2)=2 >7?2>7? No, k -=2*1=7-2=5, r=3

i=2:3*(5-3)=6 >5?6>5? Yes, so r=3 +5//3=3+1=4, rem=5%3=2, y=9-1-2=6, k=0

Then, print (4-1)*9 +1 +2 +6=3*9 +1 +2 +6=27+1+2+6=36, which matches the sample output.

So, in all sample test cases, the code produces the correct output.

Given that, it seems the code is correct.

But to be thorough, I should try to understand the logic behind it.

It sorts a in ascending order.

Then, it seems to iterate through the sorted a and adjust r based on how k can be distributed among the differences between consecutive a_i.

It's trying to equalize the frequencies as much as possible with the available k.

Then, r seems to represent some minimal frequency that can be achieved for the numbers.

Finally, it computes m based on r, rem, and y.

Without a clear explanation, it's hard to be completely sure, but given that it passes all sample test cases and seems logically sound, I'll conclude that it's correct.

**Final Answer**

\[ \boxed{\text{See Solution Code}} \]

**Correctness:**

\[ \boxed{\text{True}} \]