Alright, I've got this problem to solve. Let's see what it's asking for. There are n children in a class, and m pairs among them are friends with a friendship value f_i. The teacher goes on k excursions, and for each excursion, she randomly chooses a pair of children equiprobably and independently. If the chosen pair are friends, their friendship value increases by 1 for all subsequent excursions. Pairs who are not friends have a friendship value of 0 that doesn't change.

I need to find the expected value of the sum of friendship values of all k pairs chosen for the excursions, considering that the friendship values increase as friends are chosen in subsequent excursions.

First, I need to understand the setup. There are n children, and m pairs of friends, each with an initial friendship value f_i. The teacher chooses k pairs randomly, and if a chosen pair are friends, their friendship value increases by 1 for all future excursions.

I need to calculate the expected sum of the friendship values at the time each pair is chosen.

Let me think about how to approach this.

Maybe I can model the process step by step, considering that each choice affects future choices if the pair are friends.

But that seems complicated. Perhaps there's a smarter way to compute the expected sum.

Let me consider the contribution of each friend pair to the total sum.

Each friend pair has an initial friendship value f_i, and this can increase by 1 each time the pair is chosen in an excursion.

Wait, but the problem says that the friendship value increases by 1 for all subsequent excursions if the pair is chosen.

So, if a friend pair is chosen in excursion t, their friendship value increases by 1 for all excursions t+1 to k.

But also, their friendship value at the time of being chosen (i.e., in excursion t) is f_i plus any increments from previous choices.

Wait, no. The problem says "their friendship value increases by 1 for all subsequent excursions."

So, at the time of being chosen, their friendship value is still f_i, and it increases by 1 for all future excursions.

But the question is about the sum of friendship values at the time of being chosen, which is before the increase takes effect.

Wait, let's read the problem again carefully: "the friendship value of a pair who are friends is considered 0 if they are not friends, and for friends, it's f_i initially, and increases by 1 for all subsequent excursions when chosen."

So, at the time of being chosen, the friendship value is f_i plus the number of times they have been chosen in previous excursions.

Wait, but the problem says: "if a pair of children who are friends is chosen, their friendship value increases by 1 for all subsequent excursions (the teacher can choose a pair of children more than once). The friendship value of a pair who are not friends is considered 0, and it does not change for subsequent excursions."

So, at the time of being chosen, their friendship value is f_i plus the number of times they have been chosen in previous excursions.

Wait, but the increase happens for subsequent excursions, meaning that at the time of being chosen, it's still f_i plus the number of times they have been chosen before.

This is getting a bit confusing.

Let me try to rephrase it.

Each friend pair has an initial friendship value f_i.

Each time a friend pair is chosen in an excursion, their friendship value increases by 1 for all future excursions.

So, the friendship value at the time of being chosen is f_i plus the number of times they have been chosen in previous excursions.

And for non-friend pairs, their friendship value is always 0.

So, the sum of friendship values at the time of being chosen for all k excursions is what we need to find the expected value of.

This seems like a problem involving expectations and possibly linearity of expectation.

Linearity of expectation is often useful in probability problems where we need to find the expected value of a sum of random variables.

So, perhaps I can define random variables for each excursion and each friend pair, and then compute the expected contribution.

Let me try to formalize this.

Let X_t be the friendship value of the pair chosen in the t-th excursion.

Then, the total sum S = X_1 + X_2 + ... + X_k.

We need to find E[S] = E[X_1] + E[X_2] + ... + E[X_k].

So, we can compute the expected value for each X_t and then sum them up.

Now, for each X_t, it is the friendship value of the pair chosen in the t-th excursion.

The pair is chosen randomly and equiprobably from all possible pairs.

There are C(n,2) possible pairs, where C(n,2) = n(n-1)/2.

Among these, m pairs are friends with friendship values f_i.

The remaining C(n,2) - m pairs are not friends and have friendship value 0.

Now, in the t-th excursion, the pair chosen could be one of the m friend pairs or one of the non-friend pairs.

If it's a non-friend pair, X_t = 0.

If it's a friend pair, X_t is equal to f_i plus the number of times that particular pair has been chosen in previous excursions.

But the number of times a specific pair has been chosen in previous excursions is random and depends on the history of choices.

This seems complicated because the choices are independent, but the friendship values are increasing based on previous choices.

Wait, but the problem says that the choices are independent. Does that mean that the same pair can be chosen multiple times?

Yes, it says "the teacher can choose a pair of children more than once."

So, pairs can be chosen multiple times, and each time a friend pair is chosen, their friendship value increases by 1 for all subsequent excursions.

This means that if a friend pair is chosen multiple times, their friendship value keeps increasing for subsequent excursions.

But for the sum S, we are summing the friendship values at the time of being chosen, not after.

So, for each chosen pair, we add their current friendship value at the time of being chosen.

This seems tricky because the current friendship value depends on how many times they have been chosen before.

I need to find a way to compute the expected value of this sum.

Maybe I can think in terms of the contributions of each friend pair to the total sum.

Let me denote the friend pairs as P1, P2, ..., Pm, each with initial friendship value f1, f2, ..., fm.

For each friend pair Pi, let Ni be the number of times it is chosen in the k excursions.

Then, for each time Pi is chosen, its contribution to the sum S is fi plus the number of times it has been chosen before.

So, if Ni = 0, no contribution.

If Ni = 1, contribution is fi.

If Ni = 2, contribution is fi + 1 (from the first choice) and fi + 1 (from the second choice), so total 2*fi + 2.

Wait, let's think carefully.

Suppose Ni = 2.

First choice: X_t = fi (since it's the first choice, no previous choices).

Second choice: X_t = fi + 1 (since it has been chosen once before).

Total contribution: fi + (fi + 1) = 2fi + 1.

Wait, but according to the problem, "their friendship value increases by 1 for all subsequent excursions."

So, when a friend pair is chosen, their friendship value increases by 1 for all subsequent excursions.

But at the time of being chosen, it's still fi plus the number of times they have been chosen before.

Wait, no. The problem says that when a friend pair is chosen, their friendship value increases by 1 for all subsequent excursions.

So, at the time of being chosen, their friendship value is fi plus the number of times they have been chosen before.

Wait, but the increase happens after being chosen.

Let me think again.

Suppose a friend pair is chosen for the first time.

At the time of being chosen, their friendship value is fi.

Then, for all subsequent excursions, their friendship value increases by 1.

So, in the next excursion, if they are chosen again, their friendship value would be fi + 1.

If they are chosen again, it increases by another 1 for all subsequent excursions.

Wait, but the problem says that when a pair is chosen, their friendship value increases by 1 for all subsequent excursions.

So, the increase happens after the choice.

Therefore, at the time of being chosen, their friendship value is fi plus the number of times they have been chosen before.

Wait, no.

Wait, suppose a pair is chosen for the first time.

At the time of being chosen, their friendship value is fi.

Then, for all subsequent excursions, their friendship value is increased by 1.

So, in the next excursion, their friendship value is fi + 1.

If they are chosen again in the next excursion, their friendship value at the time of being chosen is fi + 1, and then it increases by another 1 for all subsequent excursions.

So, it's fi plus the number of times they have been chosen before.

Wait, "before" as in the number of times they have been chosen in previous excursions.

This seems correct.

So, for a friend pair Pi chosen Ni times, in the t-th choice, their contribution is fi plus (t-1), where t is the number of times they have been chosen so far.

Wait, perhaps it's better to think in terms of the order of choices.

But this seems complicated.

Maybe there's a better way.

Let me consider the total sum S.

S = sum over t=1 to k of X_t, where X_t is the friendship value of the pair chosen in the t-th excursion.

We need to find E[S] = sum over t=1 to k of E[X_t].

Now, for each E[X_t], we can compute it as the expectation over all possible pairs, weighted by their probability of being chosen.

Since pairs are chosen equiprobably, each pair has probability 1/C(n,2).

So, E[X_t] = sum over all pairs of (friendship value at time t) * (1/C(n,2))

For non-friend pairs, the friendship value is always 0.

For friend pairs, the friendship value at time t is fi plus the number of times they have been chosen in previous excursions.

This seems tricky because it depends on the history of choices.

But since the choices are independent, the history affects the current choice.

Wait, but the problem says that the choices are independent, meaning that the same pair can be chosen multiple times, and each choice is made without considering previous choices.

However, the friendship values are affected by previous choices.

So, the friendship value at time t depends on how many times the pair has been chosen in previous excursions.

This dependency makes it complicated.

Perhaps I can model this using indicator variables.

Let me try to think differently.

Let me consider that for each friend pair Pi, the total contribution to S is sum over t=1 to k of (fi + number of times Pi has been chosen before t).

Wait, more precisely, for each time Pi is chosen, its contribution is fi plus the number of times it has been chosen before that time.

This seems similar to summing fi times the number of times it's chosen plus the sum of the number of times it's been chosen before each choice.

This might be approachable using linearity of expectation.

Let me define some random variables.

Let Ni be the number of times friend pair Pi is chosen in the k excursions.

Ni follows a binomial distribution with parameters k and p=1/C(n,2), since each pair is chosen with equal probability.

But Ni is the number of times Pi is chosen.

Now, for each choice of Pi, its contribution to S is fi plus the number of times it has been chosen before that choice.

So, for Ni choices of Pi, the total contribution is sum over j=1 to Ni of (fi + (j-1)).

This is equal to Ni * fi + sum over j=1 to Ni of (j-1) = Ni * fi + sum over j=0 to (Ni-1) of j = Ni * fi + (Ni*(Ni-1))/2.

Therefore, for each friend pair Pi, its total contribution to S is Ni * fi + (Ni*(Ni-1))/2.

So, the total sum S is sum over all friend pairs Pi of Ni * fi + (Ni*(Ni-1))/2.

Now, since the choices are independent, I can compute the expectation of S as sum over all friend pairs Pi of E[Ni * fi] + E[(Ni*(Ni-1))/2].

Since fi is a constant for each friend pair, E[Ni * fi] = fi * E[Ni].

And E[Ni] = k * (1/C(n,2)), since Ni is binomial with parameters k and p=1/C(n,2).

Similarly, E[Ni*(Ni-1)] = Var[Ni] + E[Ni]*(E[Ni]-1) = (k*p*(1-p)) + (k*p)*(k*p - 1).

Wait, more precisely, for a binomial random variable Ni ~ Bin(k, p), E[Ni] = k*p, Var[Ni] = k*p*(1-p), and E[Ni*(Ni-1)] = E[Ni^2] - E[Ni] = Var[Ni] + (E[Ni])^2 - E[Ni] = k*p*(1-p) + (k*p)^2 - k*p = k*p*(1-p + k*p - 1) = k*p*(k*p - p) = k*p*(k-1)*p.

Wait, actually, for a binomial random variable, E[Ni*(Ni-1)] = k*(k-1)*p^2.

Yes, that's correct.

So, E[Ni*(Ni-1)] = k*(k-1)*p^2.

Therefore, E[(Ni*(Ni-1))/2] = (k*(k-1)*p^2)/2.

So, for each friend pair Pi, its expected contribution to S is fi * E[Ni] + E[(Ni*(Ni-1))/2] = fi * (k*p) + (k*(k-1)*p^2)/2.

Now, p = 1/C(n,2), since each pair is chosen with probability 1/C(n,2).

So, p = 2/(n*(n-1)), because C(n,2) = n*(n-1)/2.

Therefore, E[Ni] = k * 2/(n*(n-1)).

And E[(Ni*(Ni-1))/2] = k*(k-1)*(2/(n*(n-1)))^2 / 2 = k*(k-1)*4/(n^2*(n-1)^2)/2 = k*(k-1)*2/(n^2*(n-1)^2).

So, the expected contribution of each friend pair Pi to S is fi * (2*k)/(n*(n-1)) + (2*k*(k-1))/(n^2*(n-1)^2).

Now, the total expected sum S is sum over all friend pairs Pi of [fi * (2*k)/(n*(n-1)) + (2*k*(k-1))/(n^2*(n-1)^2)].

This can be written as sum over all friend pairs Pi of fi * (2*k)/(n*(n-1)) + m * (2*k*(k-1))/(n^2*(n-1)^2).

Let me denote sum over all friend pairs Pi of fi as sum_f.

So, E[S] = sum_f * (2*k)/(n*(n-1)) + m * (2*k*(k-1))/(n^2*(n-1)^2).

Now, n*(n-1)/2 is C(n,2), the number of possible pairs.

So, n*(n-1) = 2*C(n,2).

Therefore, E[S] = sum_f * (2*k)/(2*C(n,2)) + m * (2*k*(k-1))/(4*C(n,2)^2).

Simplifying, E[S] = sum_f * (k)/C(n,2) + m * (k*(k-1))/(2*C(n,2)^2).

This seems like a reasonable expression for the expected sum S.

Now, the problem asks to output this expected value in the form of p/q, reduced to lowest terms, and then p * q^{-1} mod (10^9 + 7).

So, I need to compute E[S] = sum_f * (k)/C(n,2) + m * (k*(k-1))/(2*C(n,2)^2).

Let me denote C(n,2) as cn2 = n*(n-1)/2.

Then, E[S] = sum_f * (k)/cn2 + m * (k*(k-1))/(2*cn2^2).

I need to compute this fraction p/q, reduce it to lowest terms, and then compute p * q^{-1} mod (10^9 + 7).

Let me see how to compute p and q.

First, I need a common denominator for the two terms.

The first term is sum_f * k / cn2.

The second term is m * k * (k-1) / (2 * cn2^2).

So, the common denominator is 2 * cn2^2.

Then, E[S] = [sum_f * k * 2 * cn2 + m * k * (k-1)] / (2 * cn2^2).

Simplify numerator: sum_f * k * 2 * cn2 + m * k * (k-1).

Denominator: 2 * cn2^2.

Now, cn2 = n*(n-1)/2.

So, 2 * cn2^2 = 2 * (n*(n-1)/2)^2 = 2 * n^2 * (n-1)^2 / 4 = n^2 * (n-1)^2 / 2.

Wait, no: 2 * (n*(n-1)/2)^2 = 2 * (n^2*(n-1)^2)/4 = n^2*(n-1)^2 / 2.

Yes.

So, denominator is n^2*(n-1)^2 / 2.

And numerator is sum_f * k * 2 * (n*(n-1)/2) + m * k * (k-1) = sum_f * k * n * (n-1) + m * k * (k-1).

Wait, no: 2 * cn2 = n*(n-1), so sum_f * k * 2 * cn2 = sum_f * k * n * (n-1).

And m * k * (k-1).

So, numerator is sum_f * k * n * (n-1) + m * k * (k-1).

Denominator is n^2 * (n-1)^2 / 2.

Therefore, E[S] = [sum_f * k * n * (n-1) + m * k * (k-1)] / [n^2 * (n-1)^2 / 2].

Simplify this fraction.

Multiply numerator and denominator by 2:

Numerator: 2 * [sum_f * k * n * (n-1) + m * k * (k-1)].

Denominator: n^2 * (n-1)^2.

So, E[S] = [2 * sum_f * k * n * (n-1) + 2 * m * k * (k-1)] / [n^2 * (n-1)^2].

Now, I need to reduce this fraction p/q, where p = 2 * sum_f * k * n * (n-1) + 2 * m * k * (k-1), and q = n^2 * (n-1)^2.

Then, compute p * q^{-1} mod (10^9 + 7).

I need to make sure that p and q are integers, which they are, and that I compute the modular inverse of q modulo (10^9 + 7).

Also, need to ensure that p and q are co-prime, or at least compute the gcd and divide both by it to reduce the fraction.

Wait, but in the code, it seems to compute p and q directly and then take p * q^{-1} mod (10^9 + 7).

But according to the above, p = 2 * sum_f * k * n * (n-1) + 2 * m * k * (k-1), and q = 2 * C(n,2)^2 = 2 * (n*(n-1)/2)^2 = n^2 * (n-1)^2 / 2.

Wait, hold on, earlier I had q = n^2 * (n-1)^2 / 2, but according to the code, q = 2 * C(n,2)^2 = 2 * (n*(n-1)/2)^2 = n^2 * (n-1)^2 / 2, which matches.

So, p = 2 * sum_f * k * C(n,2) + m * k * (k-1).

Wait, C(n,2) = n*(n-1)/2.

So, p = 2 * sum_f * k * (n*(n-1)/2) + m * k * (k-1) = sum_f * k * n * (n-1) + m * k * (k-1).

And q = 2 * C(n,2)^2 = 2 * (n*(n-1)/2)^2 = n^2 * (n-1)^2 / 2.

So, p = sum_f * k * n * (n-1) + m * k * (k-1).

q = n^2 * (n-1)^2 / 2.

Now, in the code, it seems to compute p = 2 * k * C(n,2) * sum_f + m * k * (k-1).

Wait, C(n,2) = n*(n-1)/2, so 2 * k * C(n,2) * sum_f = 2 * k * (n*(n-1)/2) * sum_f = k * n * (n-1) * sum_f.

Which matches the p I have above: sum_f * k * n * (n-1) + m * k * (k-1).

So, the code computes p correctly.

Then, q = 2 * C(n,2)^2 = 2 * (n*(n-1)/2)^2 = n^2 * (n-1)^2 / 2.

Then, it computes gcd of p and q, divides both by gcd, and computes p * q^{-1} mod (10^9 + 7).

This seems correct.

Let me check with the sample input and output.

Sample Input 1:

100 0 24

Here, n=100, m=0, k=24.

sum_f = 0.

p = 0 + 0 * 24 * 23 = 0.

q = 2 * C(100,2)^2 = some positive number.

So, p=0, q=some positive number, so p/q=0, which matches the output 0.

Sample Input 2:

2 1 10

1 2 1

Here, n=2, m=1, k=10.

sum_f =1.

C(2,2)=1.

p=2*k*C(2,2)*sum_f + m*k*(k-1)=2*10*1*1 +1*10*9=20 +90=110.

q=2*C(2,2)^2=2*1^2=2.

So, p/q=110/2=55, which matches the sample output of 55.

Sample Input 3:

3 1 2

2 1 1

Here, n=3, m=1, k=2.

sum_f=1.

C(3,2)=3.

p=2*2*3*1 +1*2*1=12+2=14.

q=2*3^2=18.

gcd(14,18)=2.

So, p=7, q=9.

Then, 7*9^{-1} mod (10^9+7).

9^{-1} mod (10^9+7) is the modular inverse of 9 modulo 10^9+7, which is 111111112, because 9*111111112=999999992, which is 10^9 + 7 -1, but we need to adjust for the modulus.

Wait, actually, 9 * 111111112 = 999999992, which is -5 mod 10^9+7, but that's not correct.

Wait, perhaps better to compute it directly.

But according to the sample output, it's 777777784, which is likely 7 * (9^{-1}) mod 10^9+7.

Given that 9*111111112=999999992, which is -5 mod 10^9+7, which is incorrect.

Wait, perhaps I need to compute 9^{-1} properly.

9 * 111111112 = 999999992, which is -5 mod 10^9+7, but we need it to be 1.

Wait, perhaps I'm making a mistake.

Actually, 9 * 111111112 = 999999992, and 999999992 + 5 = 999999997, which is 10^9 + 7 - 5 = 999999997, still not 1.

Wait, perhaps I need to compute the inverse differently.

But according to the sample output, 7 * 9^{-1} = 777777784 mod 10^9+7.

Indeed, 7 * 111111112 = 777777784, which matches the sample output.

So, the code seems to be computing the correct p and q, reducing them by their gcd, and then computing p * q^{-1} mod 10^9+7.

Therefore, the given program is correct.

**Final Answer**

\[ \boxed{\text{See the provided program}} \]