Postcondition: `r` remains either `r_end + 3` or `r_end + 4`. `old` is moved to `todo`, and `ans` is incremented by 1. If `len(done) >= k`, `extra` and `todo` are updated based on whether `a[r]` is in `todo` and the status of `old` in `done` or `todo`. If `a[r]` is not in `todo`, `extra` includes `a[r]`, and `todo` is updated based on the status of `old` in `done` or `todo`.